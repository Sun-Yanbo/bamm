<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>21. Is the Moore et al (2016) likelihood a mathematically valid improvement? &#8212; bamm 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="20. Glossary" href="glossary.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="glossary.html" title="20. Glossary"
             accesskey="P">previous</a></li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">21. Is the Moore et al (2016) likelihood a mathematically valid improvement?</a><ul>
<li><a class="reference internal" href="#summary">21.1. Summary</a></li>
<li><a class="reference internal" href="#the-mea-likelihood-equation-and-computational-algorithm">21.2. The MEA likelihood equation and computational algorithm</a><ul>
<li><a class="reference internal" href="#fundamental-difference-between-mea-and-bamm-algorithms">21.2.1. Fundamental difference between MEA and BAMM algorithms</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-probability-of-a-single-branch-with-mapped-rate-parameters">21.3. The probability of a single branch with mapped rate parameters</a><ul>
<li><a class="reference internal" href="#expression-as-a-formal-probability">21.3.1. Expression as a formal probability</a></li>
<li><a class="reference internal" href="#demonstration-failure-of-the-mea-likelihood">21.3.2. Demonstration: failure of the MEA likelihood</a></li>
<li><a class="reference internal" href="#these-results-are-not-a-function-of-numerical-instability">21.3.3. These results are not a function of numerical instability</a></li>
<li><a class="reference internal" href="#these-results-are-not-a-function-of-inappropriate-conditioning">21.3.4. These results are not a function of inappropriate conditioning</a></li>
<li><a class="reference internal" href="#where-is-the-incorrect-conditioning-in-the-mea-code">21.3.5. Where is the incorrect conditioning in the MEA code?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#failure-of-incomplete-data-augmentation-recompute-with-bisse">21.4. Failure of incomplete data augmentation (&#8220;recompute&#8221;) with BiSSE</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="glossary.html"
                        title="previous chapter">20. Glossary</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/mea_likelihood.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="is-the-moore-et-al-2016-likelihood-a-mathematically-valid-improvement">
<span id="mea-likelihood"></span><h1>21. Is the Moore et al (2016) likelihood a mathematically valid improvement?<a class="headerlink" href="#is-the-moore-et-al-2016-likelihood-a-mathematically-valid-improvement" title="Permalink to this headline">¶</a></h1>
<p>Moore et al (MEA) contend that the BAMM likelihood is flawed, but do not justify their own likelihood equation (described in S2.2, p. S17 in MEA). We have previously acknowledged that the BAMM likelihood is an approximation to the true process, and have suggested that there is no <em>exact</em> method for computing the likelihood of rate shifts on phylogenetic trees (see this <a class="reference external" href="likelihoodmodel.html">page</a>). <strong>Here we show that the MEA likelihood contains a mathematical error, such that the resulting probabilities violate a basic axiom of probability theory.</strong> Specifically, we express the MEA likelihood as a formal probability and demonstrate that it is not bounded on the interval (0, 1). MEA &#8220;probabilities&#8221; can become arbitrarily large (e.g., <img class="math" src="_images/math/c2cf9f6fff676e480f9f3508cb7a6e7efeae4350.png" alt="P(X) &gt; 1"/>; <img class="math" src="_images/math/a373a12c5bcce1a55cc2e73f39d1cba20886a444.png" alt="P(X) \rightarrow \infty"/>). The BAMM likelihood does not show this property.</p>
<p><strong>If we have erred and the MEA approach can be shown to satisfy the formal definition of a probability, we will acknowledge this fact prominently on this page and leave the page here as evidence of our error, with appropriate explanation</strong>. Our concerns about the MEA likelihood function follow our previous concerns that empirical analyses in the article cannot be <a class="reference external" href="replication.html">replicated as claimed</a>.</p>
<div class="section" id="summary">
<h2>21.1. Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>MEA validated their likelihood on <em>constant rate phylogenies</em>, where their method and BAMM give identical (and correct) results.</li>
<li><strong>However, the MEA likelihood is incorrect if the tree contains rate shifts</strong>. The MEA equations cannot compute a valid likelihood for any phylogenies that contain rate shifts.</li>
<li><strong>&#8220;Probabilities&#8221; computed by MEA equations are unbounded and exceed unity (1.0) and thus fail the basic axiom of probability theory</strong>, as seen in this <a class="reference internal" href="#probplot1"><span class="std std-ref">plot</span></a>.</li>
<li>Using MEA&#8217;s Monte Carlo extinction simulator, we show that this problem results from a mathematical error in the algorithm used by the authors to compute likelihoods on phylogenies.</li>
<li>We demonstrate that BAMM probabilities, computed in the same fashion, are correctly bounded on (0, 1).</li>
<li>At present, it appears that <strong>there is no available method that can compute the exact likelihood of a phylogeny with rate shifts.</strong> BAMM uses an approximation to compute this likelihood and satisfies the basic axioms of probability theory. <strong>The MEA equations do not satisfy these axioms.</strong> As such, we cannot recommend the use of the MEA equations, which fail on even single branches in the presence of rate shifts.</li>
</ul>
<p><strong>Intuitive explanation for failure of MEA likelihood:</strong> To compute the likelihood of a rate-shift model, we must solve a pair of coupled differential equations, denoted by <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> and <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>. <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> describes the probability of the data, and <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> describes the probability of extinction of a single lineage between time <em>t</em> and the present. In their article (p. S17) and associated Dryad <a class="reference external" href="http://datadryad.org/resource/doi:10.5061/dryad.mb0sd">code</a>, MEA use a data augmentation scheme to compute the likelihood of the data (as does BAMM; see p. S7). Unlike BAMM, however, MEA perform the augmentation only for the <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> equation and not for <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>. This invalidates the resulting <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> calculations and allows probabilities to increase <a class="reference internal" href="#probplot1"><span class="std std-ref">arbitrarily</span></a> to <img class="math" src="_images/math/d86a156e85d4797975fed9e864dd306e4076e326.png" alt="\infty"/>. To increase the transparency of our results, we provide a simple theoretical example illustrating how the MEA strategy of incomplete data augmentation would similarly compromise likelihoods for the <a class="reference internal" href="#bisse1"><span class="std std-ref">BiSSE</span></a> model.</p>
</div>
<div class="section" id="the-mea-likelihood-equation-and-computational-algorithm">
<h2>21.2. The MEA likelihood equation and computational algorithm<a class="headerlink" href="#the-mea-likelihood-equation-and-computational-algorithm" title="Permalink to this headline">¶</a></h2>
<p>BAMM and MEA compute the likelihoods of rate shift models under a data augmentation scheme, which is explained in S1.2.3 (p. 7) in MEA. The phrase <em>data augmentation</em> in this case refers to the fact that BAMM and MEA compute the likelihood of a mapped set of rate regimes across a phylogeny (e.g., each likelihood corresponds to an MCMC sample where rate shifts have been &#8220;painted&#8221; on the tree). This strategy makes the likelihood calculations much more tractable that the <em>non-augmented</em> strategy, which would compute branch likelihoods by integrating over all possible <em>unobserved</em> rate regimes. BiSSE (and related state-dependent models) use this latter approach, but the problem is tractable as there are a finite number of rate classes (<img class="math" src="_images/math/d165aafda179b3cdda102439984aae3ed97b0154.png" alt="n = 2"/> for BiSSE), and we know in advance which tips correspond to which rate classes (because of the character state data).</p>
<p>MEA and BAMM compute the likelihood by solving the following ordinary differential equations along each branch of the phylogeny:</p>
<div class="math">
<p><img src="_images/math/ee1d743b07bdf5d0403731728fdcc47ddc980c39.png" alt="\frac{dD_i}{dt} = -(\lambda + \mu)D_i(t) + 2 \lambda D_i(t) E_i(t)"/></p>
</div><div class="math">
<p><img src="_images/math/89462f35fd1ad2dae406749961b3e236c5d2e434.png" alt="\frac{dE_i}{dt} = \mu -(\lambda + \mu)E_i(t) + \lambda E_i(t)^2"/></p>
</div><p>where <img class="math" src="_images/math/1e2b1a642552d92bb19fbffd7a2578b169c039ae.png" alt="D_i"/> is the probability that a lineage in diversification regime <em>i</em> gives rise to the observed data. The term <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> is described in MEA as the probability that a lineage in state <em>i</em> at time <em>t</em> goes extinct before the present. The meaning of this term is somewhat different in BAMM, which we now explain briefly; this topic has already been treated on the BAMM website in great <a class="reference external" href="likelihoodmodel.html#what-exactly-is-the-process-modeled-by-bamm">detail</a> for some time.</p>
<div class="section" id="fundamental-difference-between-mea-and-bamm-algorithms">
<h3>21.2.1. Fundamental difference between MEA and BAMM algorithms<a class="headerlink" href="#fundamental-difference-between-mea-and-bamm-algorithms" title="Permalink to this headline">¶</a></h3>
<p>MEA and BAMM algorithms appear to use the same core equations (see p. S7 - S8 of MEA) to compute the likelihoods, but these are used in different ways. The meaning of the extinction probability, <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/>, differs fundamentally between BAMM and MEA, and not merely because MEA attempt to account for unobserved rate shifts. Specifically:</p>
<ul class="simple">
<li><strong>MEA interpretation of E(t)</strong>: In MEA, <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> is the probability that a lineage in state <em>i</em> goes extinct before the present, along with all of its descendants. The extinction probability <strong>does not depend on any mapped rate shifts</strong> (e.g., <em>data augmentation</em>) that occurs between time <em>t</em> and the present. As implemented, the MEA term attempts to account for unobserved rate shifts between time <em>t</em> and the present. Thus, <strong>MEA fail to apply the same data augmentation to E(t) that they use for D(t)</strong></li>
<li><strong>BAMM interpretation of E(t)</strong>: In BAMM, <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> is the probability that a lineage in state <em>i</em> goes extinct before the present, along with all of its descendants, but is <em>conditional on the data augmentation</em> (e.g., the set of rate shifts that have been placed on the tree). Hence, BAMM&#8217;s calculations are consistent, in that they use data augmentation for <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> and <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>.</li>
</ul>
<p>To put this another way: the BAMM <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> terms must be computed in a similar fashion to the <img class="math" src="_images/math/c2666f06fba781d07a8f741eb541be2e05ad4b85.png" alt="D_i(t)"/> terms, by traversing the tree recursively and <strong>passing previously-computed extinction probabilities down the tree towards the root</strong>. We have referred to this algorithm as <em>pass-down</em> on the likelihood <a class="reference external" href="likelihoodmodel.html">model</a>  page. The MEA equations assume that <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> can be computed while ignoring downstream data augmentation, e.g., the extinction probability depends only on the current parameter values of the process. We have previously referred to the approach used by MEA as the <em>recompute</em> algorithm, because <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> can always be recomputed at any point on the tree knowing only the current state of the process at time <em>t</em>.</p>
<p>This is a difficult topic and has not been treated clearly in the literature. However, as we show below, the MEA approach is incorrect and does not compute valid probabilities when rate shifts are present. <strong>The recompute algorithm is not valid for data augmented-histories</strong>.</p>
</div>
</div>
<div class="section" id="the-probability-of-a-single-branch-with-mapped-rate-parameters">
<h2>21.3. The probability of a single branch with mapped rate parameters<a class="headerlink" href="#the-probability-of-a-single-branch-with-mapped-rate-parameters" title="Permalink to this headline">¶</a></h2>
<p>Here we show that the MEA likelihood is invalid for a single lineage with a single rate shift. It is invalid &#8211; as opposed to <em>biased</em> &#8211; because the method computes probabilities that are not bounded on the interval (0, 1) and thus violates the definition of probability. This is not to say that the corresponding BAMM likelihood is <em>unbiased</em>, but we believe that any method for computing probabilities should satisfy the key axioms of probability theory.</p>
<p>As a test, we will compute the probability of the following lineage with a <em>data-augmented history</em> (e.g., a mapping of rate parameters to the tree).</p>
<div class="figure align-center" id="rateshift1">
<a class="reference internal image-reference" href="_images/rate_shift.png"><img alt="_images/rate_shift.png" src="_images/rate_shift.png" style="width: 600px;" /></a>
</div>
<p>Here, we have a single observed lineage (e.g., a branch of a phylogenetic tree) beginning at time <img class="math" src="_images/math/7d18e301247447e4600046af051b2bfe857faaa0.png" alt="t = 0"/> and ending at time <img class="math" src="_images/math/2fe241edb74dd9a894fb52a3e74474f47a58659f.png" alt="t = T"/>. The process diversifies under an initial <em>red</em> set of parameters (<img class="math" src="_images/math/5fb3b2dc1e3072ba345650dbdbb9e6a364f644f0.png" alt="\theta_0"/>) on time segment <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/>, undergoes a rate shift at time <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/>, and then survives to time T with a new <em>blue</em> set of a parameters (segment <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/>; <img class="math" src="_images/math/5fb3b2dc1e3072ba345650dbdbb9e6a364f644f0.png" alt="\theta_0"/>).</p>
<div class="section" id="expression-as-a-formal-probability">
<h3>21.3.1. Expression as a formal probability<a class="headerlink" href="#expression-as-a-formal-probability" title="Permalink to this headline">¶</a></h3>
<p>The MEA likelihood of this branch history under MEA is simply <img class="math" src="_images/math/ee97715684465afb6c930d7853a7940fb2a892bb.png" alt="p(x_0 | \theta_0) p(x_1 | \theta_1) \eta"/>, where <img class="math" src="_images/math/5635a7c34414599c2452d72430811e816b460335.png" alt="\eta"/> is the rate at which rate shifts occur. This equation is not a formal probability, but simply by conditioning on the occurrence of a rate shift we can convert it to one. We will also condition this probability on survival of the lineage to the present, as is typical (survival must have occurred, or we would not be looking at a lineage history!). The probability of the data is thus:</p>
<div class="math">
<p><img src="_images/math/fc8af0049b8e8ec12019cbd0e6aaeed636c7a374.png" alt="p(x_0 | \theta_0) * p(x_1 | \theta_1) / (1 - E_0(0, T))"/></p>
</div><p>where <img class="math" src="_images/math/8d61814a767d7ee30bf47d79c10e713095a93205.png" alt="E_0(0, T)"/> denotes the probability that a lineage in state 0 at time 0 goes extinct before the present, time T. Critically, the numerical integration for the differential equations describing <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> and <img class="math" src="_images/math/c2666f06fba781d07a8f741eb541be2e05ad4b85.png" alt="D_i(t)"/> in MEA use the recomputed definition of <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/>. The calculation is performed backwards down the lineage history, beginning at time T with initial values <img class="math" src="_images/math/f32fa340dd7118b5062500558b0d4d09bd478195.png" alt="D = 1"/> and <img class="math" src="_images/math/6ed8a96854e4e5f93008ef390920fa181ba92dc8.png" alt="E = 0"/>.</p>
<p>The BAMM calculation is different, because it does not use the recompute algorithm. The BAMM extinction probabilities computed on the interval <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> and at the root account for the rate shift observed at time <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/>, thus ensuring that data augmentation used for the <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> calculation matches that used for <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>. Put another way, the extinction probability at the root under MEA depends only on parameters <img class="math" src="_images/math/5fb3b2dc1e3072ba345650dbdbb9e6a364f644f0.png" alt="\theta_0"/> and the elapsed time <img class="math" src="_images/math/f2d283a2071f9d043c9e0b0f794a8880fa0d3ce9.png" alt="T"/>, but the corresponding probability under BAMM depends on <img class="math" src="_images/math/5fb3b2dc1e3072ba345650dbdbb9e6a364f644f0.png" alt="\theta_0"/>, <img class="math" src="_images/math/fc756aa1b4acb363f24c47d516b3484758374192.png" alt="\theta_1"/>, <img class="math" src="_images/math/f2d283a2071f9d043c9e0b0f794a8880fa0d3ce9.png" alt="T"/>, and <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/>.</p>
</div>
<div class="section" id="demonstration-failure-of-the-mea-likelihood">
<h3>21.3.2. Demonstration: failure of the MEA likelihood<a class="headerlink" href="#demonstration-failure-of-the-mea-likelihood" title="Permalink to this headline">¶</a></h3>
<p>The MEA likelihood is incorrect everywhere in parameter space if the chance of lineage extinction is greater than zero and if the phylogeny (or branch segment) includes data augmentation (e.g., mapped rate shifts). We will illustrate the inability of the MEA equation to compute a valid probability using parameters that we have selected precisely to illustrate this point; Here is a quick-link to a <a class="reference internal" href="#probplot1"><span class="std std-ref">figure showing our main results</span></a>. Our motivation for using <em>bad case</em> parameterizations is that they make clear that the MEA equations give rise to probabilities that can exceed unity. We consider it critical that any method, regardless of bias, be able to compute <strong>probabilities</strong> that are defined on the interval (0, 1).</p>
<p>We attach here a <a class="reference download internal" href="_downloads/MEA_analysis_script.R" download=""><code class="xref download docutils literal"><span class="pre">script</span></code></a> and <a class="reference download internal" href="_downloads/MEA_analysis_functions.R" download=""><code class="xref download docutils literal"><span class="pre">functions</span></code></a> files to enable researchers to compute the probability of a single branch segment, as described above, with segments <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> and <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/>. The code uses MEA&#8217;s Monte Carlo extinction simulator to approximate the chance of extinction <img class="math" src="_images/math/fc8ca54865e2284fb7d9a65e917acc90a7559372.png" alt="E_i(t)"/> as used in their article. To repeat all analyses below, you will need the MEA <a class="reference external" href="http://datadryad.org/resource/doi:10.5061/dryad.mb0sd">Dryad supplement</a> as well, where you can find the relevant code (&#8220;likelihoodFunctions.R&#8221; and &#8220;MonteCarloSimulator.cpp&#8221;) in their directory <code class="docutils literal"><span class="pre">supplementary_data/code/monte_carlo_simulation/</span></code>.  Our function, <code class="docutils literal"><span class="pre">compute_MEA_probability</span></code>, takes the following arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pars0</span></code> : vector of named parameters corresponding to the full process for the first branch segment, <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/>.</li>
<li><code class="docutils literal"><span class="pre">pars1</span></code> : vector of named parameters corresponding to the full process for the second branch segment, <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/>.</li>
<li><code class="docutils literal"><span class="pre">tvec</span></code> : vector of times that describe the branch history, in the format c(<img class="math" src="_images/math/1410bd3aa3d34373bc7de52c132b4fd6f154019a.png" alt="t_0"/>, <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/>, <img class="math" src="_images/math/f2d283a2071f9d043c9e0b0f794a8880fa0d3ce9.png" alt="T"/>).</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">pars0</span></code> and <code class="docutils literal"><span class="pre">pars1</span></code> vectors contain the following named elements:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">lambda</span></code> : the speciation rate for the focal interval</li>
<li><code class="docutils literal"><span class="pre">mu</span></code> : the extinction rate for the focal interval</li>
<li><code class="docutils literal"><span class="pre">shiftrate</span></code> : rate at which rate-shifts to new processes occur, corresponding to parameter <img class="math" src="_images/math/5635a7c34414599c2452d72430811e816b460335.png" alt="\eta"/> in MEA (or <img class="math" src="_images/math/5b99ed91598429157b547a2c3700a6b25c52824a.png" alt="\Lambda"/> in BAMM documentation)</li>
<li><code class="docutils literal"><span class="pre">prior_lambda</span></code> : the <em>rate parameter</em> of an exponential prior distribution on speciation rates for new processes (e.g., rate shifts lead to new rates that are sampled from this distribution)</li>
<li><code class="docutils literal"><span class="pre">prior_mu</span></code> : rate parameter for exponential prior on extinction rates for new processes</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">prior_lambda</span></code> and <code class="docutils literal"><span class="pre">prior_mu</span></code> values should be identical for the two <code class="docutils literal"><span class="pre">pars</span></code> vectors.</p>
<p>To parameterize the calculations, we will assume a very short segment <img class="math" src="_images/math/4ac6775478c08c929659ac36aefecc037d109a5b.png" alt="x_0 = 1"/>, followed by a long segment <img class="math" src="_images/math/9d420ff5f5656d1588cc89700b40f080ee1f06a3.png" alt="x_1 = 49"/>. The initial parameters of the process will provide for high rates of extinction and speciation; the rate shift will lead to a lineage with very low rates of both speciation and extinction. We will set the <code class="docutils literal"><span class="pre">rateshift</span></code> parameter to be small, such that the frequency of rate shifts is low, and we will set the prior distributions for new speciation and extinction processes to have very small means, ensuring that new rate shifts are of small effect. We provide a demonstration of the failure of the MEA likelihood using our implementation (with their Monte Carlo simulator), and using their branch likelihood calculator exactly as distributed with their Dryad submission:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">require</span><span class="p">(</span><span class="n">deSolve</span><span class="p">)</span>
<span class="n">require</span><span class="p">(</span><span class="n">Rcpp</span><span class="p">)</span>
<span class="n">sourceCpp</span><span class="p">(</span><span class="s2">&quot;MonteCarloSimulator.cpp&quot;</span><span class="p">)</span>

<span class="c1"># functions required for the analyses:</span>
<span class="n">source</span><span class="p">(</span><span class="s2">&quot;MEA_analysis_functions.R&quot;</span><span class="p">)</span>

<span class="n">pars1</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0009</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">names</span><span class="p">(</span><span class="n">pars1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftrate&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_mu&quot;</span><span class="p">)</span>

<span class="n">pars0</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">names</span><span class="p">(</span><span class="n">pars0</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftrate&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_mu&quot;</span><span class="p">)</span>

<span class="c1"># initial segment of x0 = 1, rate shift,</span>
<span class="c1">#               then 49 time units to present with pars1</span>
<span class="n">tvec</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">compute_MEA_probability</span><span class="p">(</span><span class="n">pars0</span><span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span>
        <span class="c1"># should give approx 22</span>

<span class="n">compute_BAMM_probability</span><span class="p">(</span><span class="n">pars0</span> <span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span>
        <span class="c1"># should give 0.50</span>
</pre></div>
</div>
<p><strong>The MEA &#8220;probability&#8221; (prob = 22) is much greater than the bounding value (1) for valid probabilities.</strong> These results are not simply a function of our independent implementation of the MEA equations. Here, we repeat this calculation using the functions distributed with MEA&#8217;s Dryad submission:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sourceCpp</span><span class="p">(</span><span class="s2">&quot;MonteCarloSimulator.cpp&quot;</span><span class="p">)</span>
<span class="c1"># this file from MEA Dryad, supplementary_data/code/monte_carlo_simulation/</span>
<span class="c1"># add Moore et al likelihood functions</span>

<span class="n">source</span><span class="p">(</span><span class="s2">&quot;likelihoodFunctions.R&quot;</span><span class="p">)</span>
<span class="c1">#this file from MEA Dryad, supplementary_data/code/monte_carlo_simulation/</span>

<span class="c1"># our file, contains wrapper for MEA functions</span>
<span class="n">source</span><span class="p">(</span><span class="s2">&quot;MEA_analysis_functions.R&quot;</span><span class="p">)</span>

<span class="n">MEA_prob_PNAS_implementation</span><span class="p">(</span><span class="n">pars0</span><span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tshift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># gives approximately 34, e.g., something much greater than 1</span>
</pre></div>
</div>
<p>We get approximately 34 with the MEA implementation, which is obviously greater than the true limit on a probability. Your results may differ slightly from those presented above: these differences are due to stochastic variation in the extinction probabilities simulated using the MEA Monte Carlo simulator. However, increasing the precision of the approximation through increased numbers of simulations does not change the basic results presented above. Differences in numerical precision from the integrators used by us (<code class="docutils literal"><span class="pre">deSolve::ode</span></code>) and MEA explains much of the discrepancy in values between the MEA probability as computed with our implementation (<code class="docutils literal"><span class="pre">compute_MEA_probability</span></code>) and their implementation (<code class="docutils literal"><span class="pre">MEA_prob_PNAS_implementation</span></code>). For this particular example, the overall extinction probability of the process is so high that small differences in the numerical integration (say, <img class="math" src="_images/math/cfe8ba10697deacee3eb0b889b820e00002a782f.png" alt="E(t) = 0.999"/> versus <img class="math" src="_images/math/e1fe4784dcc7d28f621de64e8d10dd505f4fc5a0.png" alt="E(t) = 0.9991"/>) can lead to differences between probabilities computed using the MEA code versus our implementation. However, as we discuss below, the results shown here do not result from numerical instability.</p>
<p>Now, we will slightly reparameterize things to see how BAMM and MEA probabilities perform across a range of speciation and extinction rates. Here, we will simply fix the relative extinction rate <img class="math" src="_images/math/c3027283c6aa49f1960acff18272a134558d8da4.png" alt="\mu / \lambda"/> to 0.999, and explore speciation rates between 0 and 3. The plot below shows the BAMM probabilities for the single branch (blue dots) and the MEA probabilities are shown in red.</p>
<div class="figure align-center" id="probplot1">
<a class="reference internal image-reference" href="_images/probabilityplot1.png"><img alt="_images/probabilityplot1.png" src="_images/probabilityplot1.png" style="width: 400px;" /></a>
</div>
<p>Again, MEA probabilities consistently exceed 1. Indeed, we can cause these values to become arbitrarily large by simply manipulating the initial (root) values of speciation and extinction. Here, we will use the same shift time and <code class="docutils literal"><span class="pre">pars1</span></code> settings (and rate shift process settings) as above, but will manipulate the initial extinction value. We will set <img class="math" src="_images/math/7c518fb95be50b4d2e15b06ade6a1aa1c0ec876c.png" alt="\lambda = 0.1"/> and iterate over a set of <img class="math" src="_images/math/d79e8a2c7ce54906c2b25549da38bdbe02cf40d6.png" alt="\mu"/> values between 0.2 and 2 (this code is all available in the <a class="reference download internal" href="_downloads/MEA_analysis_script.R" download=""><code class="xref download docutils literal"><span class="pre">script</span></code></a> and <a class="reference download internal" href="_downloads/MEA_analysis_functions.R" download=""><code class="xref download docutils literal"><span class="pre">function</span></code></a> files):</p>
<div class="figure align-center" id="probplot2">
<a class="reference internal image-reference" href="_images/probabilityplot2.png"><img alt="_images/probabilityplot2.png" src="_images/probabilityplot2.png" style="width: 550px;" /></a>
</div>
<p>These plots are showing identical data, but the right side shows the probabilities on a log10 scale. The BAMM probabilities approach but do not exceed 1. Note that in the MEA probability calculations, their Monte Carlo simulator was used to estimate the extinction probability <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>, so the pathologies evident in their probability model cannot be explained by failure to account for rate shifts on extinct lineages. The MEA equations lead to excessively large probabilities in these examples because the unconditioned probability of the data (the numerator, <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/>) becomes larger than the probability that the process does not go extinct, denominator (<img class="math" src="_images/math/be3ad64d8bf7ea3bd60ccaa58fb282f425fd2e4f.png" alt="1 - E(t)"/>).</p>
</div>
<div class="section" id="these-results-are-not-a-function-of-numerical-instability">
<h3>21.3.3. These results are not a function of numerical instability<a class="headerlink" href="#these-results-are-not-a-function-of-numerical-instability" title="Permalink to this headline">¶</a></h3>
<p>These results are not simply a reflection of numerical instability; we illustrate the problem with incomplete data augmentation using a more conceptual <a class="reference internal" href="#bisse1"><span class="std std-ref">BiSSE-based</span></a> example below. Moreover, the same results can be repeated with parameterizations leading to <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> values at the root that are far from numerically unstable boundaries, as occurs when <img class="math" src="_images/math/3ec476b55a32d50e9a6d76f0184c5152b936a92a.png" alt="E(t) \rightarrow 1"/>. For example, here is a parameterization that gives modest extinction probabilities at the root (<img class="math" src="_images/math/c338c0bf0112bf6165f490b35e771647abcf963a.png" alt="E(t) \approx 0.715"/>) but nonetheless gives &#8220;probabilities&#8221; for the process that exceed 1:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pars1</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0009</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="c1"># as above</span>
<span class="n">names</span><span class="p">(</span><span class="n">pars1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftrate&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_mu&quot;</span><span class="p">)</span>

<span class="c1"># some reasonable values for x0 segment:</span>
<span class="n">pars0</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">names</span><span class="p">(</span><span class="n">pars0</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftrate&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;prior_mu&quot;</span><span class="p">)</span>
<span class="n">tvec</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the extinction probability under the MEA Monte Carlo simulator:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">&lt;-</span> <span class="n">replicate</span><span class="p">(</span><span class="mi">1</span><span class="n">e5</span><span class="p">,</span> <span class="n">SimulateCPBDP</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">pars0</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
                <span class="n">pars0</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span> <span class="n">pars0</span><span class="p">[</span><span class="s2">&quot;shiftrate&quot;</span><span class="p">],</span> <span class="n">pars0</span><span class="p">[</span><span class="s2">&quot;prior_lambda&quot;</span><span class="p">],</span> <span class="n">pars0</span><span class="p">[</span><span class="s2">&quot;prior_mu&quot;</span><span class="p">]))</span>

<span class="n">mean</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
<span class="c1"># = 0.715, far from potential boundary effects at 0 or 1</span>
</pre></div>
</div>
<p>And finally, the corresponding probabilities of the data, which must be bounded on (0, 1):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">compute_MEA_probability</span><span class="p">(</span><span class="n">pars0</span><span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span> <span class="c1"># = 2.6</span>
<span class="n">compute_BAMM_probability</span><span class="p">(</span><span class="n">pars0</span> <span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span> <span class="c1"># = 0.87</span>
</pre></div>
</div>
<p>The MEA equations still yield invalid probabilities, even under parameters that are far from boundaries that might yield numerically unstable calculations. In fact, it is trivial to show that the same pathologies illustrated here apply to the special model where we disallow rate shifts on extinct branches, if the MEA strategy of incomplete data augmentation is used. Here, for example, we will use <em>an exact analytical solution</em> to the birth-death process to compute probabilities under the MEA data augmentation strategy but under the assumption that no rate shifts occur on unobserved lineages (e.g., there is no use of the MEA Monte Carlo extinction simulator):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">(</span><span class="s2">&quot;MEA_analysis_functions.R&quot;</span><span class="p">)</span>
<span class="c1"># using parameters from the previous example:</span>
<span class="n">compute_MEA_analytical_noExtinctShifts</span><span class="p">(</span><span class="n">pars0</span><span class="p">,</span> <span class="n">pars1</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span>
<span class="c1"># gives 3.1</span>
</pre></div>
</div>
<p>This latter MEA-type probability is strictly analytical and includes no stochastic simulation of extinction probabilities, and no numerical integration to solve the relevant ODEs. Hence, there is no numerical error associated with this value.</p>
</div>
<div class="section" id="these-results-are-not-a-function-of-inappropriate-conditioning">
<h3>21.3.4. These results are not a function of inappropriate conditioning<a class="headerlink" href="#these-results-are-not-a-function-of-inappropriate-conditioning" title="Permalink to this headline">¶</a></h3>
<p>The root (initial) state is assumed to be known under the data augmentation; there is no justification for weighting root states by equilibrium frequencies during the conditioning. In their article, MEA perform the same conditioning that we use in the examples above.</p>
</div>
<div class="section" id="where-is-the-incorrect-conditioning-in-the-mea-code">
<span id="mea-conditioning"></span><h3>21.3.5. Where is the incorrect conditioning in the MEA code?<a class="headerlink" href="#where-is-the-incorrect-conditioning-in-the-mea-code" title="Permalink to this headline">¶</a></h3>
<p>The MEA code distributed with their Dryad data package demonstrates that they have computed E(t) without conditioning on the data augmentation, which explains the results given above using their code; see function <code class="docutils literal"><span class="pre">MEA_prob_PNAS_implementation</span></code> used above. But it&#8217;s easy to see where this theoretical error occurs in their code. The MEA code for the likelihood calculation is complex, but there is one place where it is easy to see that they have not correctly conditioned <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> on the data augmentation. Lines 120 - 122 of the R file <code class="docutils literal"><span class="pre">likelihoodModel.R</span></code> that accompanies their submission clearly illustrates that their root extinction probabilities are computed only with the current values of the process and that they ignore all downstream data augmentation. Lines 119 - 120 are at the end of their likelihood calculator function, <code class="docutils literal"><span class="pre">MonteCarloLikelihood(...)</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Root</span>
<span class="n">node_process</span> <span class="o">&lt;-</span><span class="n">processes</span><span class="p">[</span><span class="n">getProcessForBranchAtTime</span><span class="p">(</span><span class="n">this_node</span><span class="p">,</span><span class="n">this_node</span><span class="p">,</span>
                                  <span class="n">start_time</span><span class="p">,</span><span class="n">processes</span><span class="p">,</span><span class="n">tree</span><span class="p">),]</span>
<span class="n">log_likelihood</span> <span class="o">&lt;-</span>
  <span class="n">log</span><span class="p">(</span><span class="n">new_d</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">getExtinctionProbability</span><span class="p">(</span><span class="n">node_process</span><span class="p">,</span><span class="n">start_time</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Line 120 selects the process at the root of the tree (e.g., the parameters of the root process at time <img class="math" src="_images/math/7d18e301247447e4600046af051b2bfe857faaa0.png" alt="t = 0"/>). The extinction probabilities under each process were already simulated earlier in the code; this occurs on line 50 (<code class="docutils literal"><span class="pre">simulated_times</span></code>, with call to <code class="docutils literal"><span class="pre">simulateCPBDP</span></code>).  This process is passed in to the function <code class="docutils literal"><span class="pre">getExtinctionProbability</span></code>, which returns <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> at the root for the single root process while ignoring the data augmentation.</p>
<p>If this is not transparent, you can hack MEA&#8217;s code for <code class="docutils literal"><span class="pre">MonteCarloLikelihood</span></code> so that it returns not only the likelihood, but also the extinction probability at the root <em>and</em> the <code class="docutils literal"><span class="pre">node_process</span></code> argument. In the <a class="reference download internal" href="_downloads/MonteCarloLikelihood_MOD.R" download=""><code class="xref download docutils literal"><span class="pre">attached</span> <span class="pre">file</span></code></a>, we have created a copy of this function but have it return a list that includes not only the likelihood but also these other attributes at the root of the tree.</p>
<p>With this code, you can follow the instructions from the MEA file <code class="docutils literal"><span class="pre">using_the_likelihood_function.html</span></code>, which is distributed in <code class="docutils literal"><span class="pre">supplementary_data/code/monte_carlo_simulation</span></code> from their Dryad submission. You can compute the likelihood of the cetacean phylogeny with the modified function <a class="reference download internal" href="_downloads/MonteCarloLikelihood_MOD.R" download=""><code class="xref download docutils literal"><span class="pre">MonteCarloLikelihood_MOD()</span></code></a>, which simply returns some additional attributes. Whatever parameters you have provided as the root process (e.g., first line of the dataframe <code class="docutils literal"><span class="pre">these_parameters</span></code> in their html code) are used to compute <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>, and <strong>no other data augmentation contributes to this value</strong>. A worked example can be found in the analysis file <a class="reference download internal" href="_downloads/MEA_conditioning_example.R" download=""><code class="xref download docutils literal"><span class="pre">linked</span> <span class="pre">here</span></code></a>.</p>
<p>The proper conditioning to <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> with data-augmented histories is not straightforward and we have developed several approaches to address this problem. <strong>However, the calculations that underlie the MEA PNAS article do not perform any of these strategies and use E(t) calculations as described on this page.</strong></p>
</div>
</div>
<div class="section" id="failure-of-incomplete-data-augmentation-recompute-with-bisse">
<span id="bisse1"></span><h2>21.4. Failure of incomplete data augmentation (&#8220;recompute&#8221;) with BiSSE<a class="headerlink" href="#failure-of-incomplete-data-augmentation-recompute-with-bisse" title="Permalink to this headline">¶</a></h2>
<p>The pathologies observed here for the <em>recompute</em> algorithm used by MEA are not unique to BAMM-type rate shift models. In fact, any diversification model that uses data augmentation (mapped rate shifts) will fail if the data augmentation is not applied to both the <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> and <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> calculations. Here, we will show that the incomplete strategy of data augmentation leads to invalid probabilities when applied to the BiSSE model. This is a nice analytical test case, because here there is no question about the effects of rate shifts on unobserved lineages: the BiSSE model specifies that there are exactly 2 rate classes, and we have a formal stochastic process for transitioning between them. Moroever, <strong>we do not have to worry about whether the MEA Monte Carlo simulator is correct</strong> because we can compute the exact extinction probability for an unobserved lineage that may or may not undergo a rate shift.</p>
<p>Here, we will show again the single branch segment, the probability of which we will compute under BiSSE with data augmentation:</p>
<div class="figure align-center" id="rateshift2">
<a class="reference internal image-reference" href="_images/rate_shift.png"><img alt="_images/rate_shift.png" src="_images/rate_shift.png" style="width: 400px;" /></a>
</div>
<p>As before, we will assume we have a <img class="math" src="_images/math/3b3ac952ac1e3f993a4f19672155d1ecd1685e69.png" alt="\lambda_0"/>, <img class="math" src="_images/math/ba1d824b5472f0f2c69b48e08792e778866b4d52.png" alt="\mu_0"/> parameterization on the first <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> segment, then a rate shift, and a <img class="math" src="_images/math/a2c5c1af213db8e97bdaaf60c8fceab2faef8271.png" alt="\lambda_1"/>, <img class="math" src="_images/math/32ad05c010093aad9d10a7b8352cbaf0cb3d6f39.png" alt="\mu_1"/> parameterization on the second segment. We will assume the following generic parameter values:</p>
<ul class="simple">
<li><img class="math" src="_images/math/3b3ac952ac1e3f993a4f19672155d1ecd1685e69.png" alt="\lambda_0"/> = high</li>
<li><img class="math" src="_images/math/ba1d824b5472f0f2c69b48e08792e778866b4d52.png" alt="\mu_0"/>  = even higher</li>
<li><img class="math" src="_images/math/a2c5c1af213db8e97bdaaf60c8fceab2faef8271.png" alt="\lambda_1"/>  = 0</li>
<li><img class="math" src="_images/math/32ad05c010093aad9d10a7b8352cbaf0cb3d6f39.png" alt="\mu_1"/>  = 0</li>
<li><img class="math" src="_images/math/eb721ba7096b6a677cd381b48848d65b00f33a1b.png" alt="q_{01}"/>  = low</li>
<li><img class="math" src="_images/math/26289486513075a3f5da014c2b71f2fa7d218ea9.png" alt="q_{10}"/> = 0</li>
</ul>
<p>The probability of the data, under <em>recompute</em>, is as given above and is conditioned on (i) survival of the process to the present, and (ii) the occurrence of a transition event at time <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/>.</p>
<p>The relevant ODE for the probability of the data on segment <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/> is:</p>
<div class="math">
<p><img src="_images/math/760da979b0ff96b2b3d500b320aad7713a36de78.png" alt="\frac{dD_1}{dt} = -(\lambda_1 + \mu_1 + q_{10})D_1(t) + 2 \lambda D_1(t) E_1(t)"/></p>
</div><p>and extinction equations</p>
<div class="math">
<p><img src="_images/math/9a769f23538b1e3df5f616938c373946e573dec1.png" alt="\frac{dE_1}{dt} = \mu_1 -(\lambda_1 + \mu_1 + q_{10})E_1(t) + \lambda E_1(t)^2 + q_{10}E_0(t)

\frac{dE_0}{dt} = \mu_0 -(\lambda_0 + \mu_0 + q_{01})E_0(t) + \lambda E_0(t)^2 + q_{01}E_1(t)"/></p>
</div><p>and the corresponding probability of the data on segment <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> is:</p>
<div class="math">
<p><img src="_images/math/6a967d894941a8e7652c058e0806820d6e2e8d46.png" alt="\frac{dD_0}{dt} = -(\lambda_0 + \mu_0 + q_{01})D_0(t) + 2 \lambda D_0(t) E_0(t)"/></p>
</div><p>These equations account for all events that could have occurred while yielding a single branch with mapped rate parameters. These equations also include the full stochastic process that can give rise to new lineages, and there is thus no need to use any Monte Carlo approximations to the extinction probability. For some added notational clarity below, we will write extinction probabilities computed using the above equations as <img class="math" src="_images/math/ae91e6548c7ca5465f192fb8f9c6562bb8267e1b.png" alt="E_i(t_1, t_2)"/> to denote the probability that a single lineage in state <em>i</em> goes extinct (along with all of its descendants) on the interval <img class="math" src="_images/math/6eb05aaedfa7921f64109ee5970f084e14087ed1.png" alt="t_1"/> to <img class="math" src="_images/math/dab7d563e62a7d7b224f9ea22231be5f9d31e01a.png" alt="t_2"/>. The algorithm to compute the full probability of the segment under the recompute algorithm is:</p>
<ul class="simple">
<li>Compute probability for segment <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/>  using the equation for <img class="math" src="_images/math/1009395ddd7b1ee4fbe902cdb2c89455b9d27de1.png" alt="D_1(t)"/> above and with initial values <img class="math" src="_images/math/af11c837fe57d2c13d6e8ccee82ec124be14c994.png" alt="D(0) = 1"/> and <img class="math" src="_images/math/c996a4cb98303bd1abdf003a43b3c31cb4fb79ca.png" alt="E(0) = 1"/>.</li>
<li>Compute the probability for segment <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> using the equations for <img class="math" src="_images/math/a086c9a350d7da263c63687ac6e2e6474f4934d7.png" alt="D_0(t)"/>, initializing D with the previously-computed probability of segment <img class="math" src="_images/math/fdf6501bec5987984965f15d09235c645fe06ccb.png" alt="x_1"/>, and with the initial extinction probability equal to <img class="math" src="_images/math/94994039fa4d588fc4c49e1437dd38cf60638fe4.png" alt="E_0(t_s, T)"/>.  That is, the initial extinction probability is the probability that a single lineage alive at the time of the shift <img class="math" src="_images/math/2f8665a2cb06d035e069b6472a88989d912e41da.png" alt="t_s"/> and in state 0 goes extinct before the present, along with all of its descendants.</li>
<li>Compute the extinction probability of the full process, for conditioning. This is the probability that a lineage at the start of the process (t = 0), in state 0, goes extinct before the present, or <img class="math" src="_images/math/8d61814a767d7ee30bf47d79c10e713095a93205.png" alt="E_0(0, T)"/>.</li>
</ul>
<p>Given the parameterizations we have here, we can note the following:</p>
<ul class="simple">
<li>The probability of segment <img class="math" src="_images/math/061a6b0ca63e59a7f0612d737b37dadfc83ced56.png" alt="x_1 = 1"/>, because there are no events that can occur that can change the initial probability of the data (1).</li>
<li>The probability of segment <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> can take any value, but - as the time interval <img class="math" src="_images/math/307e583980f527b3f26e1e159435e0a8d262736b.png" alt="x_0"/> shrinks to a very short duration - the probability approaches the limiting value (1). Given that you start with probability 1, you can make time so short that the probability of events occurring is sufficiently small that this probability can become approximately equal to 1.</li>
<li>The probability of extinction at the root, <img class="math" src="_images/math/8d61814a767d7ee30bf47d79c10e713095a93205.png" alt="E_0(0, T)"/>, can easily approach 1 as well. This will occur because transitions to state 1 (<img class="math" src="_images/math/eb721ba7096b6a677cd381b48848d65b00f33a1b.png" alt="q_{01}"/>) are rare, and the initial parameters for state 0 make extinction highly probable over the full (0, T) duration of the process (e.g., high <img class="math" src="_images/math/3b3ac952ac1e3f993a4f19672155d1ecd1685e69.png" alt="\lambda_0"/> and even higher <img class="math" src="_images/math/ba1d824b5472f0f2c69b48e08792e778866b4d52.png" alt="\mu_0"/>).</li>
</ul>
<p>The conditioned probability is obtained by dividing the probability of the data (the lineage history) by the probability that the process survives to the present, or <img class="math" src="_images/math/6a2a0fd35e2f8fc7db6c1815b4540d9f2cabe943.png" alt="1 - E_0(0, T)"/>. This term can approach 0 within the limits of machine precision, depending on parameter values. Hence we have, for the full &#8220;probability&#8221;:</p>
<p><strong>(something approaching 1)</strong> divided by <strong>(something approaching 0)</strong></p>
<p>= <strong>something arbitrarily larger than 1</strong>.</p>
<p>Using these equations, the probability of the data can easily exceed 1. These results reflect the same underlying pathology in the MEA likelihood equations, because in both cases, the likelihood fails to perform a complete data augmentation to <img class="math" src="_images/math/4eeea266a48e4521c7e44ac6c7aafb4ac0369358.png" alt="D(t)"/> and <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/>. These problems do not occur with the approximation used in BAMM, because the calculation accounts (albeit imperfectly) for modifications to <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> that are attributable to downstream rate shifts, through the &#8220;pass-up&#8221; and &#8220;multiply&#8221; approaches to the calculations described on the BAMM <a class="reference external" href="likelihood.html">likelihood page</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="glossary.html" title="20. Glossary"
             >previous</a></li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>