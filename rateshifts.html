<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. Rate Shifts on Phylogenies: Theoretical Background &mdash; bamm 2.3.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="bamm 2.3.0 documentation" href="documentation.html" />
    <link rel="next" title="4. fossil BAMM" href="fossilbamm.html" />
    <link rel="prev" title="2. BAMM graph gallery" href="bammgraph.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="fossilbamm.html" title="4. fossil BAMM"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="bammgraph.html" title="2. BAMM graph gallery"
             accesskey="P">previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. Rate Shifts on Phylogenies: Theoretical Background</a><ul>
<li><a class="reference internal" href="#the-bamm-model-is-an-approximation">3.1. The BAMM model is an approximation</a></li>
<li><a class="reference internal" href="#multiple-distinct-rate-shift-configurations-can-explain-your-data">3.2. Multiple distinct rate shift configurations can explain your data</a><ul>
<li><a class="reference internal" href="#is-this-really-an-issue-with-real-datasets">3.2.1. Is this really an issue with real datasets?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rate-shifts-are-not-independent">3.3. Rate shifts are not independent</a></li>
<li><a class="reference internal" href="#analysis-of-rate-shifts-in-the-bamm-framework">3.4. Analysis of rate shifts in the BAMM framework</a><ul>
<li><a class="reference internal" href="#shift-configurations-sampled-with-bamm">3.4.1. Shift configurations sampled with BAMM</a></li>
<li><a class="reference internal" href="#marginal-shift-probabilities">3.4.2. Marginal shift probabilities</a></li>
<li><a class="reference internal" href="#the-prior-probability-of-a-rate-shift">3.4.3. The prior probability of a rate shift</a></li>
<li><a class="reference internal" href="#bayes-factors-as-evidence-for-rate-shifts">3.4.4. Bayes factors as evidence for rate shifts</a></li>
<li><a class="reference internal" href="#coreshifts">3.4.5. Identifying the distinct shift configurations</a></li>
<li><a class="reference internal" href="#overall-best-shift-configuration">3.4.6. Overall <em>best</em> shift configuration</a></li>
<li><a class="reference internal" href="#how-not-to-interpret-node-specific-shift-evidence">3.4.7. How <em>not</em> to interpret node-specific shift evidence</a></li>
<li><a class="reference internal" href="#macroevolutionary-cohort-analysis">3.4.8. Macroevolutionary cohort analysis</a></li>
<li><a class="reference internal" href="#maximum-shift-credibility-configuration">3.4.9. Maximum shift credibility configuration</a></li>
<li><a class="reference internal" href="#cumulative-shift-probabilities">3.4.10. Cumulative shift probabilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">3.5. Appendix</a><ul>
<li><a class="reference internal" href="#computing-prior-probabilities-of-rate-shifts-on-branches">3.5.1. Computing prior probabilities of rate shifts on branches</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="bammgraph.html"
                        title="previous chapter">2. BAMM graph gallery</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="fossilbamm.html"
                        title="next chapter">4. fossil BAMM</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/rateshifts.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rate-shifts-on-phylogenies-theoretical-background">
<span id="rateshifts"></span><h1>3. Rate Shifts on Phylogenies: Theoretical Background<a class="headerlink" href="#rate-shifts-on-phylogenies-theoretical-background" title="Permalink to this headline">¶</a></h1>
<p>This section details some of the most common conceptual issues that can arise when interpreting rate shifts on phylogenetic trees. Many studies have attempted to identify <strong>*the*</strong> rate shifts within a given dataset. In the BAMM framework, there is no single set of independent rate shifts waiting to be identified. Rather, BAMM identifies <em>configurations</em> of rate shifts - sets of shifts that are sampled together - and enables us to compute relative probability of those configurations. Three <em>shift configurations</em> sampled with BAMM during simulation of the posterior are shown <a class="reference internal" href="bammgraph.html#bammgraphgallery2"><span>here</span></a>.</p>
<p>Many features and analyses with BAMM and BAMMtools <strong>will not be clear</strong> unless you have a good understanding of the concepts below. It is especially important to grasp the idea of <em>distinct shift configurations</em> and <em>marginal shift probabilities</em>.</p>
<div class="section" id="the-bamm-model-is-an-approximation">
<h2>3.1. The BAMM model is an approximation<a class="headerlink" href="#the-bamm-model-is-an-approximation" title="Permalink to this headline">¶</a></h2>
<p>The models of diversification and trait evolution implemented in BAMM are approximations. This is true for any statistical model that you can use to extract information from data. Let&#8217;s consider a few assumptions of the models implemented in BAMM. The model assumes that a relatively small number of discrete shift events can explain the data (sort of.... it is more that the marginal likelihood of any particular model is implicitly penalized by the addition of more parameters).It is possible that many shifts in evolutionary dynamics change in a discrete fashion (e.g., the classic &#8220;key innovation&#8221; scenario), but it is also possible that major changes in dynamics occur through a number of sequential changes in some general region of a tree (see figure below).</p>
<div class="figure align-center" id="shifts1">
<a class="reference internal image-reference" href="_images/x_interpret1.png"><img alt="_images/x_interpret1.png" src="_images/x_interpret1.png" style="width: 700px;" /></a>
</div>
<p>This is the cetacean phylogeny (try <code class="docutils literal"><span class="pre">data(whales)</span></code> to load this tree) included as an example dataset with BAMMtools, and you can see some examples of rate variation across this tree <a class="reference internal" href="bammgraph.html#bammgraphgallery1"><span>here</span></a>. The tree on the left depicts the maximum shift credibility configuration identified by BAMM. This is simply the shift configuration sampled during simulation of the posterior with the highest marginal probability, analogous to the &#8220;maximum clade credibility tree&#8221; sampled during a Bayesian phylogenetic analysis (see below). The tree on the right gives an alternative interpretation of the results that would be invisible in the BAMM framework. Here, a relatively minor set of evolutionary shifts combine to produce - over several branches (red) - a major shift in evolutionary dynamics.</p>
<p>The point is that BAMM - and every other model that assumes discrete shifts in dynamics - can only detect discrete shifts in dynamics. Strictly speaking, this is less of a limitation for BAMM than other approaches. Because BAMM explicitly allows rates to vary through time after the point occurrence of a shift, the model does a reasonable job of tracking some types of continuous variation in evolutionary rates. In general, though, a spike in evolutionary rates inferred along a particular branch is fully consistent with the possibility that the &#8220;true&#8221; process involved a relatively continuous acceleration in rates that occurred over several branches. More generally, it is unlikely that such a continuous acceleration scenario over a relatively short period of time (e.g., tree on right) can even be detected from the sort of data we typically have available to us.</p>
<p>This is not a weakness <em>per se</em> of BAMM, and it applies to all other &#8220;macroevolutionary&#8221; scale modeling frameworks of which we are aware. However, recognizing the limitations of the discrete shift framework has a number of practical implications for interpreting patterns in data.</p>
</div>
<div class="section" id="multiple-distinct-rate-shift-configurations-can-explain-your-data">
<h2>3.2. Multiple distinct rate shift configurations can explain your data<a class="headerlink" href="#multiple-distinct-rate-shift-configurations-can-explain-your-data" title="Permalink to this headline">¶</a></h2>
<p>With most phylogenetic datasets, it is unlikely that you will be able to identify the specific branches on which rate shifts have occurred with extremely high confidence. More typically, you will be unable to exclude several different shift configurations that potentially account for a given pattern of phylogenetic branching or phenotypic diversity.</p>
<p>Currently, stepwise AIC and other model selection approaches are used to identify a single best set of rate shifts. We will single out some work that we have previously been involved with as an example of this type of approach. In Rabosky et al. (Proc. R. Soc. B, 274:2915-2923, 2007) and Alfaro et al. (PNAS 106:13410-13414, 2009), an information-theoretic model selection procedure is used to fit a set of models to phylogenetic data. Model complexity starts at 0, with the assumption that a single set of evolutionary rate parameters apply across an entire phylogeny. The algorithm then considers a more complex model, with two distinct evolutionary rate partitions across the tree. The actual likelihoods and AIC scores reported in these papers (and most subsequent papers that have cited them) tell us only about the relative fit of a model with <em>X</em> rate shifts relative to a model with <em>Y</em> rate shifts. There is typically no information in these analyses that provides the relative probability of different rate shift <a class="reference internal" href="bammgraph.html#bammgraphgallery2"><span>configurations</span></a>. All we get is the maximum likelihood <em>point estimate</em> of the best-fit shift configuration, but we get no information regarding our confidence in that estimate relative to other shift configurations with an identical number of rate shifts.</p>
<p>Here&#8217;s a graphical illustration of the logical problems associated with this. Suppose you analyze a particular phylogeny and find that a model with 2 distinct rate regimes fits the data better than a single rate regime with probability 1.0. You report the location of your rate shift identified using the stepwise procedure as follows:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/xFig2a.png"><img alt="_images/xFig2a.png" src="_images/xFig2a.png" style="width: 600px;" /></a>
</div>
<p>You go on to discuss this as strong evidence for a rate increase along the branch leading to clade A. You propose several potential key innovations that may have occurred along the branch leading to clade A that can potentially account for this discrepancy in species richness between clades A and B.</p>
<p>The problem here is that you have confounded statistical evidence for the <strong>number of rate shifts</strong> with statistical evidence for the <strong>location of the rate shifts</strong>. These are not the same. In fact, you have merely reported a single <em>point estimate</em> for a rate shift location that is consistent with your data. The true evidence for your rate shift locations might look more like this:</p>
<div class="figure align-center" id="toyshifts">
<a class="reference internal image-reference" href="_images/xFig2b.png"><img alt="_images/xFig2b.png" src="_images/xFig2b.png" style="width: 600px;" /></a>
</div>
<p>Here, you can see that - despite overall strong evidence for the occurrence of a rate shift <em>somewhere</em> in your tree - you can&#8217;t distinguish between several <strong>very different</strong> scenarios that have roughly equal probability. You can arrive at the observed disparity in diversity between clades A and B by (1) having a rate increase on the branch leading to clade A, or (2) a rate decrease on the branch leading to clade B. Unfortunately, there is nothing in your stepwise model-selection framework that provides this information. And these two scenarios lead to very different biological interpretations.</p>
<p>Simply speaking, reporting only the <em>maximum likelihood</em> shift location on a phylogenetic tree is exactly the same as publishing a single &#8220;best&#8221; estimate of a phylogeny with no measures of clade support. This would never be acceptable in the phylogenetic literature: at a minimum, we require bootstrap evidence, posterior probabilities, decay indices, or some other measure of the robustness of a particular inferred topology. However, in studying macroevolutionary dynamics, we frequently do <em>exactly what we would never do in phylogenetic biology</em>: we present point estimates with no probabilistic support measures, and we have mistaken support for a particular <strong>number of shifts</strong> for support bearing on their location.</p>
<p>Addressing this issue is one of the primary reasons that we created BAMM.</p>
<div class="section" id="is-this-really-an-issue-with-real-datasets">
<h3>3.2.1. Is this really an issue with real datasets?<a class="headerlink" href="#is-this-really-an-issue-with-real-datasets" title="Permalink to this headline">¶</a></h3>
<p><strong>Yes</strong>.</p>
<p>We have encountered very few datasets where signal of a shift in rate dynamics along a particular branch is so strong that we can exclude alternative shift configurations with probability &gt; 0.95.</p>
<p>Consider the analysis of whale diversification, which we&#8217;ve included as an example dataset in BAMMtools. We also use this dataset as an empirical example in the primary description of the BAMM model. The figure below shows reconstructed speciation rates through time during the whale radiation (red = fast, blue = slow) under BAMM. Overall, the model with the highest posterior probability had two rate dynamics, and a model with just a single rate dynamic had a posterior probability approaching zero. The marginal (branch-specific) probabilities of a rate shift occurring on the 3 most likely branches are as follows:</p>
<div class="figure align-center" id="whalemarg1">
<a class="reference internal image-reference" href="_images/xfig3a.png"><img alt="_images/xfig3a.png" src="_images/xfig3a.png" style="width: 650px;" /></a>
</div>
<p>Overall, we have very strong evidence for a shift in diversification dynamics somewhere near the origin of the dolphin clade, and the probability that at least one of the shifts illustrated above occurs is greater than 0.99. Although we are confident that a shift in dynamics <strong>has</strong> occurred, we cannot pin down a precise location of the shift. It would be incorrect to assert that the shift occurred on the branch with the highest marginal probability; it is almost as likely (p = 0.43) that the shift occurred on one of the ancestral branches immediately preceding the origin of the dolphin clade.</p>
</div>
</div>
<div class="section" id="rate-shifts-are-not-independent">
<h2>3.3. Rate shifts are not independent<a class="headerlink" href="#rate-shifts-are-not-independent" title="Permalink to this headline">¶</a></h2>
<p>Marginal shift probabilities - the probability that a shift occurred on a given branch, ignoring everything else in the tree - are useful, but they are <strong>not independent</strong> of shifts occurring elsewhere on the tree. The marginal shift probabilities in the figure <a class="reference internal" href="#whalemarg1"><span>above</span></a> cannot be treated as independent. In fact, the joint probability of a shift occurring on any two of the 3 principal branches (e.g., those with probs 0.05, 0.38, and 0.56) is approximately zero for all combinations. In other words, if you have a shift on one of these 3 branches for a given sample from the posterior, the conditional probability of a shift on any of the other branches leading to the dolphin clade is approximately zero.</p>
<p>Put simply: there is very strong (prob &gt; 0.99) evidence for a shift in dynamics somewhere along the ancestral 3 branches leading to the core dolphin clade. But there is only evidence for one such shift. Almost every sample from the posterior has a shift on at least one of these 3 branches, but no sample has a shift on more than one of these branches.</p>
<p>Because of the non-independence of rate shift configurations, it doesn&#8217;t really make sense to show - in a single tree - all the rate shifts discovered by BAMM. A good (but imperfect) analogy for thinking about rate shift configurations and their potential non-independence comes from Bayesian phylogenetic analysis. Any given shift configuration is like a phylogenetic tree sampled from a posterior. Some trees in that posterior will be incompatible with others. Trying to show all the rate shifts at once on a single tree, or reporting them as though they are independent, is sort of like trying to show a phylogenetic tree where you show all recovered clades at the same time. Suppose in a Bayesian phylogenetic analysis of 3 clades (A, B, C) you recover, each with probability 0.5, the following topologies: (A,(B,C)) and ((A,B),C). These topologies are incompatible, and it doesn&#8217;t make sense to demand a single phylogenetic tree that represents all sampled clades within a single tree. The solution in phylogenetics is to collapse these incompatible topologies to a consensus tree with a polytomy. Showing all rate shifts recovered with BAMM on a single phylogenetic tree is a bit like showing a consensus phylogeny with polytomies: it isn&#8217;t the &#8220;true&#8221; tree, but it summarizes some of the total run information.</p>
</div>
<div class="section" id="analysis-of-rate-shifts-in-the-bamm-framework">
<h2>3.4. Analysis of rate shifts in the BAMM framework<a class="headerlink" href="#analysis-of-rate-shifts-in-the-bamm-framework" title="Permalink to this headline">¶</a></h2>
<p>There are many types of information that can be extracted from a BAMM run. Here we describe several useful methods of summarizing and visualizing shift information from a BAMM analysis.</p>
<div class="section" id="shift-configurations-sampled-with-bamm">
<h3>3.4.1. Shift configurations sampled with BAMM<a class="headerlink" href="#shift-configurations-sampled-with-bamm" title="Permalink to this headline">¶</a></h3>
<p>One of the most important ideas to grasp regarding BAMM is that BAMM simulates a posterior distribution of <em>shift configurations</em> on phylogenetic trees. Hence, every sample from a posterior simulated with BAMM may contain a potentially unique configuration of rate shifts. Here are 3 different shift configurations for the primates dataset included in BAMMtools. The fourth tree is a phylorate plot, showing instantaneous (marginal) phenotypic evolutionary rates at a fine-grained set of points along the phylogeny. Note that the shift configurations are different for each sample from the posterior.</p>
<div class="figure align-center" id="primateconfigs">
<a class="reference internal image-reference" href="_images/xprimates_shiftconfigs.png"><img alt="_images/xprimates_shiftconfigs.png" src="_images/xprimates_shiftconfigs.png" style="width: 650px;" /></a>
</div>
</div>
<div class="section" id="marginal-shift-probabilities">
<h3>3.4.2. Marginal shift probabilities<a class="headerlink" href="#marginal-shift-probabilities" title="Permalink to this headline">¶</a></h3>
<p>The marginal shift probabilities on individual branches across the tree are of considerable interest. As discussed above, there are some nuances to interpreting these, because the probability associated with a shift on any particular branch is not independent of other branches in the tree. The following snippet of R code will compute the marginal shift probabilities for each branch in one of the example datasets included with BAMMtools. It is not necessary to understand (or even run) this code yet; we will cover BAMMtools in much greater depth in subsequent sections.</p>
<p>If you don&#8217;t have BAMMtools installed and/or don&#8217;t know how to install it, you may wish to read the first few paragraphs of <a class="reference internal" href="postprocess.html#bammtools"><span>this section</span></a>. First, we load BAMMtools:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">library</span><span class="p">(</span><span class="n">BAMMtools</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we load two datasets included with BAMMtools: a time-calibrated phylogenetic tree of living whales (<code class="docutils literal"><span class="pre">whales</span></code>), and an output file from our BAMM analysis (<code class="docutils literal"><span class="pre">events.whales</span></code>). We will load these using the <code class="docutils literal"><span class="pre">data</span></code> function in R:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we convert the phylogeny and BAMM output file into a particular data object that is at the heart of BAMMtools analyses:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ed</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Object <code class="docutils literal"><span class="pre">ed</span></code> is now a <code class="docutils literal"><span class="pre">bammdata</span></code> object. Finally, we can compute the marginal shift probabilities for this phylogeny:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">marg_probs</span> <span class="o">&lt;-</span> <span class="n">marginalShiftProbsTree</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>
</pre></div>
</div>
<p>The object <code class="docutils literal"><span class="pre">marg_probs</span></code> is a copy of the original phylogenetic tree, but where the branch lengths have been replaced by the branch-specific marginal shift probabilities. In other words, the length of a given branch is equal to the percentage of samples from the posterior that contain a rate shift on that particular branch.</p>
<p>You can convey this information in several possible ways. You can directly indicate marginal shift probabilities on a phylorate plot, as shown <a class="reference internal" href="#whalemarg1"><span>here</span></a>. You can plot your <code class="docutils literal"><span class="pre">marg_probs</span></code> tree itself: the branches are scaled directly by probabilities, so a tree plotted in such a fashion conveys quite a bit of information (see Figure 9 from <a class="reference external" href="http://www.plosone.org/article/info%3Adoi%2F10.1371%2Fjournal.pone.0089543">Rabosky 2014</a> for an example of such a plot). You could create such a plot by simply executing:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plot</span><span class="o">.</span><span class="n">phylo</span><span class="p">(</span><span class="n">marg_probs</span><span class="p">)</span>
</pre></div>
</div>
<p>in R. You can potentially color branches by their marginal shift probabilities, or you could add circles to each branch with a shift probability greater than some threshold.</p>
<p>But don&#8217;t get hung up on the fact that your shift probabilities are less than 0.95. Even <em>very</em> strongly supported rate heterogeneity will generally be associated with marginal shift probabilities &lt; 0.95. As discussed <a class="reference internal" href="#whalemarg1"><span>here</span></a>, you can (and often will) have exceptionally strong evidence for rate heterogeneity even if any given branch has marginal shift probabilities that do not appear particularly high. <strong>Marginal shift probabilities tell you very little about the probability of rate heterogeneity in your dataset</strong>. In principle, you could have high confidence that your data were shaped by a very large number of rate shifts, but at the same time find that no single branch has a marginal probability exceeding 0.10.</p>
</div>
<div class="section" id="the-prior-probability-of-a-rate-shift">
<h3>3.4.3. The prior probability of a rate shift<a class="headerlink" href="#the-prior-probability-of-a-rate-shift" title="Permalink to this headline">¶</a></h3>
<p>The BAMM model assumes that the number of rate shifts on a phylogeny is an outcome of a stochastic process. There is a prior probability associated with each outcome of this process, and the parameter <code class="docutils literal"><span class="pre">poissonRatePrior</span></code> that you specify in your BAMM analyses determines what these probabilities are. It is important to understand this, because you can manipulate this prior distribution to obtain large numbers of rate shifts on your tree, even where there is very little evidence for them in the data. By default, BAMM will simulate the prior probability distribution on the number of rate shifts for your data using whatever value of <code class="docutils literal"><span class="pre">poissonRatePrior</span></code> you give it. For the whales example analysis included in BAMMtools, the prior distribution was generated with <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">1.0</span></code>. This defines a distribution that looks like this:</p>
<div class="figure align-center" id="prior1">
<a class="reference internal image-reference" href="_images/rateshifts_prior.png"><img alt="_images/rateshifts_prior.png" src="_images/rateshifts_prior.png" style="width: 380px;" /></a>
</div>
<p>Now, suppose we set <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">0.1</span></code>. This flattens our prior distribution, such that our expected number of rate shifts under the prior alone looks like this:</p>
<div class="figure align-center" id="prior0-1">
<a class="reference internal image-reference" href="_images/rateshifts_prior_0.1.png"><img alt="_images/rateshifts_prior_0.1.png" src="_images/rateshifts_prior_0.1.png" style="width: 380px;" /></a>
</div>
<p>Practically speaking, if you are to set <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">0.1</span></code>, this means that <em>even without diversification rate variation in your tree</em>, you would potentially observe significant evidence for diversification rate heterogeneity if you considered posterior probabilities alone. In fact, under the prior alone (<code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">0.1</span></code>), the prior probability of 0 rate shifts is approximately 0.024. This is one reason why we emphasize the utility of <a class="reference internal" href="postprocess.html#bayesfactors"><span>Bayes factors</span></a> for model selection in BAMM.</p>
<p>There are very good reasons to <strong>not</strong> use a super-conservative prior in a BAMM analysis. The more restrictive the prior, the more difficult it will be for BAMM to achieve convergence. If you really do have evidence for 20 rate shifts in your data (typical for trees with several thousand or more tips), then using a value of <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">10</span></code> will make it very hard to find this region of parameter space. Basically, for BAMM to find rate shifts, the algorithm must be able to propose and accept new shifts. If the prior is too restrictive, you will reject most moves that increase model complexity.</p>
<p>What this means, however, is that every branch in your tree will have a non-zero expected number of rate shifts <em>no matter what prior you choose</em>. How many rate shifts would you expect on any particular branch? The easiest way to think about this is to consider the figures above and imagine that those shift counts are smeared uniformly across the entire tree. Consider the whale dataset with <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">1</span></code>. In this case, the expected number of shifts under the prior is:</p>
<div class="highlight-python"><div class="highlight"><pre>sum(prior.whales$N_shifts * prior.whales$prob)
# should give roughly 0.95
</pre></div>
</div>
<p>This is the average number of shifts we should observe across the whole tree under the prior. So, if the sum of all branch lengths in our tree is <em>S</em>, the expected fraction of total shift events that should occur on a given branch is equal to the branch length divided by <em>S</em>. If your expected number of shifts under the prior is 2.0, and the sum of all branch lengths is 5.0, a branch of length 1.0 time units will, on average, contain <em>5 x 0.2 = 1</em> shift under the prior alone. A critical point is that under the prior, the distribution of shifts is uniform across the tree.</p>
<p>This leads to one major difficulty with the interpretation of marginal shift probabilities: these probabilities will depend on the Poisson rate prior we choose for our analysis. And just as importantly, they will depend on the branch length. Because the expected number of rate shifts under the prior is uniform, we expect to observe more shifts on long branches than short branches, just by chance alone. If we want to identify the branches that have the strongest evidence for <strong>significant and substantial</strong> rate shifts, then it makes sense that we should take the prior into account when evaluating shift probabilities on individual branches.</p>
<p>We feel that this is issue is sufficiently important that we have made addressing this challenge a major feature of BAMMtools 2.0.</p>
</div>
<div class="section" id="bayes-factors-as-evidence-for-rate-shifts">
<h3>3.4.4. Bayes factors as evidence for rate shifts<a class="headerlink" href="#bayes-factors-as-evidence-for-rate-shifts" title="Permalink to this headline">¶</a></h3>
<p id="bayesfactorbranches">Our solution to the problem above is to compute a <em>Bayes factor</em> associated with evidence for a rate shift, for each branch in our phylogeny. This is a nice solution that has a natural Bayesian interpretation and accounts for the effects of the prior and branch length on our perceived evidence for a rate shift. We thank
<a class="reference external" href="http://www.phyleaux1.lsu.edu">Jeremy Brown</a> for suggesting the use of Bayes factors in this context.</p>
<p>Here, we will consider a worked example using the whales dataset that is distributed with BAMMtools. The basic idea is to imagine that, in the context of a BAMM analysis, each branch can be described by one of two models: either there is a rate shift on the branch, or there is no rate shift on the branch. Let&#8217;s compute the marginal shift probabilities on the whale phylogeny:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">edata</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">margprobs</span> <span class="o">&lt;-</span> <span class="n">marginalShiftProbsTree</span><span class="p">(</span><span class="n">edata</span><span class="p">)</span>
</pre></div>
</div>
<p>We will now look carefully at the 3 branches with the highest marginal shift probabilities in the whale analysis. Here they are, plotted:</p>
<div class="figure align-center" id="bayesfactorbranches1">
<a class="reference internal image-reference" href="_images/bayesfactorbranches1.png"><img alt="_images/bayesfactorbranches1.png" src="_images/bayesfactorbranches1.png" style="width: 380px;" /></a>
</div>
<p>These are posterior probabilities of shifts on three individual branches (and, in ape node format, these are nodes 16, 140, and 141). But what about the prior probabilities of a rate shift on those branches? BAMMtools has a function that uses the simulated prior distribution to compute prior probability of a rate shift on any given branch (there is a short appendix <a class="reference internal" href="#appendix1"><span>here</span></a> that shows how this is done). In BAMMtools, we could just do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">whales</span><span class="p">)</span>
<span class="n">branch_priors</span> <span class="o">&lt;-</span> <span class="n">getBranchShiftPriors</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
</pre></div>
</div>
<p>The object <code class="docutils literal"><span class="pre">branch_priors</span></code> is now a copy of our phylogenetic tree, but where each branch length is equal to the <em>prior</em> probability of a rate shift. Here are the prior probabilities for the 3 branches identified above as having elevated marginal shift probabilities:</p>
<div class="figure align-center" id="bayesfactorbranches2">
<a class="reference internal image-reference" href="_images/bayesfactorbranches2.png"><img alt="_images/bayesfactorbranches2.png" src="_images/bayesfactorbranches2.png" style="width: 380px;" /></a>
</div>
<p>Note that the prior probability of a shift is proportional to the branch length. The longest branch, with a marginal (posterior) probability of 0.06, also has the greatest probability of a shift expected under the prior alone (<em>prob = 0.025</em>). But the shortest branch is the one with the lowest overall prior probability. In fact, our prior expectation is that we are 25 times more likely to see a shift on the long branch relative to the short branch. We will now compute branch-specific Bayes factors associated with a <em>rate shift</em> relative to <em>no rate shift</em>.</p>
<p>Let <img class="math" src="_images/math/7959bcdaaef98a4a36247abd87a5ebf8317c83ff.png" alt="P_S"/> denote the posterior probabilities of either observing a shift on some particular branch, and let <img class="math" src="_images/math/49013142ab08a7b27c335f6d7dba2e8726bf2496.png" alt="\pi_S"/> denote the corresponding prior probability of a shift on that branch. The posterior probability of no shift (<img class="math" src="_images/math/657cc52a451e3a62f78976a525589c129ce8eda3.png" alt="P_{NS}"/> is just <img class="math" src="_images/math/3ffabc2c3a6c26ba2867a34763e8971f6ebae7ca.png" alt="P_{NS} = 1 - P_S"/>, and the prior probability of no shift (<img class="math" src="_images/math/29ac46bfb178ddc243df0fee5814ebd5f8bab69e.png" alt="\pi_{NS}"/>) can be computed the same way. The Bayes factor evidence for a <em>rate shift</em> relative to <em>no rate shift</em> is given by</p>
<div class="math">
<p><img src="_images/math/0af47f888a0a4758db9d09b62acb05eef36d1241.png" alt="BF_{SHIFT} = \frac{\frac{P_S}{\pi_S}}{\frac{P_{NS}}{\pi_{NS}}} = {\frac{P_S}{(1 - P_S)}}{\frac{(1 - \pi_S)}{\pi_S}}"/></p>
</div><p>This quantity has an appealing intuitive interpretation. It is a measure of the posterior odds of two models (shift versus no shift), normalized by their prior odds ratio. Values of 20 or so imply reasonably strong support for one model over another. One way to think about this is to imagine a scenario where the posterior probability of a rate shift on a branch is 0.95, and the prior probabilities of shift and no shift are equal (<img class="math" src="_images/math/f6393448e56d0982dd74f0ab405954eb3e51eeaf.png" alt="\pi_S = 0.5"/>). The Bayes factor in favor of a rate shift would just be 0.95 / 0.05, or 19. Because the &#8220;null model&#8221; (no rate shift) has a posterior probability of 0.05, we can (very loosely) relate this Bayes factor to a traditional p-value in classical hypothesis testing: a Bayes factor of approximately 20 corresponds approximately to a null hypothesis p-value (no shift) of 0.05. BAMMtools enables us to easily compute the Bayes factor evidence for a rate shift on each branch of our phylogeny:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">edata</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">branch_priors</span> <span class="o">&lt;-</span> <span class="n">getBranchShiftPriors</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">bf</span> <span class="o">&lt;-</span> <span class="n">bayesFactorBranches</span><span class="p">(</span><span class="n">edata</span><span class="p">,</span> <span class="n">branch_priors</span><span class="p">)</span>
</pre></div>
</div>
<p>The object <code class="docutils literal"><span class="pre">bf</span></code> is now a copy of our phylogenetic tree where the branch lengths have been scaled to equal the corresponding Bayes factor. Let&#8217;s go back to the whale tree and look at the Bayes factor evidence for a rate shift on the 3 branches with the highest marginal shift probability:</p>
<div class="figure align-center" id="bayesfactorbranches3">
<a class="reference internal image-reference" href="_images/bayesfactorbranches3.png"><img alt="_images/bayesfactorbranches3.png" src="_images/bayesfactorbranches3.png" style="width: 380px;" /></a>
</div>
<p>You can see that the Bayes factor evidence provides a clearer interpretation of these shift probabilities. This shows that the branch with the strongest evidence for a rate shift is, by far, the shortest branch overall. Bayes factors of this magnitude (&gt; 800) are very strong evidence in favor of a model with a rate shift on this branch. The marginal shift probabilities for the 2 branches at the top aren&#8217;t all that different (0.37 and 0.55), but - relative to their prior expectation - there is much stronger evidence for a shift on the short branch. Conversely, our perception of already-weak evidence for a shift on the long branch (marginal probability = 0.06) drops even further, as it now has a Bayes factor of 2.6 (not worth mentioning). In fact, we can redraw our phylogeny, scaling each branch length by the Bayes factor support for a rate shift. We simply plot the object returned by <code class="docutils literal"><span class="pre">bayesFactorBranches</span></code> with <code class="docutils literal"><span class="pre">plot.phylo</span></code>:</p>
<div class="figure align-center" id="bayesfactorbranches4">
<a class="reference internal image-reference" href="_images/bayesfactorbranches4.png"><img alt="_images/bayesfactorbranches4.png" src="_images/bayesfactorbranches4.png" style="width: 380px;" /></a>
</div>
<p>This is the same tree as above, and we have highlighted the same 3 branches. The blue scale bar denotes a length of 100 Bayes factor units. All of this is background to appreciating perhaps the most important concept in a Bayesian analysis of diversification: the notions of <strong>distinct shift configurations</strong> and <strong>credible shift sets</strong>.</p>
</div>
<div class="section" id="coreshifts">
<span id="identifying-the-distinct-shift-configurations"></span><h3>3.4.5. Identifying the distinct shift configurations<a class="headerlink" href="#coreshifts" title="Permalink to this headline">¶</a></h3>
<p>For any given phylogenetic tree, there are many possible <strong>topologically distinct shift configurations</strong>. A topologically distinct shift configuration on a phylogeny is one that is distinguishable from all other shift configurations by the presence or absence of a rate shift on at least one branch. The total possible number of <strong>distinct shift configurations</strong>, or <em>D</em>, for a given tree with <em>N</em> branches is simply</p>
<div class="math">
<p><img src="_images/math/66629d9ac8b091502f6fa45120763003bd8e51e5.png" alt="D_N = \sum_{k = 0}^{N}\dbinom{N}{k}"/></p>
</div><p>This includes one shift configuration for the case where there are no rate shifts, one configuration for the case where every branch has a rate shift, and all combinations between those two extremes. This is a large number for real phylogenies.</p>
<p>If you were to run BAMM until the end of time, you could theoretically obtain at least one sample of every single topologically distinct shift configuration. This immediately follows from the fact that all branches have non-zero prior probabilities of rate shifts (see above if this is not clear!). If we were to enumerate every single <strong>distinct shift configuration</strong> from a typical BAMM analysis, we would end up with a very large set of shift configurations. Often, this number would be nearly equal to the number of samples we have obtained from our posterior!</p>
<p>What you really care about are the <strong>important</strong> rate shifts, not random events that are simply a result of prior expectations. The solution we have adopted in BAMM 2.0 is examine each branch in a phylogenetic tree and determine whether it contains a <em>potentially significant</em> or <em>trivial</em> rate shift. We use an explicit Bayes factor criterion to determine which rate shifts have marginal probabilities that are elevated relative to the prior expectation.</p>
<p>To illustrate this, here is a plot of 20 random shift configurations from a BAMM analysis of the whale dataset (using a slightly reduced taxon set from the function <code class="docutils literal"><span class="pre">subtreeBAMM</span></code>).</p>
<div class="figure align-center" id="distinctshiftconfigurations1">
<a class="reference internal image-reference" href="_images/distinctshiftconfigs1.png"><img alt="_images/distinctshiftconfigs1.png" src="_images/distinctshiftconfigs1.png" style="width: 500px;" /></a>
</div>
<p>If you look carefully, you&#8217;ll see that there are a few shifts that pop up more frequently than others, and a number of shifts that show up just once. Remember, any sample from the posterior has a reasonable chance of including rate shifts of no significance - e.g., shifts that are no more common than you would expect by chance alone under the prior. This next plot shows all shifts that occurred in the (relatively small) posterior sample for the whales example dataset in BAMMtools. The plot will show a blue circle on any node that defines a branch where a rate shift was observed (and thus, a circle at the tip of the tree implies a shift somewhere on a terminal branch):</p>
<div class="figure align-center" id="distinctshiftconfigurations2">
<a class="reference internal image-reference" href="_images/distinctshiftconfigs2.png"><img alt="_images/distinctshiftconfigs2.png" src="_images/distinctshiftconfigs2.png" style="width: 500px;" /></a>
</div>
<p>There are a lot of rate shifts here! Note how most of the terminal branches are associated with at least 1 rate shift in the posterior. This is not unexpected, given that they are generally longer than the internal branches. Regardless, if we took enough samples from the posterior, <strong>we would eventually observe a shift associated with every node</strong>. Most of the shifts illustrated above are meaningless: they aren&#8217;t supported by the data and exist only because we have a non-zero prior probability of a rate shift on a particular branch. Hence, they have low marginal probabilities and perhaps only occur once in our dataset.</p>
<p>To enumerate the topologically distinct shift configurations in our dataset, it makes little sense to focus on rate shifts that are not supported by the data. Our solution is to divide rate shifts into <strong>core shifts</strong> and <strong>non-core</strong> shifts. <strong>Core shifts</strong> are those that contribute appreciably to your ability to model the data. <strong>Non-core shifts</strong> are simply ephemeral shifts that don&#8217;t really contribute anything: they are simply what you expect under the prior distribution for rate shifts across the tree. To identify <strong>core</strong> and <strong>non-core</strong> shifts in BAMMtools 2.0+, we used an explicit Bayes factor criterion as described <a class="reference internal" href="#bayesfactorbranches"><span>here</span></a>. Specifically, we compute the Bayes factor associated with a rate shift for every branch in the phylogeny. We then exclude all nodes that are unimportant using a Bayes factor criterion.</p>
<p><strong>Nodes with Bayes factors less than or equal to 1 have marginal shift probabilities equal to or less than you would expect under the prior alone.</strong> In general, Bayes factors less than 5 imply such weak evidence for a rate shift that they wouldn&#8217;t be worth mentioning.  Here, we&#8217;ll apply a Bayes factor criterion of 3 to the whale phylogeny, thus including only those rate shift nodes supported by Bayes factors of 3 or greater:</p>
<div class="figure align-center" id="distinctshiftconfigurations3">
<a class="reference internal image-reference" href="_images/distinctshiftconfigs3.png"><img alt="_images/distinctshiftconfigs3.png" src="_images/distinctshiftconfigs3.png" style="width: 500px;" /></a>
</div>
<p>We can now enumerate the set of topologically distinct shift configurations that are distinguished by the presence or absence of rate shifts at one or more of the nodes shown in the preceding figure. We will now use the <code class="docutils literal"><span class="pre">plot.credibleshiftset</span></code> function from BAMMtools to summarize the credible set of macroevolutionary rate configurations using this Bayes factor criterion. Here&#8217;s the R code to do this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">edata</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">prior</span> <span class="o">&lt;-</span> <span class="n">getBranchShiftPriors</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">css</span> <span class="o">&lt;-</span> <span class="n">credibleShiftSet</span><span class="p">(</span><span class="n">edata</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">BFcriterion</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">css</span><span class="p">)</span>
</pre></div>
</div>
<p>And here is the 95% credible set of macroevolutionary shift configurations:</p>
<div class="figure align-center" id="distinctshiftconfigurations4">
<a class="reference internal image-reference" href="_images/distinctshiftconfigs4.png"><img alt="_images/distinctshiftconfigs4.png" src="_images/distinctshiftconfigs4.png" style="width: 500px;" /></a>
</div>
<p>This figure contains a wealth of important information. It says that 54% of the samples in your posterior can be assigned to a single shift configuration: specifically, one where a shift at one of the nodes leading to the dolphins underwent a major increase in speciation rate. And 36% of the posterior distribution has a shift on the branch immediately ancestral to that one. To be clear, these are the <strong>same two branches</strong> we identified <a class="reference internal" href="#bayesfactorbranches3"><span>earlier</span></a> as having major evidence for a rate shift (Bayes factors of 69 and 819; ape format nodes 140 and 141). Importantly, this also shows us that fully 2.3% of the samples in the posterior had zero core shifts. Together, these four shift configurations account for 96.1% of the posterior distribution.</p>
</div>
<div class="section" id="overall-best-shift-configuration">
<h3>3.4.6. Overall <em>best</em> shift configuration<a class="headerlink" href="#overall-best-shift-configuration" title="Permalink to this headline">¶</a></h3>
<p>Marginal shift probabilities and Bayes factors associated with particular shifts don&#8217;t tell you much about the most likely sets of shifts that generated your dataset, and it is generally not possible to show all shift configurations sampled during simulation of the posterior. One possibility is to show the maximum <em>a posteriori</em> probability (MAP) shift configuration. This is the distinct shift configuration with the highest posterior probability - e.g., the one that was sampled most often.</p>
<p>In BAMMtools, it is straightforward to estimate (and plot) this. Considering the whales dataset:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">prior</span> <span class="o">&lt;-</span> <span class="n">getBranchShiftPriors</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">ed</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">best</span> <span class="o">&lt;-</span> <span class="n">getBestShiftConfiguration</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span> <span class="n">BFcriterion</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">bammdata</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
<span class="n">addBAMMshifts</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>In general, if you show just a single shift configuration estimated with BAMM for publication, we recommend showing the MAP configuration as estimated by <code class="docutils literal"><span class="pre">getBestShiftConfiguration</span></code> (which should also be the most frequent shift configuration in your credible shift set).</p>
</div>
<div class="section" id="how-not-to-interpret-node-specific-shift-evidence">
<h3>3.4.7. How <em>not</em> to interpret node-specific shift evidence<a class="headerlink" href="#how-not-to-interpret-node-specific-shift-evidence" title="Permalink to this headline">¶</a></h3>
<p>Thus far, we have discussed two types of evidence that can be evaluated in favor of a rate shift at a particular node: marginal shift probabilities, and Bayes factors. We argued that Bayes factors were better than marginal shift probabilities because they explicitly account for the prior expectation on the number of shift events per branch.</p>
<p>Regardless of which approach you use, bear in mind that it is incorrect to assume that you need &#8220;significant&#8221; (p &gt; 0.95) marginal shift probabilities (or substantial branch-specific Bayes factor support) to demonstrate significant rate heterogeneity in your dataset. The evidence for rate heterogeneity comes from considering the posterior probabilities on the number of shifts, or - even better - the Bayes factor evidence in favor of model with <em>k</em> shifts (<img class="math" src="_images/math/b7d9aee02379efa65a1a02d0890d28ff4215d940.png" alt="M_k"/>) relative to a model with 0 shifts (<img class="math" src="_images/math/a4444e4939d5397d61e29984e82d4ced75649a7a.png" alt="M_0"/>).</p>
<p>In the toy example <a class="reference internal" href="#toyshifts"><span>above</span></a>, we had evidence for rate heterogeneity in the dataset (with posterior probability 1.0), yet the marginal shift probabilities (0.49, 0.51) are not &#8220;significant&#8221;.  This is a most important point: you can have massive evidence for rate heterogeneity in your dataset, but your marginal shift probabilities will be a function of the frequency distribution of <strong>distinct alternative shift configurations</strong>.</p>
</div>
<div class="section" id="macroevolutionary-cohort-analysis">
<span id="cohortexplanation"></span><h3>3.4.8. Macroevolutionary cohort analysis<a class="headerlink" href="#macroevolutionary-cohort-analysis" title="Permalink to this headline">¶</a></h3>
<p>In order to avoid some of the challenges associated with visualizing complex rate shift dynamics on large trees, we developed a solution that condenses the rate regime dynamics into a single graphic: the <strong>cohort analysis</strong>. The cohort matrix depicts the pairwise probability that any two lineages share the same macroevolutionary rate dynamics. The cohort matrix method is fully explained in this (<a class="reference external" href="http://sysbio.oxfordjournals.org/content/63/4/610">Systematic Biology article</a>).</p>
<p>For each posterior sample from a BAMM analysis, a value of 1 is assigned to a pair of lineages that belong to the same rate regime, and a value of 0 is assigned if they do not. These pairwise values are then averaged across the full set of sampled shift configurations from the posterior distribution.</p>
<p>In the following figure, we illustrate with a toy example how one moves from distinct rate shift configurations to a macroevolutionary cohort matrix.</p>
<div class="figure align-center" id="cohortexample">
<a class="reference internal image-reference" href="_images/cohortExample.png"><img alt="_images/cohortExample.png" src="_images/cohortExample.png" style="width: 700px;" /></a>
</div>
<p>In this example, we have three clades with varying diversity. This diversity pattern is explained by the presence of two rate regimes (a root regime, and a single shift to a new regime), and two distinct shift configurations: one configuration with a shift leading to an increase in diversification rate at the base of clade X, and the other configuration with a decrease in diversification rate at the base of clade Y. Clade Z always belongs to the root regime.</p>
<p>It is important to note that although cohort matrices appear to be made up of blocks, <strong>the cohort analysis is applied at the species level</strong>. Species that share the same rate regimes appear in the same color, and so they appear as blocks. We will be referring to blocks for convenience, but this is really an analysis of macroevolutionary cohorts of species.</p>
<p>The first thing to note is that as this is a full pairwise matrix, lineages will of course always share the same rate dynamics with themselves, so there will always be blocks with a value of 1, arranged along the diagonal. Also,the top left triangle of the matrix will mirror the bottom right triangle. We will now examine the other patterns in detail. The top left block in the cohort matrix has a value of 0.4. This block represents a rate dynamic comparison between clade X and clade Z. As clade X has its own rate regime with a probability of 0.6, that means its rate parameters are decoupled from those of clade Z in 60% of the posterior distribution. Therefore, for 40% of the posterior, the two clades belong to the same rate regime, hence a value of 0.4 in the cohort matrix. We get an equivalent scenario for boxes representing the comparison of clades Y and Z. Clades X and Y, despite being sister clades, never share the same rate regime, as there is always a shift at the base of either one of those clades. Therefore, we get a value of 0 for the middle right block of the cohort matrix.</p>
<p>Incidentally, this illustrates that rate regimes do <strong>not necessarily</strong> exhibit any sort of phylogenetic signal. Since any 2 clades can potentially belong to the root regime, depending on where other shifts are located, it is entirely possible for distantly related clades to share rate regimes when closely related clades do not, as is the case for clades X and Y, vs. X and Z.</p>
<p>We will now look at an empirical example with the whales dataset.</p>
<div class="figure align-center" id="cohortexample2">
<a class="reference internal image-reference" href="_images/cohort_whales.png"><img alt="_images/cohort_whales.png" src="_images/cohort_whales.png" style="width: 600px;" /></a>
</div>
<p>The whale dataset provides a relatively simple example of a cohort analysis. Again, blocks B and C have values of 1 because they represent comparisons of the same clades and therefore share the same rate regime. Variation in color seen within these blocks represents shifts that occurred in a relatively small number of posterior samples for lineages within these major clades.</p>
<p>The large blue blocks A and D clearly show that across the posterior distribution of the BAMM analysis, the dolphin clade almost never shares the same rate regime as the rest of the phylogeny.</p>
<p>The killer whale is the lineage represented by blocks E and F. Interestingly, we see that in about 50% of the posterior, this lineage is placed within the same rate regime as the dolphin clade, and the rest of the time, it is in the root regime with beaked and baleen whales. This is why we see 2 pale lines through our cohort matrix, representing values of ~ 0.5.</p>
</div>
<div class="section" id="maximum-shift-credibility-configuration">
<h3>3.4.9. Maximum shift credibility configuration<a class="headerlink" href="#maximum-shift-credibility-configuration" title="Permalink to this headline">¶</a></h3>
<p>An alternative estimate of the <em>most likely shift configuration</em> is the <strong>maximum shift credibility configuration (MSC)</strong>. This concept is analogous to the <em>maximum clade credibility</em> tree in a Bayesian phylogenetic analysis. The MSC configuration is a rate shift configuration that was actually sampled by BAMM and which is one estimate of the best overall configuration. Formally, the MSC configuration is estimated in several steps. First, we compute the marginal shift probabilities on each branch of the tree. For the i<sup>th</sup> branch, denote this probability as p<sub>i</sub>. For each sample shift configuration from the posterior, we then compute the product of the observed set of shifts, using these marginal probabilities. These are then weighted by the posterior probability of sample <em>k</em> (as defined by the number of processes), or <em>P(k)</em>. The shift credibility score <em>C</em> for the k<sup>th</sup> sample is computed as:</p>
<div class="math">
<p><img src="_images/math/44002fc4c1c8340bf2a508008e40fda138084640.png" alt="C = P(k) \prod_{i = 1}^{N}{p_i^{I_{i,k}}}{(1 - p_i)^{1 - I_{i,k}}}"/></p>
</div><p>where I<sub>i,k</sub> is an indicator variable taking a value of 1 if a shift occurs on branch <em>i</em> for sample <em>k</em>, and 0 if no shift occurs in the sample. In BAMMtools, you can easily estimate the MSC configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">library</span><span class="p">(</span><span class="n">BAMMtools</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">primates</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">primates</span><span class="p">)</span>
<span class="n">ed</span> <span class="o">&lt;-</span> <span class="n">getEventData</span><span class="p">(</span><span class="n">primates</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">primates</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;trait&#39;</span><span class="p">)</span>
<span class="n">msc_tree</span> <span class="o">&lt;-</span> <span class="n">maximumShiftCredibility</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>
</pre></div>
</div>
<p>We generally recommend using the MAP shift configuration (<code class="docutils literal"><span class="pre">getBestShiftConfiguration</span></code>) over the MSC configuration, except for very large phylogenies. Often, however, the two approaches will estimate the same shift configuration.</p>
</div>
<div class="section" id="cumulative-shift-probabilities">
<h3>3.4.10. Cumulative shift probabilities<a class="headerlink" href="#cumulative-shift-probabilities" title="Permalink to this headline">¶</a></h3>
<p>The <em>cumulative shift shift probability tree</em> shows the probability that a given node has evolutionary rate dynamics that are decoupled from the root process. For a given node to be decoupled from the &#8220;background&#8221; evolutionary dynamic, a rate shift must occur somewhere on the path between the node and the root of the tree. Branches with a cumulative shift probability of 1.0 imply that every sample in the posterior shows at least one rate shift between the focal branch and the root of the tree, leading to evolutionary dynamics that are decoupled from the background process.</p>
<p>Consider the whale diversification <a class="reference internal" href="#whalemarg1"><span>analysis</span></a>. Even though we have relatively low confidence of the precise branch on which a shift may have occurred, we have high confidence that a shift occurred on one of the ancestral branches leading to the dolphin clade. Formally, the cumulative shift probability for branch b<sub>i</sub> is computed as:</p>
<div class="math">
<p><img src="_images/math/cd39202412ded62a1210799a895884eb1b496ec4.png" alt="b_i = \frac{\sum_{k = 1}^{S}\Phi_{k,i}}{N}"/></p>
</div><p>where <img class="math" src="_images/math/e9be6d623cac76f49e6040c6c281f626a0c5734d.png" alt="\Phi_{k,i}"/> is an indicator variable that takes a value of 1 if a shift occurs somewhere on the path between branch <em>i</em> and the root of the tree (0 otherwise). The cumulative shift probability on a particular branch <img class="math" src="_images/math/5297a2c39c035905dc16f74a46fcb1b04743f8c5.png" alt="b_i"/> might thus be extremely high even if shifts are unlikely to have occurred on branch <img class="math" src="_images/math/5297a2c39c035905dc16f74a46fcb1b04743f8c5.png" alt="b_i"/> itself.</p>
<p>The cumulative shift probability tree can be computed with the function <code class="docutils literal"><span class="pre">cumulativeShiftProbsTree</span></code>. Although this a useful approach, we believe that identifying macroevolutionary cohorts (see function <code class="docutils literal"><span class="pre">cohorts</span></code>) provides greater insight into patterns of diversification rate heterogeneity across phylogenies.</p>
</div>
</div>
<div class="section" id="appendix">
<h2>3.5. Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="computing-prior-probabilities-of-rate-shifts-on-branches">
<h3>3.5.1. Computing prior probabilities of rate shifts on branches<a class="headerlink" href="#computing-prior-probabilities-of-rate-shifts-on-branches" title="Permalink to this headline">¶</a></h3>
<p id="appendix1">The function <code class="docutils literal"><span class="pre">getBranchShiftPriors</span></code> computes the prior probability of a rate shift on each branch of a phylogenetic tree. Let the prior (whole-tree) probability of <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/> rate shifts on a phylogeny be denoted by <img class="math" src="_images/math/916754f7e7de4247fa27c52f610948b4055311fe.png" alt="\pi_i"/>, such that</p>
<div class="math">
<p><img src="_images/math/3ed53bc42bb53e3274667ac75d7a2dca527da975.png" alt="\sum_{i=0}^{\infty} \pi_i = 1"/></p>
</div><p>This distribution is easily simulated in BAMM. Now, to compute the prior probability of a rate shift on any particular branch, we note that the <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/> events should occur on any branch of the phylogeny with a probability proportional to the relative length of the branch. E.g., given that <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/> events occur on the tree, their distribution on any given branch is binomial with parameter <img class="math" src="_images/math/4dafe0482b9d033cdfd67133f9d4a42fcc976c56.png" alt="b_k / T"/>, where <img class="math" src="_images/math/60f83b5a089da399e1341e8e9b28f52804e3f64e.png" alt="b_k"/> is the length of branch <img class="math" src="_images/math/e9203da50e1059455123460d4e716c9c7f440cc3.png" alt="k"/> and <img class="math" src="_images/math/6d42c88506b8da39a2a23653aecbfb7c29728063.png" alt="T"/> is the sum of all branch lengths. The probability that at least one event occurs on branch <img class="math" src="_images/math/e9203da50e1059455123460d4e716c9c7f440cc3.png" alt="k"/>, given <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/> total events on the tree, is just:</p>
<div class="math">
<p><img src="_images/math/abd3504753b2563629fb5c5a6d36d9b4ad99466c.png" alt="1 - {i \choose 0} \left(\frac{b_k}{T}\right)^0 \left(1 - \frac{b_k}{T}\right)^i = 1 - \left(1 - \frac{b_k}{T}\right)^i"/></p>
</div><p>The overall prior probability of at least one event occurring on branch <img class="math" src="_images/math/e9203da50e1059455123460d4e716c9c7f440cc3.png" alt="k"/> is obtained by summing these probabilities after weighting by the probability of <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/> events:</p>
<div class="math">
<p><img src="_images/math/4b52b41c0afeb9a09e06f6d3e5bc363805541590.png" alt="\sum_{i=0}^{\infty} \left(1 - \left(1 - \frac{b_k}{T}\right)^i \right) \pi_i"/></p>
</div></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="fossilbamm.html" title="4. fossil BAMM"
             >next</a></li>
        <li class="right" >
          <a href="bammgraph.html" title="2. BAMM graph gallery"
             >previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b3+.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>