<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>11. The BAMM likelihood function &mdash; bamm 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="bamm 2.5.0 documentation" href="documentation.html" />
    <link rel="next" title="12. Metropolis coupled Markov chain Monte Carlo [(MC)3]" href="mc3.html" />
    <link rel="prev" title="10. Frequently Asked Questions" href="faq.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="mc3.html" title="12. Metropolis coupled Markov chain Monte Carlo [(MC)3]"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="faq.html" title="10. Frequently Asked Questions"
             accesskey="P">previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">11. The BAMM likelihood function</a><ul>
<li><a class="reference internal" href="#introduction-models-for-rate-shifts">11.1. Introduction: models for rate shifts</a></li>
<li><a class="reference internal" href="#is-the-bamm-likelihood-correct">11.2. Is the BAMM likelihood correct?</a></li>
<li><a class="reference internal" href="#what-exactly-is-the-process-modeled-by-bamm">11.3. What, exactly, is the process modeled by BAMM?</a></li>
<li><a class="reference internal" href="#extinction-calculations-at-nodes">11.4. Extinction calculations at nodes</a><ul>
<li><a class="reference internal" href="#why-extinction-handling-at-nodes-matters">11.4.1. Why extinction handling at nodes matters</a></li>
<li><a class="reference internal" href="#extinction-at-nodes-a-worked-example">11.4.2. Extinction at nodes: a worked example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#theoretical-issues-for-rate-shift-models">11.5. Theoretical issues for rate shift models</a></li>
<li><a class="reference internal" href="#is-the-bamm-likelihood-computed-correctly">11.6. Is the BAMM likelihood computed correctly?</a></li>
<li><a class="reference internal" href="#numerical-approximations-in-bamm">11.7. Numerical approximations in BAMM</a><ul>
<li><a class="reference internal" href="#discretization-of-evolutionary-rates-for-the-time-varying-process">11.7.1. Discretization of evolutionary rates for the time-varying process</a></li>
<li><a class="reference internal" href="#maximum-possible-extinction-probability">11.7.2. Maximum possible extinction probability</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="faq.html"
                        title="previous chapter">10. Frequently Asked Questions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mc3.html"
                        title="next chapter">12. Metropolis coupled Markov chain Monte Carlo [(MC)<sup>3</sup>]</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/likelihoodmodel.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-bamm-likelihood-function">
<span id="likelihood"></span><h1>11. The BAMM likelihood function<a class="headerlink" href="#the-bamm-likelihood-function" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction-models-for-rate-shifts">
<h2>11.1. Introduction: models for rate shifts<a class="headerlink" href="#introduction-models-for-rate-shifts" title="Permalink to this headline">¶</a></h2>
<p>This page discusses a number of important theoretical issues involving BAMM. The objective is both to clarify BAMM&#8217;s assumptions, and also to point out some outstanding theoretical problems/challenges for future work. These issues are more general than BAMM and (probably) apply to all other software implementations and modeling frameworks that purport to compute the likelihood of a phylogenetic tree with a mapped (= assumed) configuration of <strong>rate shifts</strong> under the condition of <strong>non-zero extinction rates</strong>. Other implementations/approaches that must confront the issues raised below include the <a class="reference external" href="http://www.pnas.org/content/106/32/13410.abstract">MEDUSA model</a>, the &#8216;split&#8217; option for <a class="reference external" href="http://onlinelibrary.wiley.com/doi/10.1111/j.2041-210X.2012.00234.x/abstract">BiSSE</a>, <a class="reference external" href="http://sysbio.oxfordjournals.org/content/59/6/619.abstract">QuaSSE</a>, <a class="reference external" href="http://sysbio.oxfordjournals.org/content/60/4/451">GeoSSE</a>, and related models, the DDD models with different shift regimes on <a class="reference external" href="http://www.jstor.org/stable/10.1086/667574">specific subclades</a>, and multi-process shift models as currently implemented in <a class="reference external" href="http://www.pnas.org/content/108/39/16327.abstract">RPANDA</a>.</p>
</div>
<div class="section" id="is-the-bamm-likelihood-correct">
<h2>11.2. Is the BAMM likelihood correct?<a class="headerlink" href="#is-the-bamm-likelihood-correct" title="Permalink to this headline">¶</a></h2>
<p>A recent <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">post</a> to our Github repository called attention to one seemingly peculiar feature of the likelihood function in BAMM. The likelihood function is, of course, the core of inference using BAMM. If the likelihood function is incorrect, or if it is based on flawed assumptions, inferences based on the method may be problematic. Note that here we are concerned with whether the theoretical model in BAMM itself is correct, not whether the model itself is implemented correctly. In <a class="reference internal" href="#testlikelihood"><span>this</span></a> section, we describe how users can validate the actual BAMM likelihood itself (e.g., is the program computing what we think it is computing?). But for now, some theory.</p>
<p>The BAMM likelihood is based on a set of differential equations that describe transition probabilities for a stochastic birth-death process. These equations are solved from tips-to-root of a phylogeny along individual branches, and probabilities are combined at nodes; when we&#8217;ve reached the root, we will have computed the likelihood for the full tree. The <a class="reference external" href="http://sysbio.oxfordjournals.org/content/56/5/701.abstract">original BiSSE paper</a> remains my (DLR) all-time favorite explanation (both graphically and mathematically) for how the likelihood of a phylogeny can be computed under a birth-death process; I strongly recommend it as a prelude to the discussion below.</p>
<p>The likelihood calculations in BAMM are simpler than those in BiSSE, because BAMM is not concerned with character states &#8211; or at least, in BAMM, we know which state (shift regime) we are in. BiSSE is somewhat more complex, because the method integrates over all possible (unobserved) transitions in character states.</p>
<p>The differential equations for the BAMM likelihood involve two probabilities. The first, <img class="math" src="_images/math/045ed46a8b2be5e501f87130829398141a0ca7db.png" alt="D(t)"/>, is the probability that a lineage at some point in time (i.e., a location on an observed branch of a phylogeny) gives rise to all observed downstream data &#8211; specifically, all the lineages descended from this particular point on the tree. The second equation, <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/>, describes the probability that a lineage at the same point in time (along with all of its descendants) has gone extinct before the present. Letting <img class="math" src="_images/math/1ab0134b6e0837594649c75a2ed83cfd85a2d03d.png" alt="\lambda"/> denote the speciation rate and <img class="math" src="_images/math/126e84ba38f7dece5f0ad64e929b9588b20f6440.png" alt="\mu"/> the extinction rate, we have:</p>
<div class="math">
<p><img src="_images/math/fa99132063db579f92c2691efb398d253cb7e86b.png" alt="\frac{dD}{dt} = -(\lambda + \mu)D(t) - 2 \lambda D(t) E(t)"/></p>
</div><div class="math">
<p><img src="_images/math/a31ac6a0d25dfed46b033784671b93d5c570d871.png" alt="\frac{dE}{dt} = \mu -(\lambda + \mu)E(t) + \lambda E(t)^2"/></p>
</div><p>These equations are derived from considering the state space for all possible events that could have happened on some infinitesimal time interval <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/>. For the extinction probability <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/>, BAMM assumes that any given interval of time <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/> can be described by one of the following events:</p>
<div class="figure align-center" id="extinctionprob1">
<a class="reference internal image-reference" href="_images/BAMM_E_t_3event.png"><img alt="_images/BAMM_E_t_3event.png" src="_images/BAMM_E_t_3event.png" style="width: 550px;" /></a>
</div>
<p>That is, a lineage alive at some time in the past can go extinct before the present (along with all of its descendants) if one of the following occurs on <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/> :</p>
<ul class="simple">
<li>Extinction on <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/>: This event occurs with probability proportional to <img class="math" src="_images/math/126e84ba38f7dece5f0ad64e929b9588b20f6440.png" alt="\mu"/>.</li>
<li>No extinction, no speciation : Nothing happens on the focal interval, but the lineage and all of its descendants goes extinct before the present. This event occurs with probability <img class="math" src="_images/math/3950abf883ac391575ecf94c661e39236f81988c.png" alt="-(\lambda + \mu)E(t)"/>.</li>
<li>Speciation : A speciation event occurs on <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/>, but both descendant lineages (and any additional descendants) go extinct before the present. This event occurs with probability proportional to <img class="math" src="_images/math/22435c51538a1af1917ba9edbdd470aa718bfefa.png" alt="\lambda E(t)^2"/>.</li>
</ul>
<p>These three terms are combined into the differential equation for the change in the extinction probability with respect to time, <img class="math" src="_images/math/c1f7a147799f1bb48f38dbd8e1acd5e894534d11.png" alt="dE / dt"/>.</p>
<p>There is one curious feature of scenarios described above as used in BAMM, and it is that they neglect another type of event that <em>could have occurred</em> on <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/>. Specifically, it is possible that a lineage could have undergone a shift to an entirely new macroevolutionary rate regime, but that the lineage &#8211; along with all of its descendants &#8211; went extinct before the present. Specifically, we might augment the set of events presented above with a fourth case:</p>
<div class="figure align-center" id="extinctionprob2">
<a class="reference internal image-reference" href="_images/BAMM_E_t.png"><img alt="_images/BAMM_E_t.png" src="_images/BAMM_E_t.png" style="width: 850px;" /></a>
</div>
<p>The heavy line in case (iv) represents a macroevolutionary rate regime that differs from the parent process. In the BAMM model, the rate at which new events occur is governed by a hierarchical Poisson distribution with rate <img class="math" src="_images/math/7327d24dc2d12421147d5944f0fc23e67753f1b0.png" alt="\Lambda"/> (the <code class="docutils literal"><span class="pre">eventRate</span></code> parameter as output by BAMM is the product of <img class="math" src="_images/math/7327d24dc2d12421147d5944f0fc23e67753f1b0.png" alt="\Lambda"/> and the total tree length). The probability of undergoing a rate shift is thus proportional to <img class="math" src="_images/math/7327d24dc2d12421147d5944f0fc23e67753f1b0.png" alt="\Lambda"/>, but the probability of future extinction is not easily computed, because we do not know the parameters of the new rate regime. Formally, we might imagine a term <img class="math" src="_images/math/b39932b8cbb311eeee9815738f6be3757737b2ff.png" alt="\Omega"/> that describes the probability of future extinction for a lineage that has unknown evolutionary rate parameters, thus modifying the equation <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> above to:</p>
<div class="math">
<p><img src="_images/math/7ddc12d99d0308bdf39b90bcd50dbe5c4a7c2edc.png" alt="\frac{dE}{dt} = \mu -(\lambda + \mu)E(t) + \lambda E(t)^2 + \Lambda \Omega"/></p>
</div><p>Thus, lineages shift to a new process on <img class="math" src="_images/math/5b4271afe7fc7c0ee84172e0ad19b82caf450c00.png" alt="\Delta t"/> with probability proportional to <img class="math" src="_images/math/7327d24dc2d12421147d5944f0fc23e67753f1b0.png" alt="\Lambda"/>, but then the process and all of its descendants go extinct before the present. Computing the probability <img class="math" src="_images/math/b39932b8cbb311eeee9815738f6be3757737b2ff.png" alt="\Omega"/> is, in our opinion, not feasible. One would have to integrate over the chance of extinction for all possible diversification histories, weighting each history by its relative probability. We have very little information about the universe of possible diversification histories (and even less about the relative probabilities of those histories), so it seems like this is a quantity that cannot be computed. One possible solution may be to use empirical parameterizations, perhaps estimating distributions of diversification histories from the fossil record (or potentially, other molecular phylogenetic studies).</p>
<p>We also suspect that the set of all processes (diversification shifts) that occurred but subsequently went extinct might be drawn from a different probability distribution than the set of processes that survived to the present to be observed. If this is true, then there is <strong>no possible information</strong> about <img class="math" src="_images/math/b39932b8cbb311eeee9815738f6be3757737b2ff.png" alt="\Omega"/> that can be gained from molecular phylogenies alone.</p>
<p>What is the difference between this model and BiSSE (or related models), where lineages can shift to other evolutionary rate regimes (e.g., alternative character states)? The difference is that, in BiSSE, the parameters of the process are fixed, but the locations of the transitions are unknown. Hence, the BiSSE likelihood involves integration over all possible transitions in diversification processes, but there are a finite set of such processes (2 for BiSSE), and the parameters of the processes are known. Computing <img class="math" src="_images/math/b39932b8cbb311eeee9815738f6be3757737b2ff.png" alt="\Omega"/> is not tractable, because we need to integrate over all possible transitions to processes with unknown parameters and which are drawn from unknown probability density functions.</p>
<p>But we should note again that this leads to a weird condition in the BAMM model, which was not clearly discussed in Rabosky&#8217;s <a class="reference external" href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0089543">(2014)</a> description of BAMM. In practical terms, the BAMM likelihood assumes that some lineages effectively <em>see into the future</em> and modify their event state space based on future outcomes: specifically, a lineage cannot undergo a rate shift if it is destined for extinction.</p>
<p><strong>Fortunately, we haven&#8217;t seen any evidence that this assumption has consequences for inference</strong>. Moreover, qualitatively similar assumptions are fairly widespread in the modeling of diversification and phenotypic evolution. For example, several methods are available that compute diversification histories on phylogenetic trees assuming a fixed-in-advance number of diversification shifts. The &#8220;split&#8221; class of models for state-dependent diversification (e.g., split BiSSE) would be one such example: the likelihood is computed under a model that presupposes a shift in diversification rates at a particular location on the tree, but the E(t) and D(t) calculations do not account for a stochastic process that could have generated shifts to other (potentially unknown, unobserved) diversification processes. In fact, any method of modeling diversification that allows heterogeneous extinction processes across the tree (e.g., MEDUSA) is formally making the same assumption as BAMM, because the models do not allow lineages destined for future extinction (the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> component of the likelihood) to undergo diversification rate shifts.</p>
<p>But I should be clear about my view that <strong>none of this is likely to matter in practice</strong>. And in any event, it&#8217;s testable. Just simulate data with rate shifts (some of which may lead to extinct clades in their entirety), and see if it has any consequences for inference about the set of processes inferred for the observed part of the tree. We&#8217;ve done this and have found no consequences for inference, but perhaps you&#8217;ll find something different.</p>
</div>
<div class="section" id="what-exactly-is-the-process-modeled-by-bamm">
<span id="whatprocess"></span><h2>11.3. What, exactly, is the process modeled by BAMM?<a class="headerlink" href="#what-exactly-is-the-process-modeled-by-bamm" title="Permalink to this headline">¶</a></h2>
<p>In this section, we describe the specific process that is being modeled by using the equations defined in the preceding section. We will focus on the simplest possible scenario, where a single lineage in a reconstructed phylogenetic tree is observed to have a single rate shift:</p>
<div class="figure align-center" id="shifttype0">
<a class="reference internal image-reference" href="_images/branch_history.png"><img alt="_images/branch_history.png" src="_images/branch_history.png" style="width: 400px;" /></a>
</div>
<p>In this trivial case, we have a single observed lineage with a mapped diversification history. We are concerned with a lineage in a reconstructed phylogenetic tree that begins at time <img class="math" src="_images/math/44780f0598b4d22c6888cfca27deb04115f7fa88.png" alt="t_1"/> and survives (with no other observed extant descendants) until time <img class="math" src="_images/math/6d42c88506b8da39a2a23653aecbfb7c29728063.png" alt="T"/>. Moreover, the mapped diversification history indicates that a diversification rate shift must have occurred on at least one lineage at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, during which diversification parameters for at least one lineage switched from the base rate (<img class="math" src="_images/math/a7ddd95fd452cb8a6f7d86629db24ebab27956f3.png" alt="\lambda_1 , \mu_1"/>) to a new set of rate parameters (<img class="math" src="_images/math/6152444cbb8b7092ff3eb21a0c9b6bc35776a285.png" alt="\lambda_2 , \mu_2"/>). For further reference, I label the segment <img class="math" src="_images/math/44780f0598b4d22c6888cfca27deb04115f7fa88.png" alt="t_1"/> to <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> as &#8220;A&#8221; and segment <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> to <img class="math" src="_images/math/6d42c88506b8da39a2a23653aecbfb7c29728063.png" alt="T"/> as &#8220;B&#8221;.</p>
<p>There are several evolutionary processes that are, in principle, consistent with the branch history shown above. Here is what we observe:</p>
<ul class="simple">
<li>A single lineage originated at time <img class="math" src="_images/math/44780f0598b4d22c6888cfca27deb04115f7fa88.png" alt="t_1"/>. We will assume that the observed branch history is bracketed by a speciation event at <img class="math" src="_images/math/44780f0598b4d22c6888cfca27deb04115f7fa88.png" alt="t_1"/>, as if it is a branch in a reconstructed phylogenetic tree.</li>
<li>The lineage survived to the present with only a single extant descendant</li>
<li>The diversification parameters of the reconstructed lineage switched from (<img class="math" src="_images/math/a7ddd95fd452cb8a6f7d86629db24ebab27956f3.png" alt="\lambda_1 , \mu_1"/>) to (<img class="math" src="_images/math/6152444cbb8b7092ff3eb21a0c9b6bc35776a285.png" alt="\lambda_2 , \mu_2"/>) at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> (this is assumed, since we are computing the probability of a branch with a <strong>fixed, mapped</strong> rate shift)</li>
</ul>
<p>Here are some scenarios that are potentially consistent with the single branch above:</p>
<div class="figure align-center" id="shifttype1">
<a class="reference internal image-reference" href="_images/shifttype_fig.001.png"><img alt="_images/shifttype_fig.001.png" src="_images/shifttype_fig.001.png" style="width: 600px;" /></a>
</div>
<p>In the <strong>Type 1</strong> shift scenario, a single lineage alive at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> is chosen at random to undergo a rate shift. The process then continues, but &#8211; if multiple lineages existed at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> &#8211; then the process contains a mixture of different types. If there are exactly <img class="math" src="_images/math/75e27f04188974063be3230dca208cd495b77ce1.png" alt="N"/> lineages alive immediately before time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, then at the time of the rate shift, exactly one lineage will have the new parameters (<img class="math" src="_images/math/6152444cbb8b7092ff3eb21a0c9b6bc35776a285.png" alt="\lambda_2 , \mu_2"/>), and the other <img class="math" src="_images/math/e0718d6bb305172ac0e31556c7253de1a9e16196.png" alt="N - 1"/> lineages will have the parameters of the parent process.</p>
<p>In the <strong>Type 2</strong> shift scenario, all lineages alive at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> undergo a simultaneous rate shift, but only a single lineage survives to be observed. In both cases, we require that the lineage that survives to the present include (in its history) the mapped (= assumed) diversification shift. Otherwise, we would be observing a lineage in the present day that had no rate shift.</p>
<p>We can imagine an additional type of shift-and-survival scenario, <strong>Type 3</strong>, where a single lineage undergoes a rate shift, but the lineage that survives to the present to be observed is not required to belong to the &#8220;shift&#8221; rate type. In other words, if the process survives to the present, it is not necessary that the surviving lineage be a descendant of the &#8220;rate shift&#8221; lineage. The <strong>Type 3</strong> scenario is still conditioning on the occurrence of a mapped diversification shift but not on the presence of the shift in the reconstructed tree.</p>
<p>To evaluate the likelihood equations that we have implemented in BAMM, we asked a simple question: does the equation for the extinction probability, <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/>, match the probability of lineage extinction for simulated instances of any of the three processes described above? To address this, we simulated lineage histories under each of the three scenarios described and tabulated the fraction of such simulations that went extinct before the present. We compared these <em>simulation-derived</em> extinction probabilities to the exact extinction probabilities computed using the analytical solution to the differential equation for <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> that is implemented in BAMM. R code for these simulations is provided as a downloadable file <a class="reference download internal" href="_downloads/BAMM_likelihood_analysis.R"><code class="xref download docutils literal"><span class="pre">here</span></code></a>.</p>
<p>There are at least two ways that have been used in the literature (and by other implementations at some point in their existence) to compute the likelihood of a branch such as this:</p>
<ul class="simple">
<li>BAMM passes previously-computed extinction probabilities down the tree, thus conditioning on the existence of mapped (observed) diversification shifts. BAMM initializes the calculation for <img class="math" src="_images/math/26f6e15f80413e8810c86d1c2c2977e08d547652.png" alt="E(t_1)"/> with the already-computed value for the previous segment (B), or <img class="math" src="_images/math/577f14a4bb66a8d8026fb45e972285ce5bd56ab8.png" alt="E(t_2)"/>. Thus, BAMM does not recompute the extinction probability on new branch segments. This calculation was described in Rabosky (<a class="reference external" href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0089543">2014, PLoS ONE</a>) and was originally (and is currently) implemented this way. We refer to this algorithm for handling extinction as <em>pass-down</em>, since values for <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> are computed by passing previously computed values rootwards down the tree.</li>
<li>An alternative approach is to compute the extinction probability <img class="math" src="_images/math/26f6e15f80413e8810c86d1c2c2977e08d547652.png" alt="E(t_1)"/> by ignoring the extinction probability computed for the process on interval B (<img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> to <img class="math" src="_images/math/6d42c88506b8da39a2a23653aecbfb7c29728063.png" alt="T"/>). The calculation for the <img class="math" src="_images/math/5559082e6cbf2a2c0a268996d21dd040015fc987.png" alt="t_2 - t_1"/> segment (A) is initialized by applying the parameter set for segment A (<img class="math" src="_images/math/a7ddd95fd452cb8a6f7d86629db24ebab27956f3.png" alt="\lambda_1 , \mu_1"/>) to the time interval B (<img class="math" src="_images/math/86f35815d96862a9ccbf2082a8ce64f95ced81cf.png" alt="t_2 - T"/>). Thus, for any given branch segment with distinct parameters, this approach recomputes the initial extinction probability for the branch segment (<img class="math" src="_images/math/c6c02b3859ec2c06dafdbbcfa45453b241a34e3f.png" alt="E(0)"/>). We refer to this algorithm as <em>recomputed</em>.</li>
</ul>
<p>Standard (non-split) BiSSE always recomputes <img class="math" src="_images/math/c6c02b3859ec2c06dafdbbcfa45453b241a34e3f.png" alt="E(0)"/>. This is technically correct for the BiSSE process, because BiSSE is integrating over all possible events that <em>could have led to an extinct clade</em> given that a lineage is in some particular character state at a particular point in time. However, this is not appropriate for the process modeled by BAMM (and other methods), because we are assuming the existence of a mapped diversification shift on a particular branch.</p>
<p>We simulated extinction probabilities under each of these 3 scenarios (Type 1, Type 2, and Type 3). We initialized each simulation with a single lineage and with parameters <img class="math" src="_images/math/18cbd415b1a8e3f19977c5d04d046d41c585c7de.png" alt="\lambda_1"/> and <img class="math" src="_images/math/41038e8492bc74bddee80ce7879e8528c27841b8.png" alt="\mu_1"/>. Then:</p>
<ul class="simple">
<li>For <strong>Type 1</strong> simulation: If the process is extant at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, a single lineage is chosen at random to shift to the new parameters. The process is said to become extinct if all descendants of the &#8220;shift&#8221; lineage go extinct before the present.</li>
<li>For <strong>Type 2</strong> simulation: If the process is extant at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, all lineages still alive at that time undergo a simultaneous shift in rates to the new parameters. The process becomes extinct if all lineages have become extinct before the present.</li>
<li>For <strong>Type 3</strong> simulation: If the process is extant at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, a single lineage is chosen at random to shift to the new parameters. The process is said to become extinct only if all lineages become extinct. Thus, all descendants of the original lineage alive at time <img class="math" src="_images/math/44780f0598b4d22c6888cfca27deb04115f7fa88.png" alt="t_1"/> must die out for the process to become extinct.</li>
</ul>
<p>The results presented below do not depend on the specific distributions from which the rate parameters are drawn. Nor should they: if the <em>recomputed</em> and/or <em>pass-down</em> (BAMM) implementations are mathematically correct, it will make no difference what parameter values are used: the extinction probabilities will match precisely the simulated expectation.</p>
<p>This figure shows the relationship between the BAMM/pass-down extinction probabilities and the simulated extinction probabilities for the three scenarios (R code for simulations and figures is <a class="reference download internal" href="_downloads/BAMM_likelihood_analysis.R"><code class="xref download docutils literal"><span class="pre">here</span></code></a>):</p>
<div class="figure align-center" id="bammeprobs">
<a class="reference internal image-reference" href="_images/x_extinctionprobs_bamm.png"><img alt="_images/x_extinctionprobs_bamm.png" src="_images/x_extinctionprobs_bamm.png" style="width: 600px;" /></a>
</div>
<p>We see that BAMM extinction probabilities are identical to those simulated under the Type 2 shift scenario. The Type 1 and Type 3 scenarios, in which a single lineage is sampled at random to undergo a rate shift, do not yield identical extinction probabilities to that computed by BAMM. However, the computation with <em>recomputing</em> performs substantially worse than BAMM, and the resulting extinction probabilities are largely uncorrelated with the true value:</p>
<div class="figure align-center" id="recomputedeprobs">
<a class="reference internal image-reference" href="_images/x_extinctionprobs_recomputed.png"><img alt="_images/x_extinctionprobs_recomputed.png" src="_images/x_extinctionprobs_recomputed.png" style="width: 600px;" /></a>
</div>
<p>This is an important exercise, because it clarifies to us that the assumptions of BAMM are slightly different from what we originally assumed (at the time of BAMM&#8217;s release, I would have naively assumed that the equations corresponded to a Type I scenario). In any event, these scenarios may effectively be identical in practice. Specifically, for a shift on a single branch, the scenarios we are modeling with BAMM include the following:</p>
<ul class="simple">
<li>S1: No speciation before the rate shift; lineage undergoes shift; one or more descendant lineages survive to the present.</li>
<li>S2: Speciation on time interval (<img class="math" src="_images/math/5c5f3e7e542a9b57504b1be123646e2bc98d70af.png" alt="t_1, t_2"/>), and all lineages extant at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/> undergo a rate shift. However, all but one of these lineages originating at this point in time go extinct before the present.</li>
</ul>
<p>Here is a figure illustrating possible realizations of these scenarios, for the case where a rate shift is mapped to a single branch and leaves a clade with three extant descendants.</p>
<div class="figure align-center" id="shiftscenario">
<a class="reference internal image-reference" href="_images/shifttype_fig_true.png"><img alt="_images/shifttype_fig_true.png" src="_images/shifttype_fig_true.png" style="width: 450px;" /></a>
</div>
<p>If extinction probabilities are <em>recomputed</em>, the calculations are failing to condition on the existence of a known ( = assumed) rate shift at a particular point in time. In the toy example above, we are computing the likelihood of a rate shift assuming a shift happened at time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>. If we recompute <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> after we move rootwards past this event, then extinction probabilities will be incorrect. A lineage on the interval time <img class="math" src="_images/math/d10f8539c41212be5986c5f7a3da82270eecbdac.png" alt="t_1 - t_2"/> has a probability of extinction that must be conditioned on the fact that, if it survives to time <img class="math" src="_images/math/c4a5e7418ac67584c9e6586936fcaf49afe6cb1e.png" alt="t_2"/>, a rate shift will occur that may make it more or less likely to go extinct.</p>
<p>This brings us to our next challenge: how to combine <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at nodes when the descendant lineages have different shift histories (e.g., they are <em>of different types</em>)? This problem cannot be decoupled from the issue of recomputing.</p>
</div>
<div class="section" id="extinction-calculations-at-nodes">
<span id="extinctionnodes"></span><h2>11.4. Extinction calculations at nodes<a class="headerlink" href="#extinction-calculations-at-nodes" title="Permalink to this headline">¶</a></h2>
<p>In BiSSE and related models, the extinction probabilities <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> at internal nodes are always identical for a given character state. The occurrence of a speciation event does not change the probability of extinction for a lineage in the i&#8217;th character state. That is, if a speciation event happens at time <img class="math" src="_images/math/ef9270877405055756d345facd044e4ab297f858.png" alt="t"/>, and if a lineage is in state <cite>i</cite>, the probability of extinction after some infinitesimal interval before the speciation event <img class="math" src="_images/math/09e6422b9e5a61db6f9571c9bf23d2c474638fde.png" alt="E_i(t - \Delta t)"/> will be very similar to the probability of extinction after the speciation event <img class="math" src="_images/math/3711fb1aa819c0804e2cb8846a88ee9396e055f6.png" alt="E_i(t + \Delta t)"/>. This is because the <img class="math" src="_images/math/69a0ce0964aea5cd18e2bc4083ad7ba4f76b4e4b.png" alt="E_i(t)"/> term integrates over all diversification histories that <em>could have occurred while yielding an extinct clade</em> given that the lineage is currently (at time <img class="math" src="_images/math/ef9270877405055756d345facd044e4ab297f858.png" alt="t"/>) in state <img class="math" src="_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png" alt="i"/>.</p>
<p>However, BAMM must deal with the scenario where the extinction probabilities at internal nodes differ on the right and left descendant branches, which we will denote by <img class="math" src="_images/math/ee028b17f6b60f0b17d992ae7bef7bd48ac0c44c.png" alt="E_{R}(t)"/> and <img class="math" src="_images/math/c4dc6f8d0e0c5dc24f4c380992e0ab824a355557.png" alt="E_{L}(t)"/>. For a given internal node, it is possible that <img class="math" src="_images/math/ee028b17f6b60f0b17d992ae7bef7bd48ac0c44c.png" alt="E_{R}(t)"/> and <img class="math" src="_images/math/c4dc6f8d0e0c5dc24f4c380992e0ab824a355557.png" alt="E_{L}(t)"/> will not be equal if there is a rate shift on the right, left, or both descendant branches (or any of their descendant lineages). We thus need to condition our <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> calculations on the occurrence of a rate shift.</p>
<p>This issue is relevant to all models that purport to compute the likelihood of a rate shift on a phylogenetic tree when <img class="math" src="_images/math/c4abec0ec221aa2d5afc1b5518e4154a9f6a47e6.png" alt="\mu &gt; 0"/>. We do not know how all other modeling frameworks handle the scenario where <img class="math" src="_images/math/ee028b17f6b60f0b17d992ae7bef7bd48ac0c44c.png" alt="E_{R}(t)"/> and <img class="math" src="_images/math/c4dc6f8d0e0c5dc24f4c380992e0ab824a355557.png" alt="E_{L}(t)"/> are different (at the time of this writing, there are at least 3 different ways that the implementations listed above deal with this). Our approach in BAMM is the following:</p>
<ul class="simple">
<li>If the right and left branches are identical in diversification history (no shifts occur anywhere on any downstream branches), <img class="math" src="_images/math/c236347d021771f1b0f86f9464694b9a1c108932.png" alt="E_{L}(t) = E_{R}(t)"/> and there is no need to condition the extinction probability on the occurrence of any rate shifts. The initial extinction probability on the parent branch is equal to the value at the end of (either) descendant branch.</li>
<li>If the right and left branches are <strong>not</strong> identical in diversification history (e.g., at least one rate shift occurs somewhere downstream, such that <img class="math" src="_images/math/63d2e9dc1fc2dcae2ff52ceaf43827b8f257284e.png" alt="E_{L}(t) \neq  E_{R}(t)"/>), we set the initial extinction probability at the start of the branch upstream of the node equal to <img class="math" src="_images/math/fadb678bc317f8e5a0c387849cab737a50c5a895.png" alt="E_{R}(t) E_{L}(t)"/>.</li>
</ul>
<p>We cannot guarantee that this is the optimal way of handling this issue, but to our knowledge, there has been no exploration of the <em>correct</em> way to deal with <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at nodes under a diversification process with rate shifts and <img class="math" src="_images/math/c4abec0ec221aa2d5afc1b5518e4154a9f6a47e6.png" alt="\mu &gt; 0"/>. In any event, we continue to find that BAMM generally does a reasonable job of inferring speciation and extinction rates when data are simulated under multi-rate diversification processes, which suggests that this method for handling <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> calculations leads to something that provides at least a close approximation to the true probability.</p>
<p>However, prior to October 2015, BAMM handled the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> calculations at nodes by arbitrarily designating one descendant lineage as representing the parent process, and simply ignoring the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> value for the other branch. <strong>This modification has the potential to impact results obtained with BAMM</strong>. In the cetacean example dataset, we find weaker support for a rate shift after incorporating this change.</p>
<p>This is not to say that results obtained with older versions of BAMM are incorrect, but our simulations and analysis have convinced us that the current algorithm performs better on average. We have provided users with the option of specifying how these extinction probabilities should be handled at nodes. The default (which you thus do not need to specify), can be set (in the control file or at the command line) with the option:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="s">&quot;if_different&quot;</span>
</pre></div>
</div>
<p>However, if you want to handle these calculations exactly as they were handled with the previous version of BAMM (&lt; v2.5), you can specify:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="s">&quot;left&quot;</span>
</pre></div>
</div>
<div class="section" id="why-extinction-handling-at-nodes-matters">
<h3>11.4.1. Why extinction handling at nodes matters<a class="headerlink" href="#why-extinction-handling-at-nodes-matters" title="Permalink to this headline">¶</a></h3>
<p>Here is a simple example to illustrate how extinction handling at nodes can exert a major influence on tree likelihoods. Consider the following 4-taxon phylogenetic tree, with two mapped rate shifts:</p>
<div class="figure align-center" id="fourtaxon1">
<a class="reference internal image-reference" href="_images/x_tree_extinction.png"><img alt="_images/x_tree_extinction.png" src="_images/x_tree_extinction.png" style="width: 500px;" /></a>
</div>
<p>Here, we have separate rate shifts (black circles) on lineages leading to taxon A and taxon C. The backbone of the tree, plus lineages B and D, are governed by the <em>parent process</em>, which begins at the root. There are thus 3 distinct shift regimes on this tree: the lineage A regime, lineage C regime, and the root regime.</p>
<p>Consider the following parameterization for these regimes:</p>
<ul class="simple">
<li>Root regime: Very high extinction and very high speciation</li>
<li>Lineage A regime: no extinction</li>
<li>Lineage C regime: no extinction</li>
</ul>
<p>Suppose we handle the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at nodes by always favoring the root regime value. Thus, our calculation at the rootward side of node AB would begin with the value obtained at the rootward end of the branch segment leading to lineage B, and our calculation on the rootward side of CD would begin with the value from lineage D (as both B and D are governed entirely by the root regime). Given the parameterization defined above, the true probability of extinction of the process can be low: a lineage that begins at the root only has to survive a relatively short period of time until a rate shift is assumed to happen. <strong>Because the shift parameters (lineage A and C regimes) have zero extinction, the process is assured to survive to the present if it survives to the time of the shift.</strong></p>
<p>However, by not conditioning on these shifts, our calculated extinction probabilities for the tree can be arbitrarily close to 1. Under the parameterization above, we will compute very high extinction probabilities for the tree as a whole, because the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at the rootwards end of each basal branch will approach 1.0. This is because those values will have been computed as the probability that a lineage in the root state goes extinct before the present, which could be very high, since we ignore the shifts occurring on lineages A and C. In fact, simply by making those basal branches arbitrarily small and/or increasing speciation and extinction rates on the root regime, we can make the (computed) tree extinction probability close to 1 despite the fact that multiple shifts have occurred that would make true extinction of such a process unlikely.</p>
<p>To see how this would affect our likelihoods, consider the effects of conditioning such a process on survival to the present: you divide the likelihood by the probability of survival of the left and right descendant branches, which &#8211; as the computed <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> approaches 1 &#8211; can lead to tree likelihoods that approach infinity. <strong>But this appears to be a result of not conditioning our calculations on the occurrence of downstream rate shifts that render survival of the process much more likely.</strong> We&#8217;ve found that this issue can lead to severely biased likelihoods, and the effect on the likelihood is not limited to conditioning on tree survival.</p>
<p>This issue is relevant to the issue of recomputing <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values raised in the preceding section. If the initial <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values for every branch are recomputed using the current parameter values, we run into the same problem illustrated here: extinction probabilities <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> will not be conditioned on the assumed shift configuration.</p>
</div>
<div class="section" id="extinction-at-nodes-a-worked-example">
<h3>11.4.2. Extinction at nodes: a worked example<a class="headerlink" href="#extinction-at-nodes-a-worked-example" title="Permalink to this headline">¶</a></h3>
<p>I have attached some R code <a class="reference download internal" href="_downloads/combine_extinction_nodes.R"><code class="xref download docutils literal"><span class="pre">here</span></code></a> that illustrates very substantial differences in results that can be obtained for simple 2-taxon and 4-taxon trees, depending on how these <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values are handled at nodes. In the simplest 2-taxon example (single speciation event, plus a stem lineage), the tree is this:</p>
<div class="highlight-python"><div class="highlight"><pre>(A:99,B:99):1
</pre></div>
</div>
<p>We will assume that a rate shift happened <em>immediately</em> after the origin of lineage A, such that the entire A branch has its own set of rate parameters. Lineage B diversifies under the root parameters. Clearly, this is an evolutionary process that has not done very much: there is a single speciation event, the clade only has two taxa, and the process is old (100 time units). Our intuition should tell us that the most likely diversification parameters for this scenario should favor a net diversification rate of approximately zero. We can put some numbers on this intuition by noting that any variant of simple constant-rate birth-death estimators will give us very low estimates for net diversification for this process (<img class="math" src="_images/math/726eb8a886219cab7f964ad9c589096300b18133.png" alt="N = 2"/>, <img class="math" src="_images/math/e63478a45c1bc0e3902039db215d4cf50ddb971e.png" alt="age = 100"/>).</p>
<p>We will compute the likelihood of this tree, conditioning on survival of the process to the present, under two methods of combining <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at nodes:</p>
<ul class="simple">
<li>By multiplying them together, as recommended above</li>
<li>By arbitrarily choosing the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> value for a single lineage, specifically the one that corresponds to the parent (root) process</li>
</ul>
<p>We will assume that the root speciation rate is <img class="math" src="_images/math/56cda989f60a79690229b8a8f3708f6646d4be3a.png" alt="\lambda = 0.5"/>, that the process undergoes a single speciation event, and that the progeny lineage labelled <em>A</em> immediately shifts to an <em>inert</em> diversification state (<img class="math" src="_images/math/194f0b0dd3067d0252a08d5619fb4b4748b2c322.png" alt="\lambda = 0, \mu = 0"/>). The probability of the inert branch is thus 1, since we assume that neither speciation nor extinction can change the probability of the data (which is initialized at <img class="math" src="_images/math/e6f2dbef0591f47817d0c16cb72596ca1b6db29b.png" alt="D(0) = 1"/>).</p>
<p>In the figure below, we show the log-likelihood of this tree as a function of <img class="math" src="_images/math/126e84ba38f7dece5f0ad64e929b9588b20f6440.png" alt="\mu"/> (again, assuming that <img class="math" src="_images/math/56cda989f60a79690229b8a8f3708f6646d4be3a.png" alt="\lambda = 0.5"/>), under the two methods for combining <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values. <strong>Results for the &#8220;multiply&#8221; algorithm are shown in red, and results for the &#8220;arbitrary&#8221; algorithm are shown in blue</strong>.</p>
<div class="figure align-center" id="nodecombine">
<a class="reference internal image-reference" href="_images/likelihood_nodecombine.png"><img alt="_images/likelihood_nodecombine.png" src="_images/likelihood_nodecombine.png" style="width: 450px;" /></a>
</div>
<p>When <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values are multiplied together, the likelihood surface has a single peak (<strong>red curve</strong>) corresponding roughly to <img class="math" src="_images/math/518b200ae22687ae9f3c434a11aa3a30020b246c.png" alt="\lambda = \mu"/>, which is essentially what we should expect from this model. However, something very different happens for the <em>arbitrary</em> scenario (<strong>blue curve</strong>), where we assume that <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> on the basal branch segment is computed with parameters of the parent (root) process. Here, the log-likelihood becomes increasingly large with <img class="math" src="_images/math/4036a39c547079017829ccb75d6ea08c2dfeca7a.png" alt="\mu &gt; \lambda"/>, and the log-likelihoods suggest that net diversification has been (substantially) negative. I suspect that the likelihood of the tree under this algorithm will increase indefinitely with increasing <img class="math" src="_images/math/126e84ba38f7dece5f0ad64e929b9588b20f6440.png" alt="\mu"/>, but the calculations fail for numerical reasons at approximately <img class="math" src="_images/math/78734cba833be7aa8a2974f73286660fb27fa251.png" alt="\mu = 0.85"/> (the numerical reason being that the computed extinction probability at the root is equal to 1.0 within the limits of machine epsilon). The wobbly bit in the blue curve with high extinction also appears to be due to rounding issues.</p>
<p>For the two taxon tree, we conclude the following:</p>
<ul class="simple">
<li>Treating <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at nodes by <em>arbitrarily favoring the parent process</em> leads to substantial differences in likelihoods and parameters, relative to the case when <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values are multiplied together.</li>
<li>The likelihood for the case where <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values are multiplied together shows good behavior, or at least accords with our intuition for a birth-death process where <em>not much happens</em> over the duration of the process.</li>
<li>The parameters estimated under the <em>arbitrary</em> <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> handling are strange: the likelihood surface appears to favor increasingly high rates of extinction relative to speciation.</li>
</ul>
<p>I believe that the likelihood obtained if you initialize <img class="math" src="_images/math/c6c02b3859ec2c06dafdbbcfa45453b241a34e3f.png" alt="E(0)"/> calculations for branch segments with values for the parent / root process leads to theoretically invalid likelihoods, and &#8211; at least in this case &#8211; it appears to be due to conditioning on non-extinction of the process. After all, if we know that a speciation event generated an <em>inert</em> lineage at <img class="math" src="_images/math/45a61cd273ad73925fc0b386ea68f70b0c6d3333.png" alt="t = 1"/> time units into the process, the true probability of extinction should be low. But by favoring the parent process, we condition using extinction probabilities at the root that are arbitrarily close to 1.</p>
<p>The R code linked <a class="reference download internal" href="_downloads/combine_extinction_nodes.R"><code class="xref download docutils literal"><span class="pre">above</span></code></a> also augments this exercise for a 4 taxon tree (showing this is not specific to the stem clade described here), and also compares likelihoods to those obtained for a constant-rate birth-death process with no shifts.</p>
<p>The results above suggest that arbitrary inheritance of <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values through nodes, or recomputing <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> values at the start of internal branches, probably does not yield valid likelihoods.</p>
</div>
</div>
<div class="section" id="theoretical-issues-for-rate-shift-models">
<span id="otherissues"></span><h2>11.5. Theoretical issues for rate shift models<a class="headerlink" href="#theoretical-issues-for-rate-shift-models" title="Permalink to this headline">¶</a></h2>
<p>This section is just to raise some theoretical concerns with multi-type branching processes as applied to phylogenetic trees. In particular, while many researchers are now using or developing these methods, there are a number of issues that could benefit from additional theoretical attention:</p>
<ul class="simple">
<li>All methods of which we are aware that compute the likelihood of a fixed configuration of rate shifts on phylogenetic trees (with the potential for extinction) assume that diversification shifts <strong>do not happen</strong> on branches that are unobserved (or that go extinct before the present). We have found no evidence that this is a problem for empirical inference, but are there any conditions under which we should be concerned about this?</li>
<li>How should <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> calculations at nodes be handled? We have found that the current approach used by BAMM performs well (and we&#8217;ve compared this approach to alternatives, such as the arbitrary approach described above), but we acknowledge that theoretical justification for our handling of it is lacking.</li>
<li>We do not know how to simulate the extinction probability <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> for an entire diversification history as applied to a phylogenetic tree. The simulations described above are straightforward for single branches, but we have been unable to identify a simulation algorithm that can exactly reproduce the extinction probability for an entire process (e.g., a full tree with mapped rate shifts) as computed for any models that purport to compute the likelihood of a phylogenetic tree under under a fixed configuration of diversification rate shifts.</li>
<li>Other methods described above that assume rate shifts happen at particular nodes are <em>probably</em> assuming something similar to the <strong>Type 2</strong> scenario described <a class="reference internal" href="#whatprocess"><span>here</span></a>. However, can we identify a set of (numerically or analytically) tractable differential equations that correspond to the <strong>Type 1</strong> process described <a class="reference internal" href="#shifttype1"><span>here</span></a>?</li>
</ul>
</div>
<div class="section" id="is-the-bamm-likelihood-computed-correctly">
<span id="testlikelihood"></span><h2>11.6. Is the BAMM likelihood computed correctly?<a class="headerlink" href="#is-the-bamm-likelihood-computed-correctly" title="Permalink to this headline">¶</a></h2>
<p>Given the model and its assumptions (see above), we now turn to a different question: is BAMM correctly computing the likelihood of the process described above? As an independent test of this, we implemented the BAMM likelihood function in R (BAMMtools v2.1) and have created a tool that enables users to test whether BAMM is doing what it is supposed to be doing. This assumes, of course, that we have also implemented the likelihood function correctly in R, but we hope that other researchers find it easier to evaluate our R code than the BAMM C++ code itself.</p>
<p>The function <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> will return the log-likelihood for a given configuration of events (and associated parameters) on a phylogenetic tree. Let&#8217;s do this using the built-in whales dataset in BAMMtools:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">library</span><span class="p">(</span><span class="n">BAMMtools</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
</pre></div>
</div>
<p>We need to make sure we are considering precisely the same generations for the mcmc file as for the event data file, so we will get the intersection of these and just take 50 of them for some representative calculations:</p>
<div class="highlight-python"><div class="highlight"><pre>iset &lt;- intersect(mcmc.whales$generation, events.whales$generation)
iset &lt;- iset[round(seq(1, length(iset), length.out=50))]
events &lt;- events.whales[events.whales$generation %in% iset, ]
mcmc &lt;-  mcmc.whales[mcmc.whales$generation %in% iset, ]
</pre></div>
</div>
<p>We also need to ensure that we use exactly the same <code class="docutils literal"><span class="pre">segLength</span></code> parameter for these calculations that were used for the BAMM analysis (see <a class="reference internal" href="#numericalapprox"><span>here</span></a> for more info on this), as well as the same global sampling fraction (the included whales dataset was run with a sampling fraction of 0.98). Now we compute the likelihood of the final generation:</p>
<div class="highlight-python"><div class="highlight"><pre>BAMMlikelihood(whales, events.whales, gen=&quot;last&quot;, segLength = 0.02, sf = 0.98)
# which returns:
        [1] -272.6831

mcmc$logLik[nrow(mcmc)]
# which returns:
        [1] -272.683
</pre></div>
</div>
<p>So, close &#8211; but are they close enough? Let&#8217;s do 50 samples:</p>
<div class="highlight-python"><div class="highlight"><pre>rloglik &lt;- BAMMlikelihood(whales, events, gen = &quot;all&quot;, segLength = 0.02, sf = 0.98)
plot(mcmc$logLik ~ rloglik)
lines(x=c(-350,-250), y=c(-350, -250), lwd=1, col=&#39;red&#39;)
</pre></div>
</div>
<p>These should look precisely identical (please let us know if for some reason they appear to be different!). We can look at the average and maximum differences between these values:</p>
<div class="highlight-python"><div class="highlight"><pre>mean(abs(rloglik - mcmc$logLik))
# which returns:
        [1] 0.0002952669
max(abs(rloglik - mcmc$logLik))
# which returns:
        [1] 0.0005066073
</pre></div>
</div>
<p>With this set of 50 samples, we see that the maximum difference between likelihoods computed by BAMM and by an independent R implementation is a very small number, which suggests that BAMM is doing what it should be doing. Again, this assumes that the R implementation is also correct &#8211; e.g., that we haven&#8217;t just re-implemented a set of incorrect equations into R. As one additional test, we will compute the likelihoods of a phylogeny using another implementation of the birth-death process. We will use Rich FitzJohn&#8217;s excellent <a class="reference external" href="http://onlinelibrary.wiley.com/doi/10.1111/j.2041-210X.2012.00234.x/abstract">diversitree</a> package for this. The likelihoods in diversitree and BAMM aren&#8217;t exactly identical, because the diversitree log-likelihoods include a constant term <code class="docutils literal"><span class="pre">sum(log(2:(N</span> <span class="pre">-</span> <span class="pre">1)))</span></code>, where N is the number of tips in the tree. However, since all diversitree log-likelihoods contain this term (it is a constant that depends solely on the number of tips in the tree), we can merely subtract it to attain the BAMM likelihood (for the constant rate process):</p>
<div class="highlight-python"><div class="highlight"><pre>library(diversitree)
lfx &lt;- make.bd(whales)
constant &lt;- sum(log(2:(Ntip(whales) - 1)))
parvec1 &lt;- c(0.1, 0.05)
names(parvec1) &lt;- c(&quot;lambda&quot;, &quot;mu&quot;)

# the diversitree log-likelihood, minus the constant term
lfx(parvec1) - constant
        [1] -282.386

# BAMM log-likelihood for the same parameters:
BAMMlikelihood(whales, parvec1)
        [1] -282.386

# Another parameter set:
parvec2 &lt;- c(0.5, 0.49)
names(parvec2) &lt;- c(&quot;lambda&quot;, &quot;mu&quot;)

# here&#39;s the diversitree log-likelihood, minus the constant term
lfx(parvec2) - constant # diversitree log-likelihood
        [1] -312.8122

# The BAMM log-likelihood:
BAMMlikelihood(whales, parvec2)
        [1] -312.8122
</pre></div>
</div>
<p>Although the diversitree functions do not (at present) allow us to compute the likelihood of a multi-process model (e.g., a BAMM event configuration with <img class="math" src="_images/math/ed30a36cf8fc762b6f8ce2be32037e4fb3e0c0ad.png" alt="\geq"/> 1 rate shift), we can verify that BAMM, diversitree, and the <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> function from BAMMtools compute precisely the same log-likelihood for a given parameterization of the constant-rate birth-death process.</p>
<p>While we are at it, this function also allows us to estimate how much slower BAMM would be if it performed calculations in R with no calls to underlying C++ or C code. On my machine, it takes approximately 0.175 seconds to perform a single likelihood calculation (for the whales data) using the <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> function. For comparison, I can do approximately 10,000 generations of MCMC simulation on the same dataset per second, and the likelihood computation itself is (very conservatively) 20% of the total computation time required to execute a single generation of MCMC sampling (thus, 80% of the time BAMM is running, it is doing something other than computing the likelihood).</p>
<p>Using these (very rough) numbers, I estimate that BAMM can do 10,000 / 0.2 = 50,000 likelihood calculations per second. Dividing this number by the time to compute the likelihood in R, we get 50,000 / 0.175 <img class="math" src="_images/math/0605c9e832553cfc28dd71bab914ce3b5ec98756.png" alt="\approx"/> 280000. So, the likelihood computation using BAMM&#8217;s C++ implementation is (very) approximately 5 orders of magnitude faster than a pure R-based implementation would be for a tree of this size.</p>
</div>
<div class="section" id="numerical-approximations-in-bamm">
<span id="numericalapprox"></span><h2>11.7. Numerical approximations in BAMM<a class="headerlink" href="#numerical-approximations-in-bamm" title="Permalink to this headline">¶</a></h2>
<p>BAMM makes several numerical approximations that we will state here explicitly.</p>
<div class="section" id="discretization-of-evolutionary-rates-for-the-time-varying-process">
<h3>11.7.1. Discretization of evolutionary rates for the time-varying process<a class="headerlink" href="#discretization-of-evolutionary-rates-for-the-time-varying-process" title="Permalink to this headline">¶</a></h3>
<p>BAMM uses a &#8220;fast&#8221; form of numerical integration where branches of a phylogeny are broken into segments of relative length <code class="docutils literal"><span class="pre">segLength</span></code> and a constant-rate birth-death process is assumed on each interval. Thus, for a time-varying diversification process, we discretize the exponential change process into units defined by <code class="docutils literal"><span class="pre">segLength</span></code>. This allows for much faster calculations relative to more accurate forms of numerical integration. To be clear, the likelihood itself is not approximated: it is the rates that are approximated (which may, in turn, affect the likelihood). In any event, the consequences of this are easy to test. Here, we will use the functions and data from <a class="reference internal" href="#testlikelihood"><span>this section</span></a> and explore the consequences of <code class="docutils literal"><span class="pre">segLength</span></code>.</p>
<p>If the segment size is greater than the length of a given branch, BAMM will treat the branch as a single segment (e.g., a mean value for <img class="math" src="_images/math/1ab0134b6e0837594649c75a2ed83cfd85a2d03d.png" alt="\lambda"/> and <img class="math" src="_images/math/126e84ba38f7dece5f0ad64e929b9588b20f6440.png" alt="\mu"/> will be computed for the branch, and they will be passed to the speciation-extinction equations for the constant-rate birth-death process). If <code class="docutils literal"><span class="pre">segLength</span> <span class="pre">=</span> <span class="pre">1.0</span></code>, then no splitting will occur on any branches: mean rates will be computed for each branch. If <code class="docutils literal"><span class="pre">segLength</span> <span class="pre">=</span> <span class="pre">0.02</span></code>, branches will be split into segments with length equal to 2% of the crown depth of the tree. Here are some comparisons:</p>
<div class="highlight-python"><div class="highlight"><pre># the coarsest possible discretization:
BAMMlikelihood(whales, events, gen = &quot;last&quot;, segLength = 1, sf = 0.98)
        [1] -276.7793

# getting finer
BAMMlikelihood(whales, events, gen = &quot;last&quot;, segLength = 0.1, sf = 0.98)
        [1] -272.7604

# the default value (BAMM v 2.5)
BAMMlikelihood(whales, events, gen = &quot;last&quot;, segLength = 0.02, sf = 0.98)
        [1] -272.6831

# and a very fine partitioning:
BAMMlikelihood(whales, events, gen = &quot;last&quot;, segLength = 0.0001, sf = 0.98)
        [1] -272.6776
</pre></div>
</div>
<p>Despite the 200-fold difference in the grain (0.02 v 0.001), the difference in log-likelihoods is marginal (<img class="math" src="_images/math/0605c9e832553cfc28dd71bab914ce3b5ec98756.png" alt="\approx"/> 0.037), and it comes at a significant computational cost (approximately 200x increase in the number of operations required to compute the likelihood). Please let us know if you find that any inferences are affected by use of the defaults for <code class="docutils literal"><span class="pre">segLength</span></code>.</p>
<p>For a set of time-homogeneous diversification processes, e.g., <img class="math" src="_images/math/03707bb66bb96a8f49c65cdb4fb609d321e3840f.png" alt="\lambda_i(t) = \lambda_i"/> and <img class="math" src="_images/math/5f1cfba9ca9d10d26258641e0a48d22b414c43b6.png" alt="\mu_i(t) = \mu_i"/>, the BAMM likelihood will be exact. <code class="docutils literal"><span class="pre">segLength</span></code> will only influence the calculations when rates vary as a continuous function of time.</p>
</div>
<div class="section" id="maximum-possible-extinction-probability">
<h3>11.7.2. Maximum possible extinction probability<a class="headerlink" href="#maximum-possible-extinction-probability" title="Permalink to this headline">¶</a></h3>
<p>Some parameter values may lead to extinction probabilities that are sufficiently close to 1.0 that they are subject to numerical underflow/overflow issues. Specifically, if the <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> equations described above take a value that is numerically indistinguishable from 1, the likelihood of the data will be <img class="math" src="_images/math/aa451b2e35255229ee2d4ec55b492d3a06e25638.png" alt="-\infty"/>. To ensure that this rejection is platform independent, BAMM automatically rejects any moves (by setting the log-likelihood equal to -INF) where the extinction probability exceeds a predetermined threshold value. This threshold is <code class="docutils literal"><span class="pre">extinctionProbMax</span></code> and can be set manually in the control file. Note that this is not the extinction rate: it is the maximum permitted value of <img class="math" src="_images/math/a4fc1ca8d5e77bf02fca6cad6600471b37079b27.png" alt="E(t)"/> in the differential equations above, or the probability that a lineage at some time (along with all of its descendants) has gone extinct before the present).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="mc3.html" title="12. Metropolis coupled Markov chain Monte Carlo [(MC)3]"
             >next</a></li>
        <li class="right" >
          <a href="faq.html" title="10. Frequently Asked Questions"
             >previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b3+.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>