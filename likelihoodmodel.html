<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>12. The BAMM likelihood function &#8212; bamm 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13. Is BAMM reliable? A DIY approach" href="testingbamm.html" />
    <link rel="prev" title="11. Frequently Asked Questions" href="faq.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="testingbamm.html" title="13. Is BAMM reliable? A DIY approach"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="faq.html" title="11. Frequently Asked Questions"
             accesskey="P">previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">12. The BAMM likelihood function</a><ul>
<li><a class="reference internal" href="#overview">12.1. Overview</a></li>
<li><a class="reference internal" href="#is-the-bamm-likelihood-computed-correctly">12.2. Is the BAMM likelihood computed correctly?</a></li>
<li><a class="reference internal" href="#numerical-approximations-in-bamm">12.3. Numerical approximations in BAMM</a><ul>
<li><a class="reference internal" href="#discretization-of-evolutionary-rates-for-the-time-varying-process">12.3.1. Discretization of evolutionary rates for the time-varying process</a></li>
<li><a class="reference internal" href="#maximum-possible-extinction-probability">12.3.2. Maximum possible extinction probability</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="faq.html"
                        title="previous chapter">11. Frequently Asked Questions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="testingbamm.html"
                        title="next chapter">13. Is BAMM reliable? A DIY approach</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/likelihoodmodel.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-bamm-likelihood-function">
<span id="likelihood"></span><h1>12. The BAMM likelihood function<a class="headerlink" href="#the-bamm-likelihood-function" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>12.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This page previously discussed a number of important theoretical issues involving BAMM. We have now published a comprehensive explanation of the likelihood calculations in BAMM. See our recent <a class="reference download internal" href="_downloads/Rabosky_etal_SystematicBiology_2017.pdf" download=""><code class="xref download docutils literal"><span class="pre">Systematic</span> <span class="pre">Biology</span></code></a> article and especially Sections 2.4 - 2.5 from the <a class="reference download internal" href="_downloads/SupplementaryMaterial_BAMM_Text&Figures.pdf" download=""><code class="xref download docutils literal"><span class="pre">Supplementary</span> <span class="pre">Information</span></code></a> for a detailed explanation of the BAMM likelihood function and its assumptions.</p>
</div>
<div class="section" id="is-the-bamm-likelihood-computed-correctly">
<span id="testlikelihood"></span><h2>12.2. Is the BAMM likelihood computed correctly?<a class="headerlink" href="#is-the-bamm-likelihood-computed-correctly" title="Permalink to this headline">¶</a></h2>
<p>Given the model and its assumptions (see above), we now turn to a different question: is BAMM correctly computing the likelihood of the process described above? As an independent test of this, we implemented the BAMM likelihood function in R (BAMMtools v2.1) and have created a tool that enables users to test whether BAMM is doing what it is supposed to be doing. This assumes, of course, that we have also implemented the likelihood function correctly in R, but we hope that other researchers find it easier to evaluate our R code than the BAMM C++ code itself.</p>
<p>The function <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> will return the log-likelihood for a given configuration of events (and associated parameters) on a phylogenetic tree. Let&#8217;s do this using the built-in whales dataset in BAMMtools:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">BAMMtools</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
</pre></div>
</div>
<p>We need to make sure we are considering precisely the same generations for the mcmc file as for the event data file, so we will get the intersection of these and just take 50 of them for some representative calculations:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>iset &lt;- intersect(mcmc.whales$generation, events.whales$generation)
iset &lt;- iset[round(seq(1, length(iset), length.out=50))]
events &lt;- events.whales[events.whales$generation %in% iset, ]
mcmc &lt;-  mcmc.whales[mcmc.whales$generation %in% iset, ]
</pre></div>
</div>
<p>We also need to ensure that we use exactly the same <code class="docutils literal"><span class="pre">segLength</span></code> parameter for these calculations that were used for the BAMM analysis (see <a class="reference internal" href="#numericalapprox"><span class="std std-ref">here</span></a> for more info on this), as well as the same global sampling fraction (the included whales dataset was run with a sampling fraction of 0.98). Now we compute the likelihood of the final generation:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>BAMMlikelihood(whales, events.whales, gen=&quot;last&quot;, segLength = 0.02, sf = 0.98)
# which returns:
        [1] -272.6831

mcmc$logLik[nrow(mcmc)]
# which returns:
        [1] -272.683
</pre></div>
</div>
<p>So, close &#8211; but are they close enough? Let&#8217;s do 50 samples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>rloglik &lt;- BAMMlikelihood(whales, events, gen = &quot;all&quot;, segLength = 0.02, sf = 0.98)
plot(mcmc$logLik ~ rloglik)
lines(x=c(-350,-250), y=c(-350, -250), lwd=1, col=&#39;red&#39;)
</pre></div>
</div>
<p>These should look precisely identical (please let us know if for some reason they appear to be different!). We can look at the average and maximum differences between these values:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mean(abs(rloglik - mcmc$logLik))
# which returns:
        [1] 0.0002952669
max(abs(rloglik - mcmc$logLik))
# which returns:
        [1] 0.0005066073
</pre></div>
</div>
<p>With this set of 50 samples, we see that the maximum difference between likelihoods computed by BAMM and by an independent R implementation is a very small number, which suggests that BAMM is doing what it should be doing. Again, this assumes that the R implementation is also correct &#8211; e.g., that we haven&#8217;t just re-implemented a set of incorrect equations into R. As one additional test, we will compute the likelihoods of a phylogeny using another implementation of the birth-death process. We will use Rich FitzJohn&#8217;s excellent <a class="reference external" href="http://onlinelibrary.wiley.com/doi/10.1111/j.2041-210X.2012.00234.x/abstract">diversitree</a> package for this. The likelihoods in diversitree and BAMM aren&#8217;t exactly identical, because the diversitree log-likelihoods include a constant term <code class="docutils literal"><span class="pre">sum(log(2:(N</span> <span class="pre">-</span> <span class="pre">1)))</span></code>, where N is the number of tips in the tree. However, since all diversitree log-likelihoods contain this term (it is a constant that depends solely on the number of tips in the tree), we can merely subtract it to attain the BAMM likelihood (for the constant rate process):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">diversitree</span><span class="p">)</span>
<span class="n">lfx</span> <span class="o">&lt;-</span> <span class="n">make</span><span class="o">.</span><span class="n">bd</span><span class="p">(</span><span class="n">whales</span><span class="p">)</span>
<span class="n">constant</span> <span class="o">&lt;-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">:(</span><span class="n">Ntip</span><span class="p">(</span><span class="n">whales</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">parvec1</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">names</span><span class="p">(</span><span class="n">parvec1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">)</span>

<span class="c1"># the diversitree log-likelihood, minus the constant term</span>
<span class="n">lfx</span><span class="p">(</span><span class="n">parvec1</span><span class="p">)</span> <span class="o">-</span> <span class="n">constant</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">282.386</span>

<span class="c1"># BAMM log-likelihood for the same parameters:</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">parvec1</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">282.386</span>

<span class="c1"># Another parameter set:</span>
<span class="n">parvec2</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.49</span><span class="p">)</span>
<span class="n">names</span><span class="p">(</span><span class="n">parvec2</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;mu&quot;</span><span class="p">)</span>

<span class="c1"># here&#39;s the diversitree log-likelihood, minus the constant term</span>
<span class="n">lfx</span><span class="p">(</span><span class="n">parvec2</span><span class="p">)</span> <span class="o">-</span> <span class="n">constant</span> <span class="c1"># diversitree log-likelihood</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">312.8122</span>

<span class="c1"># The BAMM log-likelihood:</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">parvec2</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">312.8122</span>
</pre></div>
</div>
<p>Although the diversitree functions do not (at present) allow us to compute the likelihood of a multi-process model (e.g., a BAMM event configuration with <img class="math" src="_images/math/802cfa00847bfc7bb21d3dc45d013c7f1a600abe.png" alt="\geq"/> 1 rate shift), we can verify that BAMM, diversitree, and the <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> function from BAMMtools compute precisely the same log-likelihood for a given parameterization of the constant-rate birth-death process.</p>
<p>While we are at it, this function also allows us to estimate how much slower BAMM would be if it performed calculations in R with no calls to underlying C++ or C code. On my machine, it takes approximately 0.175 seconds to perform a single likelihood calculation (for the whales data) using the <code class="docutils literal"><span class="pre">BAMMlikelihood</span></code> function. For comparison, I can do approximately 10,000 generations of MCMC simulation on the same dataset per second, and the likelihood computation itself is (very conservatively) 20% of the total computation time required to execute a single generation of MCMC sampling (thus, 80% of the time BAMM is running, it is doing something other than computing the likelihood).</p>
<p>Using these (very rough) numbers, I estimate that BAMM can do 10,000 / 0.2 = 50,000 likelihood calculations per second. Dividing this number by the time to compute the likelihood in R, we get 50,000 / 0.175 <img class="math" src="_images/math/7480d09d210b45db2505dc78ea8dcdf9158cad81.png" alt="\approx"/> 280000. So, the likelihood computation using BAMM&#8217;s C++ implementation is (very) approximately 5 orders of magnitude faster than a pure R-based implementation would be for a tree of this size.</p>
</div>
<div class="section" id="numerical-approximations-in-bamm">
<span id="numericalapprox"></span><h2>12.3. Numerical approximations in BAMM<a class="headerlink" href="#numerical-approximations-in-bamm" title="Permalink to this headline">¶</a></h2>
<p>BAMM makes several numerical approximations that we will state here explicitly.</p>
<div class="section" id="discretization-of-evolutionary-rates-for-the-time-varying-process">
<h3>12.3.1. Discretization of evolutionary rates for the time-varying process<a class="headerlink" href="#discretization-of-evolutionary-rates-for-the-time-varying-process" title="Permalink to this headline">¶</a></h3>
<p>BAMM uses a &#8220;fast&#8221; form of numerical integration where branches of a phylogeny are broken into segments of relative length <code class="docutils literal"><span class="pre">segLength</span></code> and a constant-rate birth-death process is assumed on each interval. Thus, for a time-varying diversification process, we discretize the exponential change process into units defined by <code class="docutils literal"><span class="pre">segLength</span></code>. This allows for much faster calculations relative to more accurate forms of numerical integration. To be clear, the likelihood itself is not approximated: it is the rates that are approximated (which may, in turn, affect the likelihood). In any event, the consequences of this are easy to test. Here, we will use the functions and data from <a class="reference internal" href="#testlikelihood"><span class="std std-ref">this section</span></a> and explore the consequences of <code class="docutils literal"><span class="pre">segLength</span></code>.</p>
<p>If the segment size is greater than the length of a given branch, BAMM will treat the branch as a single segment (e.g., a mean value for <img class="math" src="_images/math/76f1d8ace30435987c01a00ca53a71cba1f40e6c.png" alt="\lambda"/> and <img class="math" src="_images/math/d79e8a2c7ce54906c2b25549da38bdbe02cf40d6.png" alt="\mu"/> will be computed for the branch, and they will be passed to the speciation-extinction equations for the constant-rate birth-death process). If <code class="docutils literal"><span class="pre">segLength</span> <span class="pre">=</span> <span class="pre">1.0</span></code>, then no splitting will occur on any branches: mean rates will be computed for each branch. If <code class="docutils literal"><span class="pre">segLength</span> <span class="pre">=</span> <span class="pre">0.02</span></code>, branches will be split into segments with length equal to 2% of the crown depth of the tree. Here are some comparisons:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># the coarsest possible discretization:</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">gen</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">segLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="mf">0.98</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">276.7793</span>

<span class="c1"># getting finer</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">gen</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">segLength</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="mf">0.98</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">272.7604</span>

<span class="c1"># the default value (BAMM v 2.5)</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">gen</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">segLength</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="mf">0.98</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">272.6831</span>

<span class="c1"># and a very fine partitioning:</span>
<span class="n">BAMMlikelihood</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">gen</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">segLength</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="mf">0.98</span><span class="p">)</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mf">272.6776</span>
</pre></div>
</div>
<p>Despite the 200-fold difference in the grain (0.02 v 0.001), the difference in log-likelihoods is marginal (<img class="math" src="_images/math/7480d09d210b45db2505dc78ea8dcdf9158cad81.png" alt="\approx"/> 0.037), and it comes at a significant computational cost (approximately 200x increase in the number of operations required to compute the likelihood). Please let us know if you find that any inferences are affected by use of the defaults for <code class="docutils literal"><span class="pre">segLength</span></code>.</p>
<p>For a set of time-homogeneous diversification processes, e.g., <img class="math" src="_images/math/7a9db458ea63508258abc4ceead2429099fe1655.png" alt="\lambda_i(t) = \lambda_i"/> and <img class="math" src="_images/math/87fb3fcc177de792100a672bbb9f32a09e45e470.png" alt="\mu_i(t) = \mu_i"/>, the BAMM likelihood will be exact. <code class="docutils literal"><span class="pre">segLength</span></code> will only influence the calculations when rates vary as a continuous function of time.</p>
</div>
<div class="section" id="maximum-possible-extinction-probability">
<h3>12.3.2. Maximum possible extinction probability<a class="headerlink" href="#maximum-possible-extinction-probability" title="Permalink to this headline">¶</a></h3>
<p>Some parameter values may lead to extinction probabilities that are sufficiently close to 1.0 that they are subject to numerical underflow/overflow issues. Specifically, if the <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> equations described above take a value that is numerically indistinguishable from 1, the likelihood of the data will be <img class="math" src="_images/math/7ddd14fea1a936768c4d34c3067b427de73219c9.png" alt="-\infty"/>. To ensure that this rejection is platform independent, BAMM automatically rejects any moves (by setting the log-likelihood equal to -INF) where the extinction probability exceeds a predetermined threshold value. This threshold is <code class="docutils literal"><span class="pre">extinctionProbMax</span></code> and can be set manually in the control file. Note that this is not the extinction rate: it is the maximum permitted value of <img class="math" src="_images/math/4a5896b3cd2183400b4ecfa6f3e0246330bce52f.png" alt="E(t)"/> in the differential equations above, or the probability that a lineage at some time (along with all of its descendants) has gone extinct before the present).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="testingbamm.html" title="13. Is BAMM reliable? A DIY approach"
             >next</a></li>
        <li class="right" >
          <a href="faq.html" title="11. Frequently Asked Questions"
             >previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>