<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>11. Is the posterior on the number of shifts overly sensitive to the prior? &mdash; bamm 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="bamm 2.5.0 documentation" href="documentation.html" />
    <link rel="next" title="12. The BAMM likelihood function" href="likelihoodmodel.html" />
    <link rel="prev" title="10. Frequently Asked Questions" href="faq.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="likelihoodmodel.html" title="12. The BAMM likelihood function"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="faq.html" title="10. Frequently Asked Questions"
             accesskey="P">previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">11. Is the posterior on the number of shifts overly sensitive to the prior?</a><ul>
<li><a class="reference internal" href="#analysis-of-constant-rate-trees-with-bamm-v2-5">11.1. Analysis of constant-rate trees with BAMM v2.5</a></li>
<li><a class="reference internal" href="#these-results-can-be-validated">11.2. These results can be validated</a></li>
<li><a class="reference internal" href="#analysis-of-empirical-phylogenies-with-bamm-v2-5">11.3. Analysis of empirical phylogenies with BAMM v2.5.</a></li>
<li><a class="reference internal" href="#how-to-test-the-effects-of-the-prior-on-the-posterior">11.4. How to test the effects of the prior on the posterior</a></li>
<li><a class="reference internal" href="#nature-of-the-implementation-differences">11.5. Nature of the implementation differences</a></li>
<li><a class="reference internal" href="#impact-of-implementation-differences-on-empirical-inference">11.6. Impact of implementation differences on empirical inference</a></li>
<li><a class="reference internal" href="#why-did-we-fail-to-detect-the-event-rate-bug-in-pre-2-5-bamm">11.7. Why did we fail to detect the event rate bug in pre-2.5 BAMM?</a></li>
<li><a class="reference internal" href="#how-can-i-report-implementation-errors-to-the-developers">11.8. How can I report implementation errors to the developers?</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="faq.html"
                        title="previous chapter">10. Frequently Asked Questions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="likelihoodmodel.html"
                        title="next chapter">12. The BAMM likelihood function</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/prior.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="is-the-posterior-on-the-number-of-shifts-overly-sensitive-to-the-prior">
<span id="prior"></span><h1>11. Is the posterior on the number of shifts overly sensitive to the prior?<a class="headerlink" href="#is-the-posterior-on-the-number-of-shifts-overly-sensitive-to-the-prior" title="Permalink to this headline">¶</a></h1>
<p>At the recent Evolution conference, Brian Moore gave a thought-provoking <a class="reference external" href="https://www.xcdsystem.com/evolution2016/program/index.cfm?pgid=570&amp;search=1&amp;qtype=Session&amp;sid=20402&amp;submit=Go">talk</a> on several outstanding theoretical issues with BAMM. Here, we respond to several concerns about BAMM that were raised during the Moore et al talk and published via social media; see Twitter posts concerning both <a class="reference external" href="http://archive.is/aVOs1">simulated</a>  and <a class="reference external" href="http://archive.is/wVIWp">empirical</a> datasets. In particular, a concern was raised that the compound Poisson process (CPP) model in BAMM is non-identifiable, and that this non-identifiability is evident from the extreme sensitivity of BAMM results to the underlying prior distribution on the number of rate shifts.</p>
<p><strong>Here, we demonstrate that we can only replicate this purported sensitivity to the prior by using older versions of BAMM that contained several implementation differences relative to current (since Nov 2015) versions.</strong> Our impression from the talk and tweeted results is that these graphs resulted from analyses conducted with the most recent version of BAMM. However, the results we have seen cannot be replicated using BAMM versions 2.5 (released November 2015) and later.</p>
<p>BAMM v2.5 was released in part due to several bug reports from one of the authors of the talk; see Github issue <a class="reference external" href="https://github.com/macroevolution/bamm/issues/136">136</a>
and issue <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">137</a> . Analyses using the most recent version, BAMM v2.5 (available since November 2015), yields robust inferences on the posterior that are largely independent of the prior. We document our re-analysis of results discussed verbally in the talk and posted to social media for <a class="reference internal" href="#nr-constantrate"><span class="std std-ref">constant rate</span></a> phylogenies and for the 87-taxon <a class="reference internal" href="#nr-whales"><span class="std std-ref">whale</span></a> phylogeny distributed with <code class="docutils literal"><span class="pre">BAMMtools</span></code>.</p>
<p>BAMM assumes that the number of diversification rate regimes on phylogenetic trees is governed by a Poisson distribution with an exponential hyperprior on the Poisson rate parameter. Theoretically, it turns out that this distribution is simply a geometric distribution with a rate parameter p = 1 / (1 + <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>). Viewed in this fashion, <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> is simply the mean of the prior distribution on the number of rate shifts. In specifying a BAMM analysis, <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> is identical to the control parameter <code class="docutils literal"><span class="pre">expectedNumberOfShifts</span></code>, or &#8211; using an older version of BAMM &#8211; the inverse of the <code class="docutils literal"><span class="pre">poissonRatePrior</span></code> parameter.</p>
<p><strong>We are enthusiastic about scientific dialogue on BAMM&#8217;s performance and on alternative inference frameworks for macroevolutionary dynamics.</strong> However, it is imperative that theoretical considerations be separated from implementation-related issues that are specific to particular releases of the software program.</p>
<div class="section" id="analysis-of-constant-rate-trees-with-bamm-v2-5">
<span id="nr-constantrate"></span><h2>11.1. Analysis of constant-rate trees with BAMM v2.5<a class="headerlink" href="#analysis-of-constant-rate-trees-with-bamm-v2-5" title="Permalink to this headline">¶</a></h2>
<p>One of the authors on the talk <a class="reference external" href="http://archive.is/aVOs1">posted</a> an image that illustrates the apparent sensitivity of the posterior distribution on the number of shifts to the prior, <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>. Here is a screenshot from that post illustrating (upper row) the relationship between the posterior and the prior for constant rate trees, and (lower row) the shift model that would be favored if we simply selected the mode of the posterior as the overall best-fit model.</p>
<div class="figure align-center" id="meaposteriorconstant">
<a class="reference internal image-reference" href="_images/mea_twitter_constant.png"><img alt="_images/mea_twitter_constant.png" src="_images/mea_twitter_constant.png" style="width: 850px;" /></a>
</div>
<p>&#8220;Events&#8221; in the x-axis legend is synonymous with &#8220;rate shifts&#8221;. The bottom row is not necessarily relevant: presumably, if these are <strong>constant-rate</strong> trees, we should hope that the mode (MAP) of the posterior distribution is the zero shift model (as seen above). However, the upper panel is potentially of concern: it is clear that the posterior (orange lines) is considerably influenced by the prior distribution (blue lines), and as one increases the prior mean (e.g., <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1.0 -&gt; <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 10), the posterior simply shifts to the right. Because we have advocated model selection with Bayes factors, it is not necessarily problematic that the posterior is influenced by the prior: indeed, in Bayesian analysis, there <strong>should</strong> be some effect &#8211; however neglible &#8211; of the prior, and the key question is whether this sensitivity matters for empirical inference.</p>
<p><strong>However, these results cannot be replicated using BAMM version 2.5 and later (released November 2015)</strong>. Here I provide the results from BAMM analysis of 100 phylogenies of 100 taxa each, which we simulated under a constant-rate birth-death process (e.g., trees with no rate shifts). Each phylogeny was analyzed with the Nov 2015 release of BAMM v2.5 under the same prior parameterizations shown in the <a class="reference external" href="http://archive.is/aVOs1">tweeted</a> results (<img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 0.1, 0.5, 1.0, 2, 10). For each count of rate shifts, I will plot the mean of the marginal posterior distribution across all 100 trees (with gray bars), corresponding to the yellow line in the tweeted figure above. I will also show the corresponding (analytical) prior distribution in red.</p>
<div class="figure align-center" id="constant1">
<a class="reference internal image-reference" href="_images/bamm_v2.5_constant_match.png"><img alt="_images/bamm_v2.5_constant_match.png" src="_images/bamm_v2.5_constant_match.png" style="width: 850px;" /></a>
</div>
<p>We see little substantive effect of the prior across this set of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> parameterizations (e.g., the distributions in gray do not change much across panels, even though the priors are different). In fact, even if we crank up the prior distribution to have a mean 100x greater than that considered by Moore et al in the tweeted results, we find virtually no influence on the corresponding marginal posterior distribution:</p>
<div class="figure align-center" id="constant2">
<a class="reference internal image-reference" href="_images/bamm_v2.5_constant.png"><img alt="_images/bamm_v2.5_constant.png" src="_images/bamm_v2.5_constant.png" style="width: 850px;" /></a>
</div>
<p>Thus, from <img class="math" src="_images/math/3185591d8bc0727ec49f24cd76d36828df12cdce.png" alt="\gamma = 1"/> to <img class="math" src="_images/math/4013af652254b13d95bdcc6c38332f44c8891dda.png" alt="\gamma = 100"/>, the marginal posterior distribution is <em>largely independent</em> of the prior for constant-rate trees with 100 tips. In contrast to the <a class="reference external" href="http://archive.is/aVOs1">tweeted</a> results posted online, you can see that the posterior distribution is well behaved with increasing values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>. It is reasonable to expect small values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> (e.g., <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 0.1) to have a larger effect on the posterior, because this is a <strong>strong</strong> prior. It is strong, because the relative difference in prior probabilities between any two integers <em>X</em> and <em>Y</em> is inversely proportional to <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>. You can easily verify this by computing the difference in prior probabilities for any <img class="math" src="_images/math/7b0701dc0be39d237f65e575907bf814823d2925.png" alt="X \geq 0"/> and <img class="math" src="_images/math/14488a785af228aba07482b0365617b15e8ccd7f.png" alt="Y &gt; X"/>. Using the statistical software R, for example, consider the difference in prior probabilities between some numbers of shifts <em>X</em> and <em>X + 100</em>, for 2 different parameterizations of the geometric:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># geometric with expected shifts = 1</span>
<span class="n">expected</span> <span class="o">&lt;-</span> <span class="mi">1</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="n">expected</span> <span class="o">+</span> <span class="mi">100</span>
<span class="n">par</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">expected</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># parameter of the geometric</span>
<span class="n">dgeom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">T</span><span class="p">)</span> <span class="c1"># should give 63.1</span>


<span class="c1"># geometric with expected shifts = 100</span>
<span class="n">expected</span> <span class="o">&lt;-</span> <span class="mi">100</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="n">expected</span> <span class="o">+</span> <span class="mi">100</span>
<span class="n">par</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">expected</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># parameter of the geometric</span>
<span class="n">dgeom</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">T</span><span class="p">)</span> <span class="c1"># should give 1.0</span>
</pre></div>
</div>
<p>As such, you can see that with small values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>, we expect &#8211; on theoretical grounds alone &#8211; to have a larger effect of the prior on the posterior.</p>
<p><strong>What explains the discrepancy between BAMM v2.5 and the results that purport to show high sensitivity of BAMM to the prior?</strong> We can replicate the distributions presented by the authors in their tweeted <a class="reference external" href="http://archive.is/aVOs1">figure</a> , but only if we restrict our analysis to versions of BAMM that predate our major updates in November 2015. Here is an analysis using BAMM v2.4 (June 2015):</p>
<div class="figure align-center" id="constant3">
<a class="reference internal image-reference" href="_images/bamm_old_constant.png"><img alt="_images/bamm_old_constant.png" src="_images/bamm_old_constant.png" style="width: 850px;" /></a>
</div>
<p>You can see that the posterior is much more sensitive to the prior. This doesn&#8217;t mean that results obtained using these versions are flawed, as discussed <a class="reference internal" href="#impact"><span class="std std-ref">below</span></a>. However, it is true that we are more confident in the latest and most stable release of the program.</p>
</div>
<div class="section" id="these-results-can-be-validated">
<h2>11.2. These results can be validated<a class="headerlink" href="#these-results-can-be-validated" title="Permalink to this headline">¶</a></h2>
<p>It is straightforward to verify the results given above for constant rate trees. To use a version of BAMM associated with a particular Github commit, you can simply <em>checkout</em> the old commit and compile the software. The relevant git command is <code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">commit_ID</span></code>, where <code class="docutils literal"><span class="pre">commit_ID</span></code> is the first 6 or so characters from the commit ID you wish to clone. So, to repeat BAMM analyses using the exact version of BAMM that was archived on Github on November 9, 2015, you can run <code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">af69a923b9</span></code>, assuming you have cloned the BAMM repository on your machine.</p>
<p>To run BAMM on constant-rate trees, you can simply simulate some phylogenies under a constant-rate birth-death process using any R package that can do this; <code class="docutils literal"><span class="pre">diversitree</span></code> and <code class="docutils literal"><span class="pre">geiger</span></code> are good options:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">geiger</span><span class="p">)</span>
<span class="n">tree</span> <span class="o">&lt;-</span> <span class="n">sim</span><span class="o">.</span><span class="n">bdtree</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="s2">&quot;taxa&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">write</span><span class="o">.</span><span class="n">tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s2">&quot;test.tre&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And of course, you can simply set up 3 sequential BAMM runs on this tree as follows (using bash on OSX), assuming you have set up a control file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bamm</span> <span class="o">-</span><span class="n">c</span> <span class="n">myControlFile</span> <span class="o">--</span><span class="n">expectedNumberOfShifts</span> <span class="mf">0.1</span> <span class="o">--</span><span class="n">outName</span> <span class="n">x_0</span><span class="o">.</span><span class="mi">1</span>
<span class="o">./</span><span class="n">bamm</span> <span class="o">-</span><span class="n">c</span> <span class="n">myControlFile</span> <span class="o">--</span><span class="n">expectedNumberOfShifts</span> <span class="mi">1</span> <span class="o">--</span><span class="n">outName</span> <span class="n">x_1</span>
<span class="o">./</span><span class="n">bamm</span> <span class="o">-</span><span class="n">c</span> <span class="n">myControlFile</span> <span class="o">--</span><span class="n">expectedNumberOfShifts</span> <span class="mi">100</span> <span class="o">--</span><span class="n">outName</span> <span class="n">x_100</span>
</pre></div>
</div>
<p>Running this as a shell script will set up and execute 3 BAMM runs in the same directory under 3 very different priors (note again that <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 0.1 is a much stronger prior than <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 100), saving all results to separate files that are prefixed by the relevant prior mean.</p>
<p>The original <a class="reference external" href="http://www.plosone.org/article/info%3Adoi%2F10.1371%2Fjournal.pone.0089543">PLoS ONE</a> article that tested BAMM&#8217;s performance contains a distribution of phylogenies that include constant rate trees and trees with rate shifts. The Dryad data package from the PLoS ONE article can be <a class="reference external" href="http://datadryad.org/resource/doi:10.5061/dryad.hn1vn">downloaded</a> and assessed with BAMM v2.5. The constant-rate phylogenies from Rabosky 2014 are a bit larger on average than the 100 taxon tree results I&#8217;ve shown above, so these data contain even more signal. We re-analyzed these constant-rate trees using BAMM v2.5 and they show a similar lack of sensitivity to the prior; the following plot shows the marginal posterior probability distribution for this tree set, averaged over all 500 trees. E.g., the marginal probability of k events (&#8220;shifts&#8221;) is the average such probability over all constant-rate trees in the simulation set:</p>
<div class="figure align-center" id="plos0shift">
<a class="reference internal image-reference" href="_images/plos1_0shift.png"><img alt="_images/plos1_0shift.png" src="_images/plos1_0shift.png" style="width: 500px;" /></a>
</div>
</div>
<div class="section" id="analysis-of-empirical-phylogenies-with-bamm-v2-5">
<span id="nr-whales"></span><h2>11.3. Analysis of empirical phylogenies with BAMM v2.5.<a class="headerlink" href="#analysis-of-empirical-phylogenies-with-bamm-v2-5" title="Permalink to this headline">¶</a></h2>
<p>Another <a class="reference external" href="http://archive.is/wVIWp">Twitter</a> post showed the effects of the prior on the marginal posterior distribution of rate shifts for an 87-taxon phylogeny of whales; these results were also discussed in the Evolution talk. You can access this phylogeny with <code class="docutils literal"><span class="pre">data(whales)</span></code> from our <code class="docutils literal"><span class="pre">BAMMtools</span></code> package. Here is the image from Twitter showing the marginal posterior and the prior for the number of shifts for the whale dataset, for 5 values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>:</p>
<div class="figure align-center" id="meawhales">
<a class="reference internal image-reference" href="_images/mea_twitter_whales.png"><img alt="_images/mea_twitter_whales.png" src="_images/mea_twitter_whales.png" style="width: 850px;" /></a>
</div>
<p>The above figure shows a striking effect of the prior on the posterior distribution of rate shifts for the whale phylogeny. <strong>However, these results cannot be replicated with BAMM v2.5</strong>. Sebastian Hoehna generously shared the analysis files (control files) that were used to generate these results. Upon reanalysis with BAMM v2.5, we observe strikingly different behaviors: in particular, we see minimal sensitivity to the prior for <img class="math" src="_images/math/abbf92dd970b785e169ef192749e275887ded732.png" alt="\gamma \geq 1.0"/>. These analyses can be repeated with BAMM Github commits <code class="docutils literal"><span class="pre">af69a923b9</span></code> and later, dating from Nov 9 2015).</p>
<div class="figure align-center" id="whalesreanalysis1">
<a class="reference internal image-reference" href="_images/whales_reanalysis1.png"><img alt="_images/whales_reanalysis1.png" src="_images/whales_reanalysis1.png" style="width: 850px;" /></a>
</div>
<p>In fact, the posterior is actually <strong>so insensitive to the prior</strong> &#8211; even with this tree of 87 tips &#8211; that we can crank up the prior mean to <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 100 and <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1000, with no demonstrable consequences for inference:</p>
<div class="figure align-center" id="whalesreanalysis2">
<a class="reference internal image-reference" href="_images/whales_reanalysis2.png"><img alt="_images/whales_reanalysis2.png" src="_images/whales_reanalysis2.png" style="width: 850px;" /></a>
</div>
<p>That is, the posterior distribution on the number of shifts is, for this phylogeny, virtually identical across prior distributions whose means vary by 1000x. As such, there is no evidence that BAMM results are unusually sensitive to the prior, at least if BAMM v2.5 is used for analysis.</p>
<p>What, then, explains the discrepancy between the results I am showing here and the results posted <a class="reference internal" href="#meawhales"><span class="std std-ref">above</span></a>? The results obtained showing strong effects of the prior can be replicated with some versions of BAMM that predate the November 2015 update. Here is a reanalysis of the input files provided by Hoehna, but using Github release tag ID <code class="docutils literal"><span class="pre">eb233a28</span></code>, from June 15, 2015:</p>
<div class="figure align-center" id="whalesreanalysis3">
<a class="reference internal image-reference" href="_images/whales_reanalysis3.png"><img alt="_images/whales_reanalysis3.png" src="_images/whales_reanalysis3.png" style="width: 850px;" /></a>
</div>
<p>These results appear to precisely replicate the sensitivity to the prior presented in the talk and tweeted to social <a class="reference external" href="http://archive.is/wVIWp">media</a> . <strong>Results purporting to show the extreme sensitivity of BAMM to the prior on the number of rate shifts cannot be replicated for BAMM v 2.5, as claimed.</strong> We encourage researchers to confirm our results for these and other empirical datasets.</p>
</div>
<div class="section" id="how-to-test-the-effects-of-the-prior-on-the-posterior">
<h2>11.4. How to test the effects of the prior on the posterior<a class="headerlink" href="#how-to-test-the-effects-of-the-prior-on-the-posterior" title="Permalink to this headline">¶</a></h2>
<p>It is important that researchers test the effects of the prior on empirical inference. <code class="docutils literal"><span class="pre">BAMMtools</span></code> has a simple tool for plotting the marginal posterior and prior distributions on the number of shifts:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">BAMMtools</span><span class="p">)</span>
<span class="n">data</span><span class="p">(</span><span class="n">whales</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">whales</span><span class="p">)</span>
<span class="n">plotPrior</span><span class="p">(</span><span class="n">mcmc</span><span class="o">.</span><span class="n">whales</span><span class="p">,</span> <span class="n">expectedNumberOfShifts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>One potential source of concern comes when researchers perform analyses with <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1 (<code class="docutils literal"><span class="pre">expectedNumberOfShifts</span> <span class="pre">=</span> <span class="pre">1</span></code>); this is the default in BAMM control file templates. If your tree has evidence for just one or several shifts, it might appear that the prior has an unusually strong effect on the posterior, simply because you&#8217;ve performed analyses with a prior distribution with most of the weight concentrated near where the posterior <em>should</em> be. Under the prior alone, with <code class="docutils literal"><span class="pre">expectedNumberOfShifts</span> <span class="pre">=</span> <span class="pre">1</span></code>, 95% of our observations should involve 0, 1, 2, or 3 shifts. However, if we use a prior distribution with a much larger mean value &#8211; say, <code class="docutils literal"><span class="pre">expectedNumberOfShifts</span> <span class="pre">=</span> <span class="pre">100</span></code> &#8211; that same prior probability is smeared from 0 to 302 shifts, and the prior is essentially flat. We recommend that researchers consider performing BAMM analyses using several values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>, including <code class="docutils literal"><span class="pre">expectedNumberOfShifts</span> <span class="pre">=</span> <span class="pre">100</span></code>, to assess whether their results are robust to the prior. As an added benefit, we have found that the simulation of the posterior with BAMM is considerably more efficient (e.g, the MCMC converges more quickly to the true posterior) when using large values for <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>.</p>
<p>Please be aware that any comments about the prior and posterior on this page pertain strictly to the prior on the number of rate shifts. There are, of course, several other priors in BAMM that one could be concerned about, including priors on speciation and extinction rates. These prior distributions are moderately flat if you have empirically parameterized your analysis with the function <code class="docutils literal"><span class="pre">BAMMtools::setBAMMpriors</span></code>. Some of the worst cases of poor performance that we have seen in BAMM have come from misspecified priors on speciation and extinction rates that led to very poor convergence properties. If you place a strong prior on speciation or extinction (<code class="docutils literal"><span class="pre">lambdaInitPrior</span></code> and <code class="docutils literal"><span class="pre">muInitPrior</span></code>), and if this prior is mismatched to the scale of your tree, then your BAMM run may not simulate a valid posterior distribution. By <em>mismatch</em>, I mean that your prior distribution puts high weight on values of speciation (<img class="math" src="_images/math/76f1d8ace30435987c01a00ca53a71cba1f40e6c.png" alt="\lambda"/>) and/or extinction (<img class="math" src="_images/math/d79e8a2c7ce54906c2b25549da38bdbe02cf40d6.png" alt="\mu"/>) that are not sensible given your phylogeny and branch length scaling.</p>
</div>
<div class="section" id="nature-of-the-implementation-differences">
<span id="nature"></span><h2>11.5. Nature of the implementation differences<a class="headerlink" href="#nature-of-the-implementation-differences" title="Permalink to this headline">¶</a></h2>
<p>There are multiple implementation differences that distinguish BAMM v2.5 from previous versions. Some of these implementation differences are true implementation errors; others are enhancements. Two of the most significant changes to BAMM since the initial inception of the program are described below; unfortunately, we were not consistent in our version indexing of the program in May-June 2015, but we also list the relevant Github commit IDs.</p>
<ul>
<li><dl class="first docutils">
<dt><strong>BAMM v &lt; 2.4</strong></dt>
<dd><p class="first last">(all Github commits prior to May 26, 2015) All versions of BAMM from this period contained an implementation error in the Hastings ratio for one specific MCMC move which would have magnified the effects of the prior on the posterior. Specifically, BAMM used an incorrect acceptance probability for the MCMC move that updated the Poisson event rate in the model (e.g., the <em>rate</em> at which rate-shifts occur). On the plus side, all versions of BAMM from this time explicitly simulated the prior distribution as no analytical solution was available; because the same error was present in the prior distribution generated by BAMM, the posterior and prior were biased by the same factor. See the section on <a class="reference internal" href="#impact"><span class="std std-ref">impacts</span></a> for some consideration of how this issue might have affected results. This <em>event rate</em> bug was resolved with assistance from Cecile Ané and Bret Larget, who spotted the error and provided the analytical correction.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>BAMM v &#8220;2.4&#8221;</strong></dt>
<dd><p class="first last">(Github <code class="docutils literal"><span class="pre">eb233a2</span></code> and related commits). A rapid phase of development where we addressed the Hastings ratio bug described above. Several specific implementations from this time were unreliable and several fixes were posted, such as Github <code class="docutils literal"><span class="pre">94b2f83</span></code>, which addressed numerical underflow error in the likelihood calculations. However, several additional implementation  and theoretical issues were either introduced or not addressed during this time, including those pointed out to us on Github in <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">October 2015</a>. Several of these issues were true implementation errors.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>BAMM v 2.5</strong></dt>
<dd><p class="first last">(Github <code class="docutils literal"><span class="pre">af69a923b9</span></code> and all subsequent commits). The most significant change to BAMM, other than the Hastings ratio error described above, followed from our identification of a major theoretical concern with how BAMM and other rate-shift models compute the likelihood of phylogenetic trees under rate-shift models. We do not consider this issue a bug and have described aspects of this in some detail <a class="reference external" href="likelihoodmodel.html">here</a>. A <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">post</a> to our Github repository raised the issue of how E(t) calculations should be handled at internal nodes; this led us to discover what we consider a significant and largely-urecognized problem in diversification studies. The fundamental change to the likelihood calculations in BAMM v2.5 is best viewed as a theoretically coherent solution to an outstanding problem, rather than an implementation error. We have provided (since Nov 2015) a function in <code class="docutils literal"><span class="pre">BAMMtools</span></code> for computing likelihoods <em>exactly</em> as done by BAMM (see <a class="reference internal" href="likelihoodmodel.html#testlikelihood"><span class="std std-ref">here</span></a>), to enable researchers to further explore this issue. Several minor implementation issues were also resolved during this time.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="impact-of-implementation-differences-on-empirical-inference">
<span id="impact"></span><h2>11.6. Impact of implementation differences on empirical inference<a class="headerlink" href="#impact-of-implementation-differences-on-empirical-inference" title="Permalink to this headline">¶</a></h2>
<p>It is entirely possible that results obtained using BAMM v2.5 will differ from those using earlier versions of the program, and these differences could be due to our resolution of true implementation errors (e.g., the <em>event rate</em> bug) or to our implementation of a new solution to a difficult theoretical problem (e.g., how to correctly compute the likelihood of a rate-shift process on a phylogeny). The most significant differences are likely to involve conclusions about the <em>number</em> of rate shifts inferred from the marginal posterior probability distribution of shifts. As noted above, the <em>event rate</em> bug in BAMM v2.3 and earlier affected both the prior and the posterior. Because both of these terms were biased by the same factor, the bug largely canceled out when model selection was performed with Bayes factors. Moreover, the <em>event rate bug</em> only resulted in modest biases to the posterior when the default value of <code class="docutils literal"><span class="pre">poissonRatePrior</span> <span class="pre">=</span> <span class="pre">1</span></code> was used for analysis.</p>
<p>Here is an explicit comparison of the prior as simulated with BAMM 2.3 and earlier (with event rate bug), versus the exact analytical prior, for <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 0.1, 1, and 10:</p>
<div class="figure align-center" id="oldprior1">
<a class="reference internal image-reference" href="_images/oldPrior1.png"><img alt="_images/oldPrior1.png" src="_images/oldPrior1.png" style="width: 650px;" /></a>
</div>
<p>You can see that the prior distribution changes shape a bit (with a non-zero mode) for <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 10, but &#8211; at least qualitatively &#8211; the distributions seem fairly similar for <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1. Here, I will plot the exact (true) analytical prior probabilities of 0 - 10 shifts under <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1 against the corresponding simulated probabilities using the simulation algorithm containing the event rate bug:</p>
<div class="figure align-center" id="oldprior2">
<a class="reference internal image-reference" href="_images/oldPrior2.png"><img alt="_images/oldPrior2.png" src="_images/oldPrior2.png" style="width: 350px;" /></a>
</div>
<p>That is, each point corresponds to a prior probability of a particular number of shifts under the old (incorrect) prior and the analytical (correct) prior. For example, the upper-rightmost point (p <img class="math" src="_images/math/7480d09d210b45db2505dc78ea8dcdf9158cad81.png" alt="\approx"/> 0.5) corresponds to the prior probability of 0-shifts; the point immediately to the left (p <img class="math" src="_images/math/7480d09d210b45db2505dc78ea8dcdf9158cad81.png" alt="\approx"/> 0.25) is the prior probability of 1 shift; and so on. This particular prior (<img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1) is by far the most-common parameterization that we have seen in published studies. One can see that the event rate bug probably had a relatively minor effect (<img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 1): true probabilities are fairly tightly correlated with the corresponding prior probabilities simulated with old versions of BAMM.</p>
</div>
<div class="section" id="why-did-we-fail-to-detect-the-event-rate-bug-in-pre-2-5-bamm">
<h2>11.7. Why did we fail to detect the event rate bug in pre-2.5 BAMM?<a class="headerlink" href="#why-did-we-fail-to-detect-the-event-rate-bug-in-pre-2-5-bamm" title="Permalink to this headline">¶</a></h2>
<p>Several reasons. First, we did not have the analytical solution to the true prior in hand. This was only resolved after discussions with Cecile Ané at a BAMM workshop that was held in Ann Arbor in May 2015. Hence, we did not have a true analytical expectation for comparison. Second, BAMM performed well in practice. Model selection with Bayes factors continued to perform well for all previous versions of BAMM (even when both posterior and prior distributions included the <em>event rate</em> bug). We have seen little evidence that previous versions of BAMM have been prone to overfitting. Finally, speciation and extinction rate estimates obtained by BAMM were, in general, highly correlated with the true values in the generating model for BAMM 2.4 and earlier; we have been using, since December 2014, a full <em>BAMM process</em> simulator to validate BAMM. This code is available as a Github <a class="reference external" href="https://github.com/macroevolution/simtree">repository</a> and, though documentation is still incomplete, the code provides simulation of phylogenies under a complete Poisson process and includes rate shifts leading to unobserved and extinct lineages. Hence, we have yet seen no indication that previous versions performed poorly in practice.</p>
</div>
<div class="section" id="how-can-i-report-implementation-errors-to-the-developers">
<h2>11.8. How can I report implementation errors to the developers?<a class="headerlink" href="#how-can-i-report-implementation-errors-to-the-developers" title="Permalink to this headline">¶</a></h2>
<p>We have two standard channels for bug reporting and/or other concerns about BAMM and BAMMtools. These include our Github <a class="reference external" href="https://github.com/macroevolution/bamm">page</a> , which provides an archived forum for bug reports and other issues. Likewise, we maintain a Google <a class="reference external" href="https://groups.google.com/forum/#!forum/bamm-project">group</a> dedicated to questions and comments about BAMM.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="likelihoodmodel.html" title="12. The BAMM likelihood function"
             >next</a></li>
        <li class="right" >
          <a href="faq.html" title="10. Frequently Asked Questions"
             >previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>