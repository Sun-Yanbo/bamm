<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>12. Replication tests of empirical results from Moore et al (2016) &mdash; bamm 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bamm.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="bamm 2.5.0 documentation" href="documentation.html" />
    <link rel="next" title="13. The BAMM likelihood function" href="likelihoodmodel.html" />
    <link rel="prev" title="11. Is the posterior on the number of shifts overly sensitive to the prior?" href="prior.html" /> 
  </head>
  <body role="document">
<div class="pageheader">
    <img src="_static/bamm-header.png" /img>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="likelihoodmodel.html" title="13. The BAMM likelihood function"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="prior.html" title="11. Is the posterior on the number of shifts overly sensitive to the prior?"
             accesskey="P">previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="documentation.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">12. Replication tests of empirical results from Moore et al (2016)</a><ul>
<li><a class="reference internal" href="#summary">12.1. Summary</a></li>
<li><a class="reference internal" href="#details">12.2. Details</a></li>
<li><a class="reference internal" href="#several-theoretical-concerns-raised-by-mea-cannot-be-evaluated">12.3. Several theoretical concerns raised by MEA cannot be evaluated</a></li>
<li><a class="reference internal" href="#reanalysis-of-empirical-data-from-moore-et-al-2016">12.4. Reanalysis of empirical data from Moore et al (2016)</a></li>
<li><a class="reference internal" href="#reanalysis-of-constant-rate-trees-from-moore-et-al-2016">12.5. Reanalysis of constant-rate trees from Moore et al (2016)</a></li>
<li><a class="reference internal" href="#all-empirical-datasets-from-moore-et-al-reanalyzed">12.6. All empirical datasets from Moore et al, reanalyzed</a></li>
<li><a class="reference internal" href="#appendix-the-random-option-used-by-moore-et-al-is-not-valid">12.7. Appendix: The &#8220;random&#8221; option used by Moore et al is not valid</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="prior.html"
                        title="previous chapter">11. Is the posterior on the number of shifts overly sensitive to the prior?</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="likelihoodmodel.html"
                        title="next chapter">13. The BAMM likelihood function</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/replication.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="replication-tests-of-empirical-results-from-moore-et-al-2016">
<span id="replication"></span><h1>12. Replication tests of empirical results from Moore et al (2016)<a class="headerlink" href="#replication-tests-of-empirical-results-from-moore-et-al-2016" title="Permalink to this headline">¶</a></h1>
<p>This page is not our full or formal response to the Moore et al (2016) <a class="reference external" href="http://www.pnas.org/content/early/2016/08/09/1518659113.full">critique</a> of BAMM, but addresses replicability of empirical results from the paper.</p>
<div class="section" id="summary">
<h2>12.1. Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Empirical results from Moore et al (MEA) cannot be replicated with standard usage of BAMM:</p>
<ul class="simple">
<li>MEA added a <strong>hidden and undocumented</strong> setting to their BAMM control files and modified its default value. This was not acknowledged in their manuscript.</li>
<li>This setting was a <em>developer-only</em> option that changes how the extinction probabilities are calculated in BAMM</li>
<li>MEA&#8217;s modification reactivated an implementation concern that they <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">pointed out</a> in 2015</li>
<li>We had fixed this issue in the November 2015 release of BAMM (v2.5)</li>
<li>However, we released v2.5 with a hidden shortcut for experimentation, which was purposefully activated by MEA in all analyses (it cannot be activated by accident, as the parameter is not included in any template files and the setting they used is not documented)</li>
<li>When BAMM v2.5 is used with the correct (default) setting, empirical pathologies observed by MEA cannot be replicated.</li>
</ul>
<p><strong>We strongly recommend that researchers do not alter the values of hidden/undocumented parameters in BAMM, most of which are intended for internal use by BAMM developers</strong>. Altering these settings may induce pathological behaviors relative to the default/recommended value.</p>
</div>
<div class="section" id="details">
<h2>12.2. Details<a class="headerlink" href="#details" title="Permalink to this headline">¶</a></h2>
<p>Moore et al (MEA) raise a number of important theoretical issues regarding macroevolutionary rate shift models in their recently published critique of BAMM. However, the empirical results from their paper <strong>cannot be replicated without modifying hidden, developer-only settings</strong>. Researchers using BAMM <em>as recommended by the developers</em> will be unable to replicate key empirical results from their paper, although we encourage users to try for themselves using the information below.</p>
<p>MEA made a critical modification to standard usage of BAMM in all analyses from their paper for which they have released their input files. In all control files provided, MEA activated a hidden developer setting, <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code>, and specified a value that was not intended for routine data analysis. Specifically, the last line of every BAMM control file they provide on <a class="reference external" href="http://datadryad.org/resource/doi:10.5061/dryad.mb0sd">Dryad</a> to accompany their paper includes the following command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="n">random</span>
</pre></div>
</div>
<p>This setting is a hidden option that we included to allow developers to easily explore likelihood calculations in previous implementations of BAMM. The default value for this parameter, which was <em>not visible on any template files</em>, was:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="n">if_different</span>
</pre></div>
</div>
<p>Our last major update to BAMM (v2.5; November 2015) included a number of major improvements and also addressed several implementation concerns. One significant implementation concern was raised by MEA coauthor Hoehna in his GitHub post <a class="reference external" href="https://github.com/macroevolution/bamm/issues/137">here</a> from October 2, 2015. Hoehna pointed out a potential concern with the flow of extinction calculations in BAMM during the traversal of the tree from the tips to the root. Importantly, these calculations in previous versions of BAMM could, in some instances, be affected by arbitrary rotation of left and right descendant branches from a given node. We performed extensive testing of several algorithms for likelihood calculations under rate-shift models and identified a <a class="reference external" href="http://bamm-project.org/likelihoodmodel.html#extinction-calculations-at-nodes">solution</a> that worked well in practice. The solution we have implemented is similar to that used by Etienne and Haegeman in their model for subclade shifts involving diversity-dependent <a class="reference external" href="http://www.journals.uchicago.edu/doi/10.1086/667574">processes</a>.</p>
<p>The hidden (and undocumented) non-default settings for <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> were intended to be developer-only options to allow us, internally, to replicate aspects of the computational algorithm used in earlier (pre-2.5) versions of BAMM. Hence, the control files provided with MEA&#8217;s Dryad submission override the default setting and force BAMM to perform likelihood calculations in a manner that is related to the calculation flow in earlier implementations. By setting <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> to (non-default) values of <code class="docutils literal"><span class="pre">random</span></code>, <code class="docutils literal"><span class="pre">left</span></code>, or <code class="docutils literal"><span class="pre">right</span></code>, you are essentially <strong>recreating the implementation concern identified by Hoehna in his GitHub post.</strong> However, the <code class="docutils literal"><span class="pre">random</span></code> setting used by MEA actually leads to <em>worse performance</em> than you would have observed for previous versions of BAMM, as this option destabilizes BAMM&#8217;s likelihood calculations (details <a class="reference internal" href="#combineextinctionrandom1"><span class="std std-ref">here</span></a>). As such, we expect that the <code class="docutils literal"><span class="pre">random</span></code> option used by MEA leads to pathologies that would never have been observed for any previous (pre-v2.5) versions of BAMM.</p>
<p>To reiterate:</p>
<ul class="simple">
<li>The authors reported bugs and/or implementation concerns to us via GitHub in October 2015</li>
<li>We made a number of major changes to BAMM and released BAMM v2.5, addressing (among other issues) the concern about extinction probability handling at internal nodes</li>
<li>All results in MEA were obtained with BAMM v2.5, but required changing a hidden setting that not only recreates but <strong>exacerbates</strong> performance issues due to the implementation concern raised in Hoehna&#8217;s GitHub post and that are otherwise solved with the default implementation of v2.5.</li>
<li>This use of a non-standard and undocumented BAMM algorithm was not described in the MEA article.</li>
<li>No studies of which we are aware, other than MEA, have changed the default setting for <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code></li>
</ul>
<p>We have never documented the setting <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span> <span class="pre">=</span> <span class="pre">random</span></code>. The only reference to this is buried deep within BAMM&#8217;s C++ code as a comment to developers (see <a class="reference external" href="https://github.com/macroevolution/bamm/blob/master/src/SpExModel.cpp#L463-L471">these lines</a> from SpExModel.cpp). In <a class="reference internal" href="#empirical1"><span class="std std-ref">this section</span></a>, we demonstrate that the empirical analyses from Moore et al are greatly compromised by their use of <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span> <span class="pre">=</span> <span class="pre">random</span></code>.</p>
</div>
<div class="section" id="several-theoretical-concerns-raised-by-mea-cannot-be-evaluated">
<span id="empirical1"></span><h2>12.3. Several theoretical concerns raised by MEA cannot be evaluated<a class="headerlink" href="#several-theoretical-concerns-raised-by-mea-cannot-be-evaluated" title="Permalink to this headline">¶</a></h2>
<p>MEA raise several important theoretical considerations concerning rate-shift models, which will be treated in a more comprehensive response. However, the MEA calculations that purport to demonstrate error in BAMM&#8217;s extinction probabilities (MEA Fig. 2) and likelihoods (MEA Fig. 3) are not valid, because their calculations are compromised by their <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span> <span class="pre">=</span> <span class="pre">random</span></code> setting. If the BAMM likelihood is incorrect, Fig. 2 and Fig. 3 are incapable of illustrating this, because results in those figures are based on compromised analyses that activated a known and documented implementation issue.</p>
</div>
<div class="section" id="reanalysis-of-empirical-data-from-moore-et-al-2016">
<h2>12.4. Reanalysis of empirical data from Moore et al (2016)<a class="headerlink" href="#reanalysis-of-empirical-data-from-moore-et-al-2016" title="Permalink to this headline">¶</a></h2>
<p>We obtained all input files as <a class="reference external" href="http://datadryad.org/resource/doi:10.5061/dryad.mb0sd">posted</a> to Dryad by MEA. Every control file used for their BAMM analyses terminates with the line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="n">random</span>
</pre></div>
</div>
<p>We used BAMM v2.5 to repeat all analyses with the control files from MEA exactly as published by the authors. We then performed a second set of analyses where we re-analyzed the same control files, but where we deleted the command <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span> <span class="pre">=</span> <span class="pre">random</span></code>, thus ensuring that the program used the correct (default) value (<code class="docutils literal"><span class="pre">if_different</span></code>).</p>
<p>One of the key results of MEA is their finding that the posterior is overly sensitive to the prior. For every dataset in their article, we find dramatic differences in the shape of the posterior distributions obtained with the incorrect <code class="docutils literal"><span class="pre">random</span></code> (MEA) and the correct <code class="docutils literal"><span class="pre">if_different</span></code> (BAMM default) value of <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code>. For example, here are the results for the cetacean dataset that is distributed as an example file with <code class="docutils literal"><span class="pre">BAMMtools</span></code>. Each plot shows the posterior distribution on the number of shifts for a given prior parameterization (<img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>; this is the same as the <code class="docutils literal"><span class="pre">expectedNumberOfShifts</span></code> parameter in BAMM). Each analysis was performed using MEA&#8217;s control files <strong>exactly as given</strong> in all respects but one: the top row is with the default value for <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code>, and the bottom row shows results using the MEA modification (<code class="docutils literal"><span class="pre">random</span></code>).</p>
<div class="figure align-center" id="cetaceans1">
<a class="reference internal image-reference" href="_images/rr_cetaceans.png"><img alt="_images/rr_cetaceans.png" src="_images/rr_cetaceans.png" style="width: 1100px;" /></a>
</div>
<p>Compare these results to MEA, Fig. S21. For unmodified BAMM, the posterior is well-behaved with respect to the prior. However, with the MEA modification, the posterior is highly sensitive to the prior. This is especially apparent for large values of <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/>. Here is another example dataset, <em>Adelpha</em>, corresponding to MEA Figure S19:</p>
<div class="figure align-center" id="adelpha1">
<a class="reference internal image-reference" href="_images/rr_adelpha.png"><img alt="_images/rr_adelpha.png" src="_images/rr_adelpha.png" style="width: 1100px;" /></a>
</div>
<p>Again, we see the same pattern as with the cetaceans: the posterior is poorly behaved with the MEA modification to the BAMM algorithm. These differences between the BAMM default behavior and the MEA modification can be extreme. Here is <em>Senna</em> (MEA fig S29), where the posterior is quite poorly behaved with the MEA modification but where there is virtually no sensitivity to the prior under the default value of <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code>:</p>
<div class="figure align-center" id="senna1">
<a class="reference internal image-reference" href="_images/rr_senna.png"><img alt="_images/rr_senna.png" src="_images/rr_senna.png" style="width: 1100px;" /></a>
</div>
<p>And here is another clade, the <em>Terebinthaceae</em> (MEA Figure S30):</p>
<div class="figure align-center" id="tere1">
<a class="reference internal image-reference" href="_images/rr_tere.png"><img alt="_images/rr_tere.png" src="_images/rr_tere.png" style="width: 1100px;" /></a>
</div>
<p>This gets a bit repetitive, so we present other empirical results in a separate <a class="reference internal" href="#empirical1"><span class="std std-ref">section</span></a> below. We turn now to MEA&#8217;s analysis of constant-rate trees, which was presented in the main text of their article (Figure 4).</p>
</div>
<div class="section" id="reanalysis-of-constant-rate-trees-from-moore-et-al-2016">
<span id="constant1"></span><h2>12.5. Reanalysis of constant-rate trees from Moore et al (2016)<a class="headerlink" href="#reanalysis-of-constant-rate-trees-from-moore-et-al-2016" title="Permalink to this headline">¶</a></h2>
<p>MEA simulated constant-rate phylogenies of the same size as the cetacean phylogeny (87 taxa) and found that the posterior was strikingly sensitive to the prior. Here is our reanalysis of their input files, which recreates the results they presented in Figure 4:</p>
<div class="figure align-center" id="cr-mea-mea1">
<a class="reference internal image-reference" href="_images/cr_mea_mea.png"><img alt="_images/cr_mea_mea.png" src="_images/cr_mea_mea.png" style="width: 1100px;" /></a>
</div>
<p>You can see in the figure above that the posterior is virtually identical to the prior for <img class="math" src="_images/math/3666981dc77862de77b6ecfcb64aad59b425cbaf.png" alt="\gamma"/> = 10. However, there are two important differences between the way MEA used BAMM and the way the program would typically be used. First, MEA set <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> to <code class="docutils literal"><span class="pre">random</span></code>, as discussed above. Second, for this particular analysis (but not their empirical analyses), MEA placed very strong priors on the rate parameters for speciation and extinction. The next figure considers the effects only of the MEA modification to <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code>. When we restore this setting to its default values, using the MEA control files, we see that the posterior is markedly less sensitive to the prior than reported in MEA Figure 4:</p>
<div class="figure align-center" id="cr-2-5-mea1">
<a class="reference internal image-reference" href="_images/cr_2.5_mea.png"><img alt="_images/cr_2.5_mea.png" src="_images/cr_2.5_mea.png" style="width: 1100px;" /></a>
</div>
<p>There is considerably <em>less</em> sensitivity, but there is still <em>some</em> sensitivity. This may or may not be of concern. However, we now consider the additional impact of the strong priors placed on the rate parameters by MEA. There are 3 rate priors in the BAMM model: the prior on the speciation rate (<code class="docutils literal"><span class="pre">lambdaInitPrior</span></code>), the prior on the extinction rate (<code class="docutils literal"><span class="pre">muInitPrior</span></code>), and the prior on the rate-shift parameter (<code class="docutils literal"><span class="pre">lambdaShiftPrior</span></code>). The first 2 priors are exponential, the rate shift prior is Gaussian. The function <code class="docutils literal"><span class="pre">setBAMMpriors</span></code> from <code class="docutils literal"><span class="pre">BAMMtools</span></code> matches the scale of these prior distributions to the scale of the tree, such that inferences on relative diversification rates across the tree are independent of tree scale (e.g., you can multiply the branch lengths by 0.001 or 1000 and get identical posterior distributions for <em>relative</em> rates, if you use <code class="docutils literal"><span class="pre">setBAMMpriors</span></code>). Most researchers either use the default rate priors in BAMM or they use the BAMMtools recommendation (from <code class="docutils literal"><span class="pre">setBAMMpriors</span></code>). However, the priors used by MEA on constant-rate trees are much more restrictive than the more liberal priors we recommend. Here is a set of pairwise plots for the recommended versus MEA priors for the 3 rate parameters in BAMM, for their set of 100 constant rate (87 taxon) phylogenies:</p>
<div class="figure align-center" id="ratepriors1">
<a class="reference internal image-reference" href="_images/rate_priors.png"><img alt="_images/rate_priors.png" src="_images/rate_priors.png" style="width: 900px;" /></a>
</div>
<p>We acknowledge that there are outstanding issues to be addressed with respect to the sensitivity of BAMM inferences to the underlying priors on speciation and extinction rates. However, the figure above makes clear that all prior values used by MEA are significantly mismatched relative to the recommended values. For <code class="docutils literal"><span class="pre">lambdaInitPrior</span></code> and <code class="docutils literal"><span class="pre">muInitPrior</span></code>, the MEA values impose much stronger constraints on the rates (e.g., greater rate parameter of the exponential distribution, as plotted above). The plot above does not adequately convey the range of values for <code class="docutils literal"><span class="pre">muInitPrior</span></code>, some of which exceeded 200 (max = 1098) and were not plotted. Moreover, MEA did not attempt to scale the <code class="docutils literal"><span class="pre">lambdaShiftPrior</span></code> and simply used a fixed value of 0.05, despite the dramatic differences in values used for the other priors.</p>
<p>Here is a re-analysis of the constant-rate phylogenies using <code class="docutils literal"><span class="pre">BAMMtools</span></code> recommended values for each dataset (which is how most researchers would use BAMM):</p>
<div class="figure align-center" id="cr-2-5-bammtools">
<a class="reference internal image-reference" href="_images/cr_2.5_bammtools.png"><img alt="_images/cr_2.5_bammtools.png" src="_images/cr_2.5_bammtools.png" style="width: 1100px;" /></a>
</div>
<p>We now see that there is even less sensitivity of the posterior to the prior, when using the default setting for <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> and with the recommended priors from <code class="docutils literal"><span class="pre">BAMMtools::setBAMMpriors</span></code>.</p>
<p>As a final analysis, we considered the results that would be obtained if a researcher simply used off-the-shelf BAMM v2.5 with the default prior settings in the program (e.g., without using <code class="docutils literal"><span class="pre">setBAMMpriors</span></code>):</p>
<div class="figure align-center" id="cr-2-5-defaults">
<a class="reference internal image-reference" href="_images/cr_2.5_defaults.png"><img alt="_images/cr_2.5_defaults.png" src="_images/cr_2.5_defaults.png" style="width: 1100px;" /></a>
</div>
<p>Again, the posterior is not particularly sensitive to the prior when the defaults are used. Thus, claims that BAMM v2.5 is overly sensitive to the prior on the number of rate shifts appears untenable for constant-rate phylogenies.</p>
</div>
<div class="section" id="all-empirical-datasets-from-moore-et-al-reanalyzed">
<span id="allempirical1"></span><h2>12.6. All empirical datasets from Moore et al, reanalyzed<a class="headerlink" href="#all-empirical-datasets-from-moore-et-al-reanalyzed" title="Permalink to this headline">¶</a></h2>
<p>Reanalysis of the remaining empirical datasets from MEA, as above. The only modification made to MEA&#8217;s control files was to delete their <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> argument (top row); bottom row shows results from analyzing their control file exactly as published. Here is the <em>Byttneria</em> (MEA Figure S20):</p>
<div class="figure align-center" id="byt1">
<a class="reference internal image-reference" href="_images/rr_byt.png"><img alt="_images/rr_byt.png" src="_images/rr_byt.png" style="width: 1100px;" /></a>
</div>
<p>And here is the <em>Ericaceae</em> (see MEA Fig S22):</p>
<div class="figure align-center" id="ericaceae1">
<a class="reference internal image-reference" href="_images/rr_ericaceae.png"><img alt="_images/rr_ericaceae.png" src="_images/rr_ericaceae.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Graphidaceae</em> (MEA Fig S23):</p>
<div class="figure align-center" id="graphid1">
<a class="reference internal image-reference" href="_images/rr_graphid.png"><img alt="_images/rr_graphid.png" src="_images/rr_graphid.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Paphiopedelum</em> (MEA Fig S25):</p>
<div class="figure align-center" id="paphio1">
<a class="reference internal image-reference" href="_images/rr_paphio.png"><img alt="_images/rr_paphio.png" src="_images/rr_paphio.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Parmeliaceae</em> (MEA Fig S26):</p>
<div class="figure align-center" id="parm1">
<a class="reference internal image-reference" href="_images/rr_parm.png"><img alt="_images/rr_parm.png" src="_images/rr_parm.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Pleopeltis</em> (MEA Fig S27):</p>
<div class="figure align-center" id="pleo1">
<a class="reference internal image-reference" href="_images/rr_pleo.png"><img alt="_images/rr_pleo.png" src="_images/rr_pleo.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Polygoneae</em> (MEA Fig S28):</p>
<div class="figure align-center" id="poly1">
<a class="reference internal image-reference" href="_images/rr_poly.png"><img alt="_images/rr_poly.png" src="_images/rr_poly.png" style="width: 1100px;" /></a>
</div>
<p>Here is the <em>Turnera</em> (MEA Fig S31):</p>
<div class="figure align-center" id="turn1">
<a class="reference internal image-reference" href="_images/rr_turn.png"><img alt="_images/rr_turn.png" src="_images/rr_turn.png" style="width: 1100px;" /></a>
</div>
<p>And the <em>Viburnum</em> (MEA Fig S32):</p>
<div class="figure align-center" id="viburnum1">
<a class="reference internal image-reference" href="_images/rr_viburnum.png"><img alt="_images/rr_viburnum.png" src="_images/rr_viburnum.png" style="width: 1100px;" /></a>
</div>
</div>
<div class="section" id="appendix-the-random-option-used-by-moore-et-al-is-not-valid">
<span id="combineextinctionrandom1"></span><h2>12.7. Appendix: The &#8220;random&#8221; option used by Moore et al is not valid<a class="headerlink" href="#appendix-the-random-option-used-by-moore-et-al-is-not-valid" title="Permalink to this headline">¶</a></h2>
<p>Moore et al (2016) changed a hidden developer setting in BAMM v2.5 for all analyses performed in their paper. Specifically, they changed the default value of the parameter <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> to the value <code class="docutils literal"><span class="pre">random</span></code>. This option is related to the implementation concern raised by Hoehna&#8217;s GitHub post, but does not exactly re-create it. To recreate the precise flow of extinction calculations as used in earlier (pre v2.5) versions of BAMM, you would set:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">combineExtinctionAtNodes</span> <span class="o">=</span> <span class="n">left</span>
</pre></div>
</div>
<p>The reasons for the current default value of <code class="docutils literal"><span class="pre">if_different</span></code> are explained in detail in this <a class="reference external" href="http://bamm-project.org/likelihoodmodel.html#extinction-calculations-at-nodes">subsection</a>, although there is no documentation of <em>random</em> in any previous BAMM documentation. The <code class="docutils literal"><span class="pre">random</span></code> option is related to <code class="docutils literal"><span class="pre">left</span></code>, but is even more arbitrary. Unfortunately, the option has the effect of destabilizing likelihood calculations with BAMM, because it stochastically assigns inheritance of extinction probabilities at internal nodes to favor the right or left descendant node. Hence, the likelihood calculations with <code class="docutils literal"><span class="pre">random</span></code> depend not only on arbitrary node rotations, but will be assigned randomly each time a tree is loaded into BAMM.</p>
<p>This means that likelihoods computed for the same dataset, with the same parameters, <strong>are not guaranteed to be identical</strong>. In fact, if there are any rate shifts on the tree, it is likely that <em>independent calculations of the likelihood with the same parameters will yield different values</em>. As a simple example, we will use the <code class="docutils literal"><span class="pre">random</span></code> option to compute the likelihood a set of parameters from the posterior distribution of rate regimes simulated for the whale dataset distributed with <code class="docutils literal"><span class="pre">BAMMtools</span></code>.</p>
<p><code class="docutils literal"><span class="pre">BAMMtools</span></code> includes a simple likelihood calculator that allows us to compute tree likelihoods under the <code class="docutils literal"><span class="pre">random</span></code> option, although this option <em>is not documented anywhere</em>; the default, as for BAMM, is <code class="docutils literal"><span class="pre">if_different</span></code>. The argument for this option in <code class="docutils literal"><span class="pre">BAMMtools::BAMMlikelihood</span></code> is <code class="docutils literal"><span class="pre">e_prob_condition</span></code> (this is identical to <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span></code> in BAMM). Here, we will pull out the last 50 generations from the posterior sampled with BAMM; for each generation, we will compute the likelihood twice. Now, the parameters sampled for a particular generation are constant: hence, <strong>all calculations of the likelihood with those values must be identical</strong>, or the method is not mathematically coherent.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>library(BAMMtools)
data(whales, events.whales)
ux &lt;- unique(events.whales$generation)[1951:2000]
ll &lt;- matrix(NA, nrow=50, ncol=2)
for (i in 1:50){
        cat(i, &quot;\n&quot;)
        ll[i,1] &lt;- BAMMlikelihood(whales, events.whales, gen= ux[i], e_prob_condition = &quot;random&quot;)
        ll[i,2] &lt;- BAMMlikelihood(whales, events.whales, gen= ux[i], e_prob_condition = &quot;random&quot;)

}
</pre></div>
</div>
<p>We now have a 2 column matrix, <code class="docutils literal"><span class="pre">ll</span></code>, where the right and left columns correspond to independent calculations of the likelihood with the same parameter sets. We will now plot <code class="docutils literal"><span class="pre">ll[</span> <span class="pre">,1]</span></code> against <code class="docutils literal"><span class="pre">ll[</span> <span class="pre">,2]</span></code>:</p>
<div class="figure align-center" id="randomcompare">
<a class="reference internal image-reference" href="_images/randomCompare.png"><img alt="_images/randomCompare.png" src="_images/randomCompare.png" style="width: 400px;" /></a>
</div>
<p>The likelihoods from successive computations are not identical. They are correlated, but they <em>should be identical</em>, as the parameters and tree are identical. Hence, <code class="docutils literal"><span class="pre">random</span></code> is perhaps the worst of several suboptimal settings that should not be used.</p>
<p>Just to demonstrate that <code class="docutils literal"><span class="pre">if_different</span></code> does not show this pathology, here will we repeat this exercise but using <code class="docutils literal"><span class="pre">combineExtinctionAtNodes</span> <span class="pre">=</span> <span class="pre">if_different</span></code> (recall that this parameter in BAMMtools has the label <code class="docutils literal"><span class="pre">e_prob_condition</span></code>)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>library(BAMMtools)
data(whales, events.whales)
ux &lt;- unique(events.whales$generation)[1951:2000]
ll &lt;- matrix(NA, nrow=50, ncol=2)
for (i in 1:50){
        cat(i, &quot;\n&quot;)
        ll[i,1] &lt;- BAMMlikelihood(whales, events.whales, gen= ux[i], e_prob_condition = &quot;if_different&quot;)
        ll[i,2] &lt;- BAMMlikelihood(whales, events.whales, gen= ux[i], e_prob_condition = &quot;if_different&quot;)

}
</pre></div>
</div>
<p>And, as <em>should</em> be the case for any mathematically consistent method, the likelihoods are identical:</p>
<div class="figure align-center" id="ifdiff">
<a class="reference internal image-reference" href="_images/if_differentCompare.png"><img alt="_images/if_differentCompare.png" src="_images/if_differentCompare.png" style="width: 400px;" /></a>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="likelihoodmodel.html" title="13. The BAMM likelihood function"
             >next</a></li>
        <li class="right" >
          <a href="prior.html" title="11. Is the posterior on the number of shifts overly sensitive to the prior?"
             >previous</a> |</li>
<li><a href="index.html">Home</a>&nbsp;|</li>
<li><a href="download.html">Download</a>&nbsp;|</li>
<li><a href="documentation.html">Documentation</a>&nbsp;|</li>
<li><a href="contact_us.html">Contact Us</a></li>
 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 BAMM Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-49579863-1', 'bamm-project.org');
ga('send', 'pageview');
</script>

  </body>
</html>